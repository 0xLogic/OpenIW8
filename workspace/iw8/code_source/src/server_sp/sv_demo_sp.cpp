/*
==============
SV_DemoSP_RecordCorpseOrigins
==============
*/

void SV_DemoSP_RecordCorpseOrigins(void)
{
  ?SV_DemoSP_RecordCorpseOrigins@@YAXXZ();
}

/*
==============
SV_DemoSP_GetPreloadZonesState
==============
*/

bool __fastcall SV_DemoSP_GetPreloadZonesState()
{
  return ?SV_DemoSP_GetPreloadZonesState@@YA_NXZ();
}

/*
==============
SV_DemoSP_GetLoadIntelligence
==============
*/

void __fastcall SV_DemoSP_GetLoadIntelligence(MemoryFile *memFile)
{
  ?SV_DemoSP_GetLoadIntelligence@@YAXPEAUMemoryFile@@@Z(memFile);
}

/*
==============
SV_DemoSP_RecordButtonPressed
==============
*/

void __fastcall SV_DemoSP_RecordButtonPressed(int buttonPressed)
{
  ?SV_DemoSP_RecordButtonPressed@@YAXH@Z(buttonPressed);
}

/*
==============
SV_DemoSP_RecordFxVisibility
==============
*/

void __fastcall SV_DemoSP_RecordFxVisibility(float visibility)
{
  ?SV_DemoSP_RecordFxVisibility@@YAXM@Z(visibility);
}

/*
==============
SvDemoSP::SaveHistory
==============
*/

void __fastcall SvDemoSP::SaveHistory(SvDemoSP *this)
{
  ?SaveHistory@SvDemoSP@@UEAAXXZ(this);
}

/*
==============
SV_DemoSP_SetMsecTime
==============
*/

void __fastcall SV_DemoSP_SetMsecTime(int time)
{
  ?SV_DemoSP_SetMsecTime@@YAXH@Z(time);
}

/*
==============
SvDemoSP::RecordInt
==============
*/

void __fastcall SvDemoSP::RecordInt(SvDemoSP *this, int value)
{
  ?RecordInt@SvDemoSP@@UEAAXH@Z(this, value);
}

/*
==============
SV_DemoSP_InitSavegame
==============
*/

void __fastcall SV_DemoSP_InitSavegame(SaveGame **save)
{
  ?SV_DemoSP_InitSavegame@@YAXPEAPEAUSaveGame@@@Z(save);
}

/*
==============
SV_DemoSP_Back_f
==============
*/

void SV_DemoSP_Back_f(void)
{
  ?SV_DemoSP_Back_f@@YAXXZ();
}

/*
==============
SV_DemoSP_CinematicGetTimeInMsec
==============
*/

int __fastcall SV_DemoSP_CinematicGetTimeInMsec()
{
  return ?SV_DemoSP_CinematicGetTimeInMsec@@YAHXZ();
}

/*
==============
SvDemoSP::GetFloat
==============
*/

double __fastcall SvDemoSP::GetFloat(SvDemoSP *this)
{
  double result; 

  *(float *)&result = ?GetFloat@SvDemoSP@@UEAAMXZ(this);
  return result;
}

/*
==============
SvDemoSP::GetShort
==============
*/

__int16 __fastcall SvDemoSP::GetShort(SvDemoSP *this)
{
  return ?GetShort@SvDemoSP@@UEAAFXZ(this);
}

/*
==============
SV_DemoSP_RecordIntelligence
==============
*/

void __fastcall SV_DemoSP_RecordIntelligence(int controllerIndex, int *cheat_items_set1, int *cheat_items_set2)
{
  ?SV_DemoSP_RecordIntelligence@@YAXHPEAH0@Z(controllerIndex, cheat_items_set1, cheat_items_set2);
}

/*
==============
SV_DemoSP_RecordIsCinematicLoaded
==============
*/

void __fastcall SV_DemoSP_RecordIsCinematicLoaded(bool isCinematicLoaded)
{
  ?SV_DemoSP_RecordIsCinematicLoaded@@YAX_N@Z(isCinematicLoaded);
}

/*
==============
SV_DemoSP_RecordCinematicGetTimeInMsec
==============
*/

void __fastcall SV_DemoSP_RecordCinematicGetTimeInMsec(int timeMsec)
{
  ?SV_DemoSP_RecordCinematicGetTimeInMsec@@YAXH@Z(timeMsec);
}

/*
==============
SV_DemoSP_RecordTimeSincePaused
==============
*/

void __fastcall SV_DemoSP_RecordTimeSincePaused(int timeSincePaused)
{
  ?SV_DemoSP_RecordTimeSincePaused@@YAXH@Z(timeSincePaused);
}

/*
==============
SV_DemoSP_RecordClientThink
==============
*/

void __fastcall SV_DemoSP_RecordClientThink(int clientNum, usercmd_s *cmd)
{
  ?SV_DemoSP_RecordClientThink@@YAXHPEAUusercmd_s@@@Z(clientNum, cmd);
}

/*
==============
SV_DemoSP_Live_f
==============
*/

void SV_DemoSP_Live_f(void)
{
  ?SV_DemoSP_Live_f@@YAXXZ();
}

/*
==============
SvDemoSP::RecordString
==============
*/

void __fastcall SvDemoSP::RecordString(SvDemoSP *this, const char *buffer)
{
  ?RecordString@SvDemoSP@@UEAAXPEBD@Z(this, buffer);
}

/*
==============
SV_DemoSP_RecordSaveCommitWouldBeValid
==============
*/

void __fastcall SV_DemoSP_RecordSaveCommitWouldBeValid(bool saveCommitWouldBeValid)
{
  ?SV_DemoSP_RecordSaveCommitWouldBeValid@@YAX_N@Z(saveCommitWouldBeValid);
}

/*
==============
SV_DemoSP_GetTransientState
==============
*/

int __fastcall SV_DemoSP_GetTransientState()
{
  return ?SV_DemoSP_GetTransientState@@YAHXZ();
}

/*
==============
SV_DemoSP_DoAutoSaveHistory
==============
*/

void SV_DemoSP_DoAutoSaveHistory(void)
{
  ?SV_DemoSP_DoAutoSaveHistory@@YAXXZ();
}

/*
==============
SvDemoSP::SaveImmediate
==============
*/

void __fastcall SvDemoSP::SaveImmediate(SvDemoSP *this, SaveImmediate *save)
{
  ?SaveImmediate@SvDemoSP@@UEAAXPEAU0@@Z(this, save);
}

/*
==============
SV_DemoSP_RecordIsCinematicPlaying
==============
*/

void __fastcall SV_DemoSP_RecordIsCinematicPlaying(bool isCinematicPlaying)
{
  ?SV_DemoSP_RecordIsCinematicPlaying@@YAX_N@Z(isCinematicPlaying);
}

/*
==============
SV_DemoSP_LoadDemo
==============
*/

void __fastcall SV_DemoSP_LoadDemo(const SaveHeader *header, MemoryFile *memFile, MemCardFileHandle fileHandle)
{
  ?SV_DemoSP_LoadDemo@@YAXPEBUSaveHeader@@PEAUMemoryFile@@UMemCardFileHandle@@@Z(header, memFile, fileHandle);
}

/*
==============
SV_DemoSP_UpdateDemo
==============
*/

void SV_DemoSP_UpdateDemo(void)
{
  ?SV_DemoSP_UpdateDemo@@YAXXZ();
}

/*
==============
SV_DemoSP_GetIsCinematicLoaded
==============
*/

bool __fastcall SV_DemoSP_GetIsCinematicLoaded()
{
  return ?SV_DemoSP_GetIsCinematicLoaded@@YA_NXZ();
}

/*
==============
SvDemoSP::GetByte
==============
*/

unsigned __int8 __fastcall SvDemoSP::GetByte(SvDemoSP *this)
{
  return ?GetByte@SvDemoSP@@UEAAEXZ(this);
}

/*
==============
SV_DemoSP_GetIsRecentlyLoaded
==============
*/

bool __fastcall SV_DemoSP_GetIsRecentlyLoaded()
{
  return ?SV_DemoSP_GetIsRecentlyLoaded@@YA_NXZ();
}

/*
==============
SV_DemoSP_HasMark
==============
*/

bool __fastcall SV_DemoSP_HasMark()
{
  return ?SV_DemoSP_HasMark@@YA_NXZ();
}

/*
==============
SvDemoSP::RecordFloat
==============
*/

void __fastcall SvDemoSP::RecordFloat(SvDemoSP *this, float value)
{
  ?RecordFloat@SvDemoSP@@UEAAXM@Z(this, value);
}

/*
==============
SV_DemoSP_Restart_f
==============
*/

void SV_DemoSP_Restart_f(void)
{
  ?SV_DemoSP_Restart_f@@YAXXZ();
}

/*
==============
SV_DemoSP_Init
==============
*/

void __fastcall SV_DemoSP_Init(unsigned int *randomSeed)
{
  ?SV_DemoSP_Init@@YAXPEAI@Z(randomSeed);
}

/*
==============
SvDemoSP::GetCheatsOk
==============
*/

int __fastcall SvDemoSP::GetCheatsOk(SvDemoSP *this)
{
  return ?GetCheatsOk@SvDemoSP@@UEAAHXZ(this);
}

/*
==============
SvDemoSP::GetInt64
==============
*/

__int64 __fastcall SvDemoSP::GetInt64(SvDemoSP *this)
{
  return ?GetInt64@SvDemoSP@@UEAA_JXZ(this);
}

/*
==============
SV_DemoSP_ShutdownSystem
==============
*/

void SV_DemoSP_ShutdownSystem(void)
{
  ?SV_DemoSP_ShutdownSystem@@YAXXZ();
}

/*
==============
SV_DemoSP_Goto_f
==============
*/

void SV_DemoSP_Goto_f(void)
{
  ?SV_DemoSP_Goto_f@@YAXXZ();
}

/*
==============
SV_DemoSP_Info_f
==============
*/

void SV_DemoSP_Info_f(void)
{
  ?SV_DemoSP_Info_f@@YAXXZ();
}

/*
==============
SvDemoSP::GetServerDemoMessageSize
==============
*/

unsigned int __fastcall SvDemoSP::GetServerDemoMessageSize()
{
  return ?GetServerDemoMessageSize@SvDemoSP@@SAIXZ();
}

/*
==============
SV_DemoSP_Forward_f
==============
*/

void SV_DemoSP_Forward_f(void)
{
  ?SV_DemoSP_Forward_f@@YAXXZ();
}

/*
==============
SV_DemoSP_GetSaveCommitWouldBeValid
==============
*/

bool __fastcall SV_DemoSP_GetSaveCommitWouldBeValid()
{
  return ?SV_DemoSP_GetSaveCommitWouldBeValid@@YA_NXZ();
}

/*
==============
SV_DemoSP_IsInReadTransientStateSync
==============
*/

bool __fastcall SV_DemoSP_IsInReadTransientStateSync()
{
  return ?SV_DemoSP_IsInReadTransientStateSync@@YA_NXZ();
}

/*
==============
SV_DemoSP_RecordTransientState
==============
*/

void __fastcall SV_DemoSP_RecordTransientState(int syncType)
{
  ?SV_DemoSP_RecordTransientState@@YAXH@Z(syncType);
}

/*
==============
SV_DemoSP_GetFxVisibility
==============
*/

double __fastcall SV_DemoSP_GetFxVisibility()
{
  double result; 

  *(float *)&result = ?SV_DemoSP_GetFxVisibility@@YAMXZ();
  return result;
}

/*
==============
SvDemoSP::AutoSave
==============
*/

void __fastcall SvDemoSP::AutoSave(SvDemoSP *this, AutoSaveType autosaveType, const char *description, int demoCount, bool force)
{
  ?AutoSave@SvDemoSP@@UEAAXW4AutoSaveType@@PEBDH_N@Z(this, autosaveType, description, demoCount, force);
}

/*
==============
SvDemoSP::GetString
==============
*/

const char *__fastcall SvDemoSP::GetString(SvDemoSP *this)
{
  return ?GetString@SvDemoSP@@UEAAPEBDXZ(this);
}

/*
==============
SV_DemoSP_RecordClientCommand
==============
*/

void __fastcall SV_DemoSP_RecordClientCommand(int clientNum, const char *s)
{
  ?SV_DemoSP_RecordClientCommand@@YAXHPEBD@Z(clientNum, s);
}

/*
==============
SV_DemoSP_ReadDvarPacket
==============
*/

void __fastcall SV_DemoSP_ReadDvarPacket(int framePos)
{
  ?SV_DemoSP_ReadDvarPacket@@YAXH@Z(framePos);
}

/*
==============
SV_DemoSP_ReadPacket
==============
*/

void __fastcall SV_DemoSP_ReadPacket(int framePos)
{
  ?SV_DemoSP_ReadPacket@@YAXH@Z(framePos);
}

/*
==============
SV_DemoSP_CinematicGetFrame
==============
*/

int __fastcall SV_DemoSP_CinematicGetFrame()
{
  return ?SV_DemoSP_CinematicGetFrame@@YAHXZ();
}

/*
==============
SvDemoSP::RecordInt64
==============
*/

void __fastcall SvDemoSP::RecordInt64(SvDemoSP *this, __int64 value)
{
  ?RecordInt64@SvDemoSP@@UEAAX_J@Z(this, value);
}

/*
==============
SvDemoSP::InitServerDemoMessageMem
==============
*/

void __fastcall SvDemoSP::InitServerDemoMessageMem(SvDemoSP *this, unsigned __int8 *mem, unsigned __int64 size)
{
  ?InitServerDemoMessageMem@SvDemoSP@@UEAAXPEAE_K@Z(this, mem, size);
}

/*
==============
SV_DemoSP_RecordPreloadZonesState
==============
*/

void __fastcall SV_DemoSP_RecordPreloadZonesState(bool loadComplete)
{
  ?SV_DemoSP_RecordPreloadZonesState@@YAX_N@Z(loadComplete);
}

/*
==============
SvDemoSP::GetInt
==============
*/

int __fastcall SvDemoSP::GetInt(SvDemoSP *this)
{
  return ?GetInt@SvDemoSP@@UEAAHXZ(this);
}

/*
==============
SV_DemoSP_GetTimeSincePaused
==============
*/

int __fastcall SV_DemoSP_GetTimeSincePaused()
{
  return ?SV_DemoSP_GetTimeSincePaused@@YAHXZ();
}

/*
==============
SV_DemoSP_AutoSaveEndDemo
==============
*/

void SV_DemoSP_AutoSaveEndDemo(void)
{
  ?SV_DemoSP_AutoSaveEndDemo@@YAXXZ();
}

/*
==============
SV_DemoSP_RecordCinematicGetFrame
==============
*/

void __fastcall SV_DemoSP_RecordCinematicGetFrame(int frame)
{
  ?SV_DemoSP_RecordCinematicGetFrame@@YAXH@Z(frame);
}

/*
==============
SV_DemoSP_Mark_f
==============
*/

void SV_DemoSP_Mark_f(void)
{
  ?SV_DemoSP_Mark_f@@YAXXZ();
}

/*
==============
SvDemoSP::RecordByte
==============
*/

void __fastcall SvDemoSP::RecordByte(SvDemoSP *this, unsigned __int8 value)
{
  ?RecordByte@SvDemoSP@@UEAAXE@Z(this, value);
}

/*
==============
SV_DemoSP_Save_f
==============
*/

void SV_DemoSP_Save_f(void)
{
  ?SV_DemoSP_Save_f@@YAXXZ();
}

/*
==============
SvDemoSP::DvarSet
==============
*/

bool __fastcall SvDemoSP::DvarSet(SvDemoSP *this, unsigned int var_checksum, const char *value)
{
  return ?DvarSet@SvDemoSP@@UEAA_NIPEBD@Z(this, var_checksum, value);
}

/*
==============
SV_DemoSP_GetIsCinematicPlaying
==============
*/

bool __fastcall SV_DemoSP_GetIsCinematicPlaying()
{
  return ?SV_DemoSP_GetIsCinematicPlaying@@YA_NXZ();
}

/*
==============
SV_DemoSP_SetMsecTime_f
==============
*/

void SV_DemoSP_SetMsecTime_f(void)
{
  ?SV_DemoSP_SetMsecTime_f@@YAXXZ();
}

/*
==============
SV_DemoSP_GetButtonPressed
==============
*/

int __fastcall SV_DemoSP_GetButtonPressed()
{
  return ?SV_DemoSP_GetButtonPressed@@YAHXZ();
}

/*
==============
SV_DemoSP_FullForward_f
==============
*/

void SV_DemoSP_FullForward_f(void)
{
  ?SV_DemoSP_FullForward_f@@YAXXZ();
}

/*
==============
SV_DemoSP_GetCorpseOrigins
==============
*/

void SV_DemoSP_GetCorpseOrigins(void)
{
  ?SV_DemoSP_GetCorpseOrigins@@YAXXZ();
}

/*
==============
SV_DemoSP_InitSystem
==============
*/

void SV_DemoSP_InitSystem(void)
{
  ?SV_DemoSP_InitSystem@@YAXXZ();
}

/*
==============
SV_DemoSP_RecordIsRecentlyLoaded
==============
*/

void __fastcall SV_DemoSP_RecordIsRecentlyLoaded(bool isRecentlyLoaded)
{
  ?SV_DemoSP_RecordIsRecentlyLoaded@@YAX_N@Z(isRecentlyLoaded);
}

/*
==============
SV_DemoSP_UsingDemoSave
==============
*/

bool __fastcall SV_DemoSP_UsingDemoSave()
{
  return ?SV_DemoSP_UsingDemoSave@@YA_NXZ();
}

/*
==============
SvDemoSP::RecordCheatsOk
==============
*/

void __fastcall SvDemoSP::RecordCheatsOk(SvDemoSP *this, int cheatsOk)
{
  ?RecordCheatsOk@SvDemoSP@@UEAAXH@Z(this, cheatsOk);
}

/*
==============
SV_DemoSP_CheckAutoSaveHistory
==============
*/

int __fastcall SV_DemoSP_CheckAutoSaveHistory()
{
  return ?SV_DemoSP_CheckAutoSaveHistory@@YAHXZ();
}

/*
==============
SvDemoSP::RecordShort
==============
*/

void __fastcall SvDemoSP::RecordShort(SvDemoSP *this, __int16 value)
{
  ?RecordShort@SvDemoSP@@UEAAXF@Z(this, value);
}

/*
==============
SV_DemoSP_Shutdown
==============
*/

void SV_DemoSP_Shutdown(void)
{
  ?SV_DemoSP_Shutdown@@YAXXZ();
}

/*
==============
SvDemoSP::AutoSave
==============
*/
void SvDemoSP::AutoSave(SvDemoSP *this, AutoSaveType autosaveType, const char *description, int demoCount, bool force)
{
  const dvar_t *v5; 
  __int64 v7; 
  int v9; 
  __int64 v10; 
  char testDemoName[64]; 
  char dest[256]; 

  v5 = DVARBOOL_replay_autosaveOnError;
  v7 = (unsigned int)autosaveType;
  if ( DVARBOOL_replay_autosaveOnError )
  {
    Dvar_CheckFrontendServerThread(DVARBOOL_replay_autosaveOnError);
    if ( v5->current.enabled && sv_demo.msg.data && (force || sv_demo.changed) )
    {
      SV_DemoSP_GetFreeDemoName(s_autoSaveBaseNamesSP[v7], demoCount, testDemoName);
      if ( Sys_IsMainThread() && !force )
        SV_WaitServer();
      Core_strcpy_truncate(dest, 0x100ui64, description);
      v9 = g_serverThreadOwnership;
      if ( !g_serverThreadOwnership )
      {
        if ( ((unsigned __int8)&g_serverThreadOwnership & 3) != 0 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\qcommon\\threads_interlock_pc.h", g_serverThreadOwnership + 37, ASSERT_TYPE_ASSERT, "( ( IsAligned( addend, sizeof( volatile_int32 ) ) ) )", "( addend ) = %p", &g_serverThreadOwnership) )
          __debugbreak();
        if ( _InterlockedIncrement(&g_serverThreadOwnership) != 1 )
        {
          LODWORD(v10) = g_serverThreadOwnership;
          if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2457, ASSERT_TYPE_ASSERT, "( ( Sys_InterlockedIncrement( (volatile_int32 *)&g_serverThreadOwnership ) == 1 ) )", "( g_serverThreadOwnership ) = %i", v10) )
            __debugbreak();
        }
      }
      SV_DemoSP_SaveDemo(testDemoName, dest, SAVE_TYPE_INTERNAL);
      if ( !v9 )
      {
        if ( ((unsigned __int8)&g_serverThreadOwnership & 3) != 0 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\qcommon\\threads_interlock_pc.h", 44, ASSERT_TYPE_ASSERT, "( ( IsAligned( addend, sizeof( volatile_int32 ) ) ) )", "( addend ) = %p", &g_serverThreadOwnership) )
          __debugbreak();
        if ( _InterlockedExchangeAdd(&g_serverThreadOwnership, 0xFFFFFFFF) != 1 )
        {
          LODWORD(v10) = g_serverThreadOwnership;
          if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2464, ASSERT_TYPE_ASSERT, "( ( Sys_InterlockedDecrement( (volatile_int32 *)&g_serverThreadOwnership ) == 0 ) )", "( g_serverThreadOwnership ) = %i", v10) )
            __debugbreak();
        }
      }
    }
  }
}

/*
==============
SvDemoSP::DvarSet
==============
*/
char SvDemoSP::DvarSet(SvDemoSP *this, unsigned int var_checksum, const char *value)
{
  int FramePos; 

  if ( !Sys_IsMainThread() && !Sys_IsServerThread() && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2577, ASSERT_TYPE_ASSERT, "( Sys_IsMainThread() || Sys_IsServerThread() )", (const char *)&queryFormat, "Sys_IsMainThread() || Sys_IsServerThread()") )
    __debugbreak();
  if ( SV_IsDemoPlaying() && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2581, ASSERT_TYPE_ASSERT, "( !SV_IsDemoPlaying() )", (const char *)&queryFormat, "!SV_IsDemoPlaying()") )
    __debugbreak();
  if ( !SV_Demo_IsRecording() && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2582, ASSERT_TYPE_ASSERT, "( SV_Demo_IsRecording() )", (const char *)&queryFormat, "SV_Demo_IsRecording()") )
    __debugbreak();
  if ( Sys_IsMainThread() )
    SV_WaitServer();
  SV_DemoSP_CheckSize();
  MSG_WriteByte(&sv_demo.msg, 10i64);
  FramePos = G_MainSP_GetFramePos();
  MSG_WriteLong(&sv_demo.msg, FramePos);
  MSG_WriteLong(&sv_demo.msg, var_checksum);
  MSG_WriteString(&sv_demo.msg, value);
  return 1;
}

/*
==============
SvDemoSP::GetByte
==============
*/
char SvDemoSP::GetByte(SvDemoSP *this)
{
  const char *v1; 
  const char *v2; 
  char Byte; 

  if ( !sv_demo.playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2085, ASSERT_TYPE_ASSERT, "(sv_demo.playing)", (const char *)&queryFormat, "sv_demo.playing") )
    __debugbreak();
  if ( sv_demo.readType == 4 )
  {
    Byte = MSG_ReadByte(&sv_demo.msg);
    SV_DemoSP_ReadNextDemoType();
    return Byte;
  }
  else
  {
    if ( sv_demo.readType > 0x19u )
      v1 = j_va("invalid:%i", sv_demo.readType);
    else
      v1 = s_svdDemoTypeNames[sv_demo.readType];
    v2 = j_va("SV_Demo_GetByte(): Invalid sv_demo.readType: '%s'", v1);
    SV_DemoSP_EndDemo(v2);
    return 0;
  }
}

/*
==============
SvDemoSP::GetCheatsOk
==============
*/
__int64 SvDemoSP::GetCheatsOk(SvDemoSP *this)
{
  const char *v1; 
  const char *v2; 
  unsigned int Long; 

  if ( !sv_demo.playing )
    return 0i64;
  if ( sv_demo.readType != 11 )
  {
    if ( sv_demo.readType > 0x19u )
      v1 = j_va("invalid:%i", sv_demo.readType);
    else
      v1 = s_svdDemoTypeNames[sv_demo.readType];
    v2 = j_va("SV_DemoSP_CheatsOk(): Invalid sv_demo.readType: '%s'", v1);
    SV_DemoSP_EndDemo(v2);
    return 0i64;
  }
  Long = MSG_ReadLong(&sv_demo.msg);
  SV_DemoSP_ReadNextDemoType();
  return Long;
}

/*
==============
SvDemoSP::GetFloat
==============
*/
float SvDemoSP::GetFloat(SvDemoSP *this)
{
  const char *v1; 
  const char *v2; 
  double Float; 

  if ( !sv_demo.playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2220, ASSERT_TYPE_ASSERT, "(sv_demo.playing)", (const char *)&queryFormat, "sv_demo.playing") )
    __debugbreak();
  if ( sv_demo.readType == 7 )
  {
    Float = MSG_ReadFloat(&sv_demo.msg);
    SV_DemoSP_ReadNextDemoType();
  }
  else
  {
    if ( sv_demo.readType > 0x19u )
      v1 = j_va("invalid:%i", sv_demo.readType);
    else
      v1 = s_svdDemoTypeNames[sv_demo.readType];
    v2 = j_va("SV_Demo_GetFloat(): Invalid sv_demo.readType: '%s'", v1);
    SV_DemoSP_EndDemo(v2);
    LODWORD(Float) = 0;
  }
  return *(float *)&Float;
}

/*
==============
SvDemoSP::GetInt64
==============
*/
unsigned __int64 SvDemoSP::GetInt64(SvDemoSP *this)
{
  const char *v1; 
  const char *v2; 
  unsigned __int64 Int64; 

  if ( !sv_demo.playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2186, ASSERT_TYPE_ASSERT, "(sv_demo.playing)", (const char *)&queryFormat, "sv_demo.playing") )
    __debugbreak();
  if ( sv_demo.readType == 25 )
  {
    Int64 = MSG_ReadInt64(&sv_demo.msg);
    SV_DemoSP_ReadNextDemoType();
    return Int64;
  }
  else
  {
    if ( sv_demo.readType > 0x19u )
      v1 = j_va("invalid:%i", sv_demo.readType);
    else
      v1 = s_svdDemoTypeNames[sv_demo.readType];
    v2 = j_va("SV_Demo_GetInt64(): Invalid sv_demo.readType: '%s'", v1);
    SV_DemoSP_EndDemo(v2);
    return 0i64;
  }
}

/*
==============
SvDemoSP::GetInt
==============
*/
__int64 SvDemoSP::GetInt(SvDemoSP *this)
{
  const char *v1; 
  const char *v2; 
  unsigned int Long; 

  if ( !sv_demo.playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2153, ASSERT_TYPE_ASSERT, "(sv_demo.playing)", (const char *)&queryFormat, "sv_demo.playing") )
    __debugbreak();
  if ( sv_demo.readType == 6 )
  {
    Long = MSG_ReadLong(&sv_demo.msg);
    SV_DemoSP_ReadNextDemoType();
    return Long;
  }
  else
  {
    if ( sv_demo.readType > 0x19u )
      v1 = j_va("invalid:%i", sv_demo.readType);
    else
      v1 = s_svdDemoTypeNames[sv_demo.readType];
    v2 = j_va("SV_Demo_GetInt(): Invalid sv_demo.readType: '%s'", v1);
    SV_DemoSP_EndDemo(v2);
    return 0i64;
  }
}

/*
==============
SvDemoSP::GetServerDemoMessageSize
==============
*/
__int64 SvDemoSP::GetServerDemoMessageSize()
{
  return 0x800000i64;
}

/*
==============
SvDemoSP::GetShort
==============
*/
__int64 SvDemoSP::GetShort(SvDemoSP *this)
{
  const char *v1; 
  const char *v2; 
  int Short; 
  unsigned __int16 v5; 

  if ( !sv_demo.playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2119, ASSERT_TYPE_ASSERT, "(sv_demo.playing)", (const char *)&queryFormat, "sv_demo.playing") )
    __debugbreak();
  if ( sv_demo.readType == 5 )
  {
    Short = MSG_ReadShort(&sv_demo.msg);
    v5 = Short;
    if ( (unsigned int)(Short + 0x8000) > 0xFFFF && CoreAssert_Handler("c:\\workspace\\iw8\\shared\\codware\\core\\core_assert.h", 385, ASSERT_TYPE_ASSERT, (const char *)&queryFormat.fmt + 3, "%s (SmallType) %s 0x%jx == (BigType) %s 0x%jx", "short __cdecl truncate_cast_impl<short,int>(int)", "signed", (__int16)Short, "signed", Short) )
      __debugbreak();
    SV_DemoSP_ReadNextDemoType();
    return v5;
  }
  else
  {
    if ( sv_demo.readType > 0x19u )
      v1 = j_va("invalid:%i", sv_demo.readType);
    else
      v1 = s_svdDemoTypeNames[sv_demo.readType];
    v2 = j_va("SV_Demo_GetByte(): Invalid sv_demo.readType: '%s'", v1);
    SV_DemoSP_EndDemo(v2);
    return 0i64;
  }
}

/*
==============
SvDemoSP::GetString
==============
*/
char *SvDemoSP::GetString(SvDemoSP *this)
{
  const char *v1; 
  const char *v2; 
  char string[1024]; 

  if ( !sv_demo.playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2048, ASSERT_TYPE_ASSERT, "(sv_demo.playing)", (const char *)&queryFormat, "sv_demo.playing") )
    __debugbreak();
  if ( sv_demo.readType == 3 )
  {
    if ( MSG_ReadString(&sv_demo.msg, string, 0x400u) )
    {
      SV_DemoSP_ReadNextDemoType();
      return j_va((const char *)&queryFormat, string);
    }
    else
    {
      SV_DemoSP_EndDemo("SV_Demo_GetString() somehow got a NULL string when parsing sv_demo.msg");
      return (char *)&queryFormat.fmt + 3;
    }
  }
  else
  {
    if ( sv_demo.readType > 0x19u )
      v1 = j_va("invalid:%i", sv_demo.readType);
    else
      v1 = s_svdDemoTypeNames[sv_demo.readType];
    v2 = j_va("SV_Demo_GetString(): Invalid sv_demo.readType: '%s'", v1);
    SV_DemoSP_EndDemo(v2);
    return (char *)&queryFormat.fmt + 3;
  }
}

/*
==============
SvDemoSP::InitServerDemoMessageMem
==============
*/
void SvDemoSP::InitServerDemoMessageMem(SvDemoSP *this, unsigned __int8 *mem, unsigned __int64 size)
{
  if ( !mem && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 285, ASSERT_TYPE_ASSERT, "(mem)", (const char *)&queryFormat, "mem") )
    __debugbreak();
  if ( size )
  {
    if ( size == 0x800000 )
      goto LABEL_10;
  }
  else if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 286, ASSERT_TYPE_ASSERT, "(size)", (const char *)&queryFormat, "size") )
  {
    __debugbreak();
  }
  if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 287, ASSERT_TYPE_ASSERT, "( GetServerDemoMessageSize() ) == ( size )", "%s == %s\n\t%u, %u", "GetServerDemoMessageSize()", "size", 0x800000, size) )
    __debugbreak();
LABEL_10:
  if ( this->m_msgBuf && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 289, ASSERT_TYPE_ASSERT, "(m_msgBuf == nullptr)", (const char *)&queryFormat, "m_msgBuf == nullptr") )
    __debugbreak();
  if ( this->m_msgBufSize && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 290, ASSERT_TYPE_ASSERT, "(m_msgBufSize == 0)", (const char *)&queryFormat, "m_msgBufSize == 0") )
    __debugbreak();
  this->m_msgBufSize = size;
  this->m_msgBuf = mem;
  Com_Printf(0, "SvDemoSP::InitServerDemoMessageMem() %zukb total\n", size >> 10);
}

/*
==============
SvDemoSP::RecordByte
==============
*/
void SvDemoSP::RecordByte(SvDemoSP *this, unsigned __int8 value)
{
  if ( SV_Demo_IsRecording() )
  {
    SV_DemoSP_CheckSize();
    MSG_WriteByte(&sv_demo.msg, 4i64);
    MSG_WriteByte(&sv_demo.msg, value);
  }
}

/*
==============
SvDemoSP::RecordCheatsOk
==============
*/
void SvDemoSP::RecordCheatsOk(SvDemoSP *this, int cheatsOk)
{
  if ( sv_demo.recording )
  {
    SV_DemoSP_CheckSize(this);
    MSG_WriteByte(&sv_demo.msg, 11i64);
    MSG_WriteLong(&sv_demo.msg, cheatsOk);
  }
}

/*
==============
SvDemoSP::RecordFloat
==============
*/
void SvDemoSP::RecordFloat(SvDemoSP *this, float value)
{
  __int64 v2; 

  if ( SV_Demo_IsRecording() )
  {
    SV_DemoSP_CheckSize(v2);
    MSG_WriteByte(&sv_demo.msg, 7i64);
    MSG_WriteFloat(&sv_demo.msg, value);
  }
}

/*
==============
SvDemoSP::RecordInt64
==============
*/
void SvDemoSP::RecordInt64(SvDemoSP *this, __int64 value)
{
  __int64 v3; 

  if ( SV_Demo_IsRecording() )
  {
    SV_DemoSP_CheckSize(v3);
    MSG_WriteByte(&sv_demo.msg, 25i64);
    MSG_WriteInt64(&sv_demo.msg, value);
  }
}

/*
==============
SvDemoSP::RecordInt
==============
*/
void SvDemoSP::RecordInt(SvDemoSP *this, int value)
{
  __int64 v3; 

  if ( SV_Demo_IsRecording() )
  {
    SV_DemoSP_CheckSize(v3);
    MSG_WriteByte(&sv_demo.msg, 6i64);
    MSG_WriteLong(&sv_demo.msg, value);
  }
}

/*
==============
SvDemoSP::RecordShort
==============
*/
void SvDemoSP::RecordShort(SvDemoSP *this, __int16 value)
{
  __int64 v3; 

  if ( SV_Demo_IsRecording() )
  {
    SV_DemoSP_CheckSize(v3);
    MSG_WriteByte(&sv_demo.msg, 5i64);
    MSG_WriteShort(&sv_demo.msg, value);
  }
}

/*
==============
SvDemoSP::RecordString
==============
*/
void SvDemoSP::RecordString(SvDemoSP *this, const char *buffer)
{
  if ( sv_demo.recording )
  {
    SV_DemoSP_CheckSize(this);
    MSG_WriteByte(&sv_demo.msg, 3i64);
    MSG_WriteString(&sv_demo.msg, buffer);
  }
}

/*
==============
SV_DemoSP_AddDemoSave
==============
*/
__int64 SV_DemoSP_AddDemoSave(SaveGame *savehandle, server_demo_save_t *save, int createSave)
{
  server_demo_history_t *v6; 
  SvDemo *v7; 
  int i; 
  scrContext_t *j; 
  unsigned __int64 v10; 
  int v11; 
  unsigned __int8 *v12; 
  unsigned __int64 v14; 
  MemoryFile *MemoryFile; 
  unsigned __int64 v16; 
  int v17; 
  unsigned __int8 *buf; 
  unsigned __int8 *v19; 
  MemoryFile *v20; 
  int p; 
  int cheat_items_set1; 
  int v23; 
  int cheat_items_set2; 
  int v25[4]; 
  MemoryFile memFile; 

  if ( (_BYTE)SvDemo::ms_allocatedType != HALF && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.h", 128, ASSERT_TYPE_ASSERT, "( ms_allocatedType == GameModeType::SP )", (const char *)&queryFormat, "ms_allocatedType == GameModeType::SP") )
    __debugbreak();
  v6 = g_history;
  v7 = SvDemo::ms_gServerDemoSystem;
  if ( !g_history )
  {
    if ( g_historySaving && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 929, ASSERT_TYPE_ASSERT, "(!g_historySaving)", (const char *)&queryFormat, "!g_historySaving") )
      __debugbreak();
    v6 = (server_demo_history_t *)&v7[1577989];
  }
  if ( save->buf && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 936, ASSERT_TYPE_ASSERT, "(!save->buf)", (const char *)&queryFormat, "!save->buf") )
    __debugbreak();
  if ( (_BYTE)GSaveMemory::ms_allocatedType != HALF && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\game_sp\\g_savememory_sp.h", 131, ASSERT_TYPE_ASSERT, "( ms_allocatedType == ALLOCATION_TYPE )", (const char *)&queryFormat, "ms_allocatedType == ALLOCATION_TYPE") )
    __debugbreak();
  if ( !GSaveMemory::ms_gSaveMemory && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\game\\savememory.h", 199, ASSERT_TYPE_ASSERT, "( ms_gSaveMemory )", (const char *)&queryFormat, "ms_gSaveMemory") )
    __debugbreak();
  MemFile_InitForWriting(&memFile, 0x600000ui64, &GSaveMemory::ms_gSaveMemory[1573168], 0, 0, StreamModeSource_SPInitializeDemoSave);
  Dvar_SaveDvars(&memFile, 0x80u);
  for ( i = 0; i < 8; ++i )
  {
    GamerProfile_GetIntelligence(i, &cheat_items_set1, &cheat_items_set2);
    p = i;
    MemFile_WriteData(&memFile, 4ui64, &p);
    v23 = cheat_items_set1;
    MemFile_WriteData(&memFile, 4ui64, &v23);
    v25[0] = cheat_items_set2;
    MemFile_WriteData(&memFile, 4ui64, v25);
  }
  for ( j = ScriptContext_GetFirst(); j; j = ScriptContext_GetNext(j) )
    Scr_SaveSource(j, &memFile);
  if ( savehandle )
  {
    MemFile_StartSegment(&memFile, -1, StreamModeSource_SPAddDemoSave);
    if ( !memFile.memoryOverflow )
    {
      v14 = MemFile_CopySegments(&memFile, 0, NULL);
      MemoryFile = SaveMemory_GetMemoryFile(savehandle);
      v16 = MemFile_CopySegments(MemoryFile, 1, NULL) + v14;
      if ( SV_DemoSP_HistoryAlloc(v6, &save->buf, v16) )
      {
        v17 = truncate_cast<int,unsigned __int64>(v16);
        buf = save->buf;
        save->bufLen = v17;
        MemFile_CopySegments(&memFile, 0, buf);
        v19 = &save->buf[v14];
        v20 = SaveMemory_GetMemoryFile(savehandle);
        MemFile_CopySegments(v20, 1, v19);
        return 1i64;
      }
    }
  }
  else
  {
    if ( createSave )
    {
      SV_TransientsSP_SyncForDemoSave();
      G_SaveSP_SaveState(0, &memFile);
    }
    MemFile_StartSegment(&memFile, -1, StreamModeSource_SPAddDemoSave);
    if ( !memFile.memoryOverflow )
    {
      v10 = MemFile_CopySegments(&memFile, 0, NULL);
      if ( SV_DemoSP_HistoryAlloc(v6, &save->buf, v10) )
      {
        v11 = truncate_cast<int,unsigned __int64>(v10);
        v12 = save->buf;
        save->bufLen = v11;
        MemFile_CopySegments(&memFile, 0, v12);
        return 1i64;
      }
    }
  }
  return 0i64;
}

/*
==============
SV_DemoSP_AllocRead
==============
*/
char SV_DemoSP_AllocRead(server_demo_history_t *history, unsigned __int8 **buffer, unsigned __int64 len, sysFileHandle_t file)
{
  if ( !SV_DemoSP_HistoryAlloc(history, buffer, len) )
    return 0;
  if ( len != FS_FileRead(*buffer, len, file) )
  {
    Com_PrintError(1, "SV_DemoRead: read failed\n");
    return 0;
  }
  return 1;
}

/*
==============
SV_DemoSP_AutoSaveEndDemo
==============
*/
void SV_DemoSP_AutoSaveEndDemo(void)
{
  server_demo_history_t *v0; 

  SV_Demo_AutoSave(COUNT|DODGE, "SV_AutoSaveEndDemo()", 50, 0);
  if ( !SV_IsDemoPlayingNext() )
  {
    SV_Demo_WaitForSaveHistoryDone();
    v0 = g_history;
    sv_demo.changed = 0;
    if ( g_history )
    {
      SV_DemoSP_FreeHistoryData(g_history);
      v0 = NULL;
      g_history = NULL;
    }
    if ( sv_demo.msg.data )
    {
      sv_demo.msg.data = NULL;
      sv_demo.msg.maxsize = 0;
    }
    if ( v0 )
    {
      SV_DemoSP_FreeHistoryData(v0);
      g_history = NULL;
    }
    if ( sv_demo.save.buf )
    {
      SV_DemoSP_HistoryFree(sv_demo.save.buf, sv_demo.save.bufLen);
      sv_demo.save.buf = NULL;
      sv_demo.save.bufLen = 0i64;
    }
  }
}

/*
==============
SV_DemoSP_Back_f
==============
*/

void __fastcall SV_DemoSP_Back_f(double a1)
{
  SvGameModeApplication *ActiveServerApplication; 
  int v3; 
  const char *v4; 
  __int128 v6; 

  if ( !sv_demo.msg.data )
  {
    Com_Printf(0, "No replay.\n");
    return;
  }
  if ( sv_demo.forwardTime )
  {
    Com_Printf(0, "replay_back ignored.\n");
    return;
  }
  if ( SV_Cmd_Argc() > 1 )
  {
    v4 = SV_Cmd_Argv(1);
    *((double *)&v6 + 1) = *(&a1 + 1);
    *(double *)&v6 = atof(v4) * 1000.0;
    _XMM1 = v6;
    __asm { vcvttsd2si edi, xmm1 }
    if ( _EDI <= 0 )
    {
      Com_Printf(0, &stru_1440E06D8.mp.gametype[1]);
      return;
    }
  }
  else
  {
    ActiveServerApplication = SvGameModeApplication::GetActiveServerApplication();
    _EDI = SvGameModeApplication::GetFrameDuration(ActiveServerApplication);
  }
  v3 = G_Main_GetTime() - _EDI;
  SV_DemoSP_LoadHistoryForTime(v3);
  sv_demo.nextLevelSave = g_history;
  SV_DemoSP_Restart();
  if ( sv_demo.nextLevelSave && v3 <= sv_demo.nextLevelSave->time + 2500 )
  {
    sv_demo.nextLevelTime = sv_demo.nextLevelSave->time;
  }
  else
  {
    if ( v3 < 2500 )
      v3 = 0;
    sv_demo.nextLevelTime = v3;
  }
}

/*
==============
SV_DemoSP_CheckAutoSaveHistory
==============
*/
_BOOL8 SV_DemoSP_CheckAutoSaveHistory()
{
  const dvar_t *v0; 
  int v1; 
  const dvar_t *v2; 

  v0 = DVARINT_replay_autosave;
  if ( !DVARINT_replay_autosave && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\universal\\dvar.h", 699, ASSERT_TYPE_ASSERT, "(dvar)", "%s\n\tDvar %s accessed after deregistration", "dvar", "replay_autosave") )
    __debugbreak();
  Dvar_CheckFrontendServerThread(v0);
  if ( !v0->current.integer || !sv_demo.playing && !sv_demo.recording )
    return 0i64;
  v1 = G_Main_GetTime() - sv_demo.autoSaveTime;
  if ( v1 >= 0 )
  {
    v2 = DVARINT_replay_autosave;
    if ( !DVARINT_replay_autosave && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\universal\\dvar.h", 699, ASSERT_TYPE_ASSERT, "(dvar)", "%s\n\tDvar %s accessed after deregistration", "dvar", "replay_autosave") )
      __debugbreak();
    Dvar_CheckFrontendServerThread(v2);
    if ( v1 <= 1000 * v2->current.integer )
      return 0i64;
  }
  if ( !Com_GameMode_SupportsFeature(WEAPON_DROPPING_LADDER_CLIMB|0x80) && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 3385, ASSERT_TYPE_ASSERT, "(Com_GameMode_SupportsFeature( Com_GameMode_Feature::TRANSIENT_LEVELZONES ))", (const char *)&queryFormat, "Com_GameMode_SupportsFeature( Com_GameMode_Feature::TRANSIENT_LEVELZONES )") )
    __debugbreak();
  if ( !Com_GameMode_SupportsFeature(WEAPON_DROPPING_AKIMBO|0x80) && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 3386, ASSERT_TYPE_ASSERT, "(Com_GameMode_SupportsFeature( Com_GameMode_Feature::TRANSIENT_SERVERCLIENTSYNC ))", (const char *)&queryFormat, "Com_GameMode_SupportsFeature( Com_GameMode_Feature::TRANSIENT_SERVERCLIENTSYNC )") )
    __debugbreak();
  return SV_TransientsSP_IsSafeToSave();
}

/*
==============
SV_DemoSP_CheckSize
==============
*/
char SV_DemoSP_CheckSize()
{
  SvDemo *v0; 
  char result; 

  sv_demo.changed = 1;
  if ( !sv_demo.msg.data )
    return SV_DemoSP_MsgAlloc(0);
  if ( (_BYTE)SvDemo::ms_allocatedType != HALF && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.h", 128, ASSERT_TYPE_ASSERT, "( ms_allocatedType == GameModeType::SP )", (const char *)&queryFormat, "ms_allocatedType == GameModeType::SP") )
    __debugbreak();
  v0 = SvDemo::ms_gServerDemoSystem;
  if ( sv_demo.msg.data != (unsigned __int8 *)SvDemo::ms_gServerDemoSystem[1].__vftable && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 323, ASSERT_TYPE_ASSERT, "(sv_demo.msg.data == svDemo->m_msgBuf)", (const char *)&queryFormat, "sv_demo.msg.data == svDemo->m_msgBuf") )
    __debugbreak();
  result = sv_demo.msg.maxsize;
  if ( (SvDemo_vtbl *)sv_demo.msg.maxsize != v0[2].__vftable )
  {
    result = CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 324, ASSERT_TYPE_ASSERT, "(sv_demo.msg.maxsize == svDemo->m_msgBufSize)", (const char *)&queryFormat, "sv_demo.msg.maxsize == svDemo->m_msgBufSize");
    if ( result )
      __debugbreak();
  }
  return result;
}

/*
==============
SV_DemoSP_CinematicGetFrame
==============
*/
int SV_DemoSP_CinematicGetFrame()
{
  return SV_DemoSP_GetIntInternal(21);
}

/*
==============
SV_DemoSP_CinematicGetTimeInMsec
==============
*/
int SV_DemoSP_CinematicGetTimeInMsec()
{
  return SV_DemoSP_GetIntInternal(22);
}

/*
==============
SV_DemoSP_DemoSaveHistory
==============
*/
__int64 SV_DemoSP_DemoSaveHistory(server_demo_history_t *history)
{
  server_demo_save_t *p_save; 
  int readcount; 
  SvClient *CommonClient; 
  usercmd_s *lastUsercmd; 
  usercmd_s *p_lastUsercmd; 
  __int64 v7; 
  unsigned int v8; 
  int v9; 
  __int64 v11; 

  p_save = &history->save;
  if ( history->save.buf && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2866, ASSERT_TYPE_ASSERT, "(!history->save.buf)", (const char *)&queryFormat, "!history->save.buf") )
    __debugbreak();
  if ( history->freeEntBuf && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2867, ASSERT_TYPE_ASSERT, "(!history->freeEntBuf)", (const char *)&queryFormat, "!history->freeEntBuf") )
    __debugbreak();
  Profile_Begin(542);
  if ( sv_demo.playing )
  {
    if ( sv_demo.recording && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2873, ASSERT_TYPE_ASSERT, "(!sv_demo.recording)", (const char *)&queryFormat, "!sv_demo.recording") )
      __debugbreak();
    history->nextFramePos = sv_demo.nextFramePos;
    history->readType = sv_demo.readType;
    readcount = sv_demo.msg.readcount;
  }
  else
  {
    if ( !sv_demo.recording )
    {
      if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2884, ASSERT_TYPE_ASSERT, "(sv_demo.recording)", (const char *)&queryFormat, "sv_demo.recording") )
        __debugbreak();
      if ( sv_demo.playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2885, ASSERT_TYPE_ASSERT, "(!sv_demo.playing)", (const char *)&queryFormat, "!sv_demo.playing") )
        __debugbreak();
    }
    history->nextFramePos = G_MainSP_GetFramePos();
    history->readType = 13;
    readcount = sv_demo.msg.cursize;
  }
  history->msgReadcount = readcount;
  if ( (sv_demo.msg.bit & 7) != 0 )
  {
    LODWORD(v11) = sv_demo.msg.bit & 7;
    if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2900, ASSERT_TYPE_ASSERT, "( sv_demo.msg.bit & 7 ) == ( 0 )", "sv_demo.msg.bit & 7 == 0\n\t%i, %i", v11, 0i64) )
      __debugbreak();
  }
  history->randomSeed = *G_GetRandomSeed();
  history->serverId = sv_serverId_value;
  if ( SvClient::ms_clientCount != 1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2905, ASSERT_TYPE_ASSERT, "( SvClient::GetClientCount() == 1 )", (const char *)&queryFormat, "SvClient::GetClientCount() == 1") )
    __debugbreak();
  if ( (_BYTE)SvClient::ms_allocatedType != HALF && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_client_sp.h", 83, ASSERT_TYPE_ASSERT, "( ms_allocatedType == ALLOCATION_TYPE )", (const char *)&queryFormat, "ms_allocatedType == ALLOCATION_TYPE") )
    __debugbreak();
  CommonClient = SvClient::GetCommonClient(0);
  lastUsercmd = history->lastUsercmd;
  p_lastUsercmd = &CommonClient->lastUsercmd;
  v7 = 2i64;
  do
  {
    *(_OWORD *)&lastUsercmd->buttons = *(_OWORD *)&p_lastUsercmd->buttons;
    *(_OWORD *)&lastUsercmd->commandTime = *(_OWORD *)&p_lastUsercmd->commandTime;
    *(_OWORD *)(&lastUsercmd->angles.xy + 1) = *(_OWORD *)(&p_lastUsercmd->angles.xy + 1);
    *(_OWORD *)&lastUsercmd->weapon.weaponOthers = *(_OWORD *)&p_lastUsercmd->weapon.weaponOthers;
    *(_OWORD *)&lastUsercmd->weapon.attachmentVariationIndices[1] = *(_OWORD *)&p_lastUsercmd->weapon.attachmentVariationIndices[1];
    *(_OWORD *)&lastUsercmd->weapon.attachmentVariationIndices[17] = *(_OWORD *)&p_lastUsercmd->weapon.attachmentVariationIndices[17];
    *(_OWORD *)&lastUsercmd->offHand.weaponIdx = *(_OWORD *)&p_lastUsercmd->offHand.weaponIdx;
    lastUsercmd = (usercmd_s *)((char *)lastUsercmd + 128);
    *(_OWORD *)&lastUsercmd[-1].sightedClientsMask.data[4] = *(_OWORD *)&p_lastUsercmd->offHand.weaponAttachments[2];
    p_lastUsercmd = (usercmd_s *)((char *)p_lastUsercmd + 128);
    --v7;
  }
  while ( v7 );
  lastUsercmd->buttons = p_lastUsercmd->buttons;
  if ( !p_save && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2614, ASSERT_TYPE_ASSERT, "(save)", (const char *)&queryFormat, "save") )
    __debugbreak();
  if ( p_save->buf && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2615, ASSERT_TYPE_ASSERT, "(!save->buf)", (const char *)&queryFormat, "!save->buf") )
    __debugbreak();
  p_save->buf = NULL;
  p_save->bufLen = 0i64;
  p_save->file.handle = 0i64;
  v8 = 1;
  if ( (unsigned int)SV_DemoSP_AddDemoSave(NULL, p_save, 1) && (v9 = G_DemoSP_SaveFreeEntities(NULL), history->freeEntBufLen = v9, SV_DemoSP_HistoryAlloc(history, &history->freeEntBuf, v9)) )
    G_DemoSP_SaveFreeEntities(history->freeEntBuf);
  else
    v8 = 0;
  Profile_EndInternal(NULL);
  return v8;
}

/*
==============
SV_DemoSP_DoAutoSaveHistory
==============
*/
void SV_DemoSP_DoAutoSaveHistory(void)
{
  __int64 v0; 

  if ( ((unsigned __int8)&g_serverThreadOwnership & 3) != 0 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\qcommon\\threads_interlock_pc.h", 121, ASSERT_TYPE_ASSERT, "( ( IsAligned( target, sizeof( volatile_int32 ) ) ) )", "( target ) = %p", &g_serverThreadOwnership) )
    __debugbreak();
  if ( _InterlockedCompareExchange(&g_serverThreadOwnership, 1, 0) != 1 )
  {
    LODWORD(v0) = g_serverThreadOwnership;
    if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 3397, ASSERT_TYPE_ASSERT, "( ( Sys_InterlockedCompareExchange( (volatile_int32 *)&g_serverThreadOwnership, 1, 0 ) == 1 ) )", "( g_serverThreadOwnership ) = %i", v0) )
      __debugbreak();
  }
  g_serverThreadOwnership = 1;
  sv_demo.autoSaveTime = G_Main_GetTime();
  SV_DemoSP_GetBuffer();
  g_history->manual = 0;
  SV_DemoSP_FreeHistoryData(g_history);
  if ( !(unsigned int)SV_DemoSP_DemoSaveHistory(g_history) )
  {
    if ( g_history )
    {
      SV_DemoSP_FreeHistoryData(g_history);
      g_history = NULL;
    }
  }
}

/*
==============
SV_DemoSP_EndDemo
==============
*/
void SV_DemoSP_EndDemo(const char *errorMessage)
{
  CLPauseReason PauseReason; 
  unsigned int v3; 
  unsigned int Time; 
  int v5; 
  SvGameGlobalsSP *SvGameGlobalsSP; 
  SvGameModeApplication *ActiveServerApplication; 
  SvGameModeApplication *v8; 
  __int64 v9; 
  unsigned int m_frameDuration; 

  if ( !sv_demo.playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 647, ASSERT_TYPE_ASSERT, "(sv_demo.playing)", (const char *)&queryFormat, "sv_demo.playing") )
    __debugbreak();
  if ( sv_demo.recording && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 648, ASSERT_TYPE_ASSERT, "(!sv_demo.recording)", (const char *)&queryFormat, "!sv_demo.recording") )
    __debugbreak();
  if ( errorMessage && *errorMessage )
  {
    Com_Printf(15, "Aborted replay due to inconsistency:\n%s.\n", errorMessage);
    PauseReason = CL_Pause_GetPauseReason();
    CL_Pause_SetPauseReason((CLPauseReason)(PauseReason | 0x20));
  }
  else
  {
    v3 = com_time;
    Time = G_Main_GetTime();
    Com_Printf(15, "End of replay at time %d (%d).\n", Time, v3);
    sv_demo.recording = 1;
    MSG_RestartWriting(&sv_demo.msg);
    if ( sv_demo.startLive )
    {
      MSG_Truncate(&sv_demo.msg);
      if ( g_history )
      {
        SV_DemoSP_FreeHistoryData(g_history);
        g_history = NULL;
      }
    }
    v5 = G_Main_GetTime();
    SV_DemoSP_TruncateHistoryTimeCache(v5);
  }
  sv_demo.playing = 0;
  sv_demo.nextFramePos = -1;
  sv_demo.forwardTime = 0;
  SvGameGlobalsSP = SvGameGlobalsSP::GetSvGameGlobalsSP();
  ActiveServerApplication = SvGameModeApplication::GetActiveServerApplication();
  if ( !ActiveServerApplication->m_frameDuration && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server\\sv_gamemode_app.h", 162, ASSERT_TYPE_ASSERT, "(m_frameDuration > 0)", "%s\n\tFrame duration has not been initialized", "m_frameDuration > 0") )
    __debugbreak();
  if ( sv_demo.residualTime >= (int)ActiveServerApplication->m_frameDuration )
  {
    v8 = SvGameModeApplication::GetActiveServerApplication();
    if ( !v8->m_frameDuration && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server\\sv_gamemode_app.h", 162, ASSERT_TYPE_ASSERT, "(m_frameDuration > 0)", "%s\n\tFrame duration has not been initialized", "m_frameDuration > 0") )
      __debugbreak();
    m_frameDuration = v8->m_frameDuration;
    LODWORD(v9) = sv_demo.residualTime;
    if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 722, ASSERT_TYPE_ASSERT, "( sv_demo.residualTime ) < ( SvGameModeApplication::GetActiveServerApplication()->GetFrameDuration() )", "sv_demo.residualTime < SvGameModeApplication::GetActiveServerApplication()->GetFrameDuration()\n\t%i, %i", v9, m_frameDuration) )
      __debugbreak();
  }
  SvGameGlobalsSP->demoResetTimeResidual = 1;
  SvGameGlobalsSP->demoResetTimeResidualValue = sv_demo.residualTime;
  sv_demo.residualTime = 0;
  sv_demo.startLive = 0;
  if ( g_history )
  {
    SV_DemoSP_FreeHistoryData(g_history);
    g_history = NULL;
  }
  G_MainSP_CheckSoundsFinish();
}

/*
==============
SV_DemoSP_FindMarkSkip
==============
*/
FileMarkSkip *SV_DemoSP_FindMarkSkip(const char *name)
{
  int i; 
  __int64 v3; 
  const char *v4; 
  FileMarkSkip *v5; 
  int v6; 
  __int64 v7; 
  int v8; 
  int v9; 
  int v10; 

  for ( i = 0; i < g_numFileMarkSkips; ++i )
  {
    v3 = 0x7FFFFFFFi64;
    v4 = name;
    v5 = &g_fileMarkSkips[i];
    if ( !v5 && CoreAssert_Handler("c:\\workspace\\iw8\\shared\\codware\\core\\core_string.h", 212, ASSERT_TYPE_SANITY, "( s0 )", (const char *)&queryFormat, "s0") )
      __debugbreak();
    if ( !name && CoreAssert_Handler("c:\\workspace\\iw8\\shared\\codware\\core\\core_string.h", 213, ASSERT_TYPE_SANITY, "( s1 )", (const char *)&queryFormat, "s1") )
      __debugbreak();
    while ( 1 )
    {
      v6 = (unsigned __int8)v4[(char *)v5 - name];
      v7 = v3;
      v8 = *(unsigned __int8 *)v4++;
      --v3;
      if ( !v7 )
        return &g_fileMarkSkips[i];
      if ( v6 != v8 )
      {
        v9 = v6 + 32;
        if ( (unsigned int)(v6 - 65) > 0x19 )
          v9 = v6;
        v6 = v9;
        v10 = v8 + 32;
        if ( (unsigned int)(v8 - 65) > 0x19 )
          v10 = v8;
        if ( v6 != v10 )
          break;
      }
      if ( !v6 )
        return &g_fileMarkSkips[i];
    }
  }
  return 0i64;
}

/*
==============
SV_DemoSP_Forward_f
==============
*/

void __fastcall SV_DemoSP_Forward_f(double a1)
{
  SvGameModeApplication *ActiveServerApplication; 
  int FrameDuration; 
  const char *v3; 
  __int128 v5; 
  int v7; 
  int v8; 
  int v9; 
  server_demo_history_t *v10; 
  int v11; 

  if ( !sv_demo.playing )
  {
    Com_Printf(0, "Not playing replay.\n");
    return;
  }
  if ( sv_demo.forwardTime )
  {
    Com_Printf(0, "replay_forward ignored.\n");
    return;
  }
  ActiveServerApplication = SvGameModeApplication::GetActiveServerApplication();
  FrameDuration = SvGameModeApplication::GetFrameDuration(ActiveServerApplication);
  if ( SV_Cmd_Argc() <= 1 )
  {
    sv_demo.forwardTime = FrameDuration + G_Main_GetTime();
    return;
  }
  v3 = SV_Cmd_Argv(1);
  *((double *)&v5 + 1) = *(&a1 + 1);
  *(double *)&v5 = atof(v3) * (float)(1000.0 / (float)FrameDuration);
  _XMM0 = v5;
  __asm { vcvttsd2si esi, xmm0 }
  v7 = FrameDuration * _ESI;
  if ( v7 <= 0 )
  {
    Com_Printf(0, &stru_1440E06D8.mp.gametype[1]);
    return;
  }
  v8 = v7 + G_Main_GetTime();
  SV_DemoSP_LoadHistoryForTime(v8);
  if ( g_history )
    goto LABEL_12;
  v9 = 2 * Dvar_GetInt_Internal_DebugName(DVARINT_replay_autosave, "replay_autosave");
  if ( G_Main_GetTime() <= v9 )
  {
LABEL_13:
    sv_demo.forwardTime = v8;
    return;
  }
  v10 = g_history;
  if ( g_history )
  {
LABEL_12:
    v11 = g_history->time - G_Main_GetTime();
    if ( v11 <= 2 * Dvar_GetInt_Internal_DebugName(DVARINT_replay_autosave, "replay_autosave") )
      goto LABEL_13;
    v10 = g_history;
  }
  sv_demo.nextLevelSave = v10;
  SV_DemoSP_Restart();
  SV_DemoSP_SetNextLevelTime(v8);
}

/*
==============
SV_DemoSP_FreeHistoryData
==============
*/
void SV_DemoSP_FreeHistoryData(server_demo_history_t *history)
{
  unsigned __int8 *freeEntBuf; 
  unsigned __int8 *buf; 

  if ( !history && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 820, ASSERT_TYPE_ASSERT, "(history)", (const char *)&queryFormat, "history") )
    __debugbreak();
  freeEntBuf = history->freeEntBuf;
  if ( freeEntBuf )
  {
    SV_DemoSP_HistoryFree(freeEntBuf, history->freeEntBufLen);
    history->freeEntBuf = NULL;
    history->freeEntBufLen = 0;
  }
  buf = history->save.buf;
  if ( buf )
  {
    SV_DemoSP_HistoryFree(buf, history->save.bufLen);
    history->save.buf = NULL;
    history->save.bufLen = 0i64;
  }
}

/*
==============
SV_DemoSP_FullForward_f
==============
*/

void __fastcall SV_DemoSP_FullForward_f(double a1)
{
  SvGameModeApplication *ActiveServerApplication; 
  int FrameDuration; 
  const char *v3; 
  __int128 v5; 
  int v7; 

  if ( sv_demo.playing )
  {
    if ( sv_demo.forwardTime )
    {
      Com_Printf(0, "replay_forward_full ignored.\n");
    }
    else
    {
      ActiveServerApplication = SvGameModeApplication::GetActiveServerApplication();
      FrameDuration = SvGameModeApplication::GetFrameDuration(ActiveServerApplication);
      if ( SV_Cmd_Argc() > 1 )
      {
        v3 = SV_Cmd_Argv(1);
        *((double *)&v5 + 1) = *(&a1 + 1);
        *(double *)&v5 = atof(v3) * (float)(1000.0 / (float)FrameDuration);
        _XMM0 = v5;
        __asm { vcvttsd2si edi, xmm0 }
        v7 = FrameDuration * _EDI;
        if ( v7 > 0 )
          sv_demo.forwardTime = v7 + G_Main_GetTime();
        else
          Com_Printf(0, &stru_1440E06D8.mp.gametype[1]);
      }
      else
      {
        sv_demo.forwardTime = FrameDuration + G_Main_GetTime();
      }
    }
  }
  else
  {
    Com_Printf(0, "Not playing replay.\n");
  }
}

/*
==============
SV_DemoSP_GetBoolInternal
==============
*/
bool SV_DemoSP_GetBoolInternal(int readType)
{
  __int64 v2; 
  const char *v3; 
  char *v4; 
  const char *v5; 
  const char *v6; 
  bool v7; 

  if ( !sv_demo.playing )
    return 0;
  v2 = sv_demo.readType;
  if ( sv_demo.readType == readType )
  {
    v7 = MSG_ReadByte(&sv_demo.msg) != 0;
    SV_DemoSP_ReadNextDemoType();
    return v7;
  }
  else
  {
    if ( (unsigned int)readType > 0x19 )
    {
      v4 = j_va("invalid:%i", (unsigned int)readType);
      v2 = (unsigned int)sv_demo.readType;
      v3 = v4;
    }
    else
    {
      v3 = s_svdDemoTypeNames[sv_demo.readType];
    }
    if ( (unsigned int)v2 > 0x19 )
      v5 = j_va("invalid:%i", v2);
    else
      v5 = s_svdDemoTypeNames[(int)v2];
    v6 = j_va("DemoBool_Internal(): Invalid sv_demo.readType: '%s'. Should be '%s'.", v5, v3);
    SV_DemoSP_EndDemo(v6);
    return 0;
  }
}

/*
==============
SV_DemoSP_GetBuffer
==============
*/
int SV_DemoSP_GetBuffer()
{
  server_demo_history_t *v0; 
  int v1; 
  int time; 
  int *p_time; 
  int v4; 
  FileSkip *v5; 
  int v6; 
  const dvar_t *v7; 
  __int64 v8; 
  int result; 
  int v10; 

  v0 = g_history;
  if ( g_history )
  {
    v1 = g_numFileSkips;
    if ( g_numFileSkips )
    {
      if ( !g_history->manual )
      {
        time = g_history->time;
        p_time = &g_history->time;
        if ( time <= g_fileSkips[g_numFileSkips - 1].time )
        {
          v4 = 0;
          if ( g_numFileSkips > 0 )
          {
            v5 = g_fileSkips;
            do
            {
              if ( v5->time > time )
                break;
              ++v4;
              ++v5;
            }
            while ( v4 < g_numFileSkips );
          }
          v6 = v4 - 1;
          if ( v4 - 1 < -1 || v6 >= g_numFileSkips )
          {
            v10 = v4 - 1;
            if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2812, ASSERT_TYPE_ASSERT, "( ( fileSkipIndex >= -1 && fileSkipIndex < g_numFileSkips ) )", "( fileSkipIndex ) = %i", v10) )
              __debugbreak();
            v1 = g_numFileSkips;
            v0 = g_history;
          }
          if ( v6 != v1 - 1 )
          {
            v7 = DVARINT_replay_autosave;
            if ( !DVARINT_replay_autosave && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\universal\\dvar.h", 699, ASSERT_TYPE_ASSERT, "(dvar)", "%s\n\tDvar %s accessed after deregistration", "dvar", "replay_autosave") )
              __debugbreak();
            Dvar_CheckFrontendServerThread(v7);
            if ( g_fileSkips[v4].time > *p_time + 1500 * v7->current.integer )
              SV_DemoSP_TruncateHistoryTimeCache(*p_time);
            v1 = g_numFileSkips;
            v0 = g_history;
          }
        }
      }
    }
    if ( v0 && (!v1 || v0->manual || v0->time > g_fileSkips[v1 - 1].time) )
    {
      SV_Demo_WaitForSaveHistoryDone();
      if ( g_historySaving && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2831, ASSERT_TYPE_ASSERT, "(!g_historySaving)", (const char *)&queryFormat, "!g_historySaving") )
        __debugbreak();
      g_historySaving = g_history;
      Sys_SetSaveHistoryEvent();
    }
  }
  if ( (_BYTE)SvDemo::ms_allocatedType != HALF && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.h", 128, ASSERT_TYPE_ASSERT, "( ms_allocatedType == GameModeType::SP )", (const char *)&queryFormat, "ms_allocatedType == GameModeType::SP") )
    __debugbreak();
  v8 = 1577989i64;
  if ( g_historySaving == (server_demo_history_t *volatile)&SvDemo::ms_gServerDemoSystem[1577989] )
    v8 = 1584607i64;
  g_history = (server_demo_history_t *)&SvDemo::ms_gServerDemoSystem[v8];
  SV_DemoSP_FreeHistoryData((server_demo_history_t *)&SvDemo::ms_gServerDemoSystem[v8]);
  memset_0(g_history, 0, sizeof(server_demo_history_t));
  result = G_Main_GetTime();
  g_history->time = result;
  return result;
}

/*
==============
SV_DemoSP_GetButtonPressed
==============
*/
__int64 SV_DemoSP_GetButtonPressed()
{
  const char *v0; 
  const char *v1; 
  unsigned int Byte; 

  if ( !sv_demo.playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2255, ASSERT_TYPE_ASSERT, "(sv_demo.playing)", (const char *)&queryFormat, "sv_demo.playing") )
    __debugbreak();
  if ( sv_demo.readType == 12 )
  {
    Byte = MSG_ReadByte(&sv_demo.msg);
    SV_DemoSP_ReadNextDemoType();
    return Byte;
  }
  else
  {
    if ( sv_demo.readType > 0x19u )
      v0 = j_va("invalid:%i", sv_demo.readType);
    else
      v0 = s_svdDemoTypeNames[sv_demo.readType];
    v1 = j_va("SV_DemoButtonPressed(): Invalid sv_demo.readType: '%s'", v0);
    SV_DemoSP_EndDemo(v1);
    return 0i64;
  }
}

/*
==============
SV_DemoSP_GetCorpseOrigins
==============
*/
void SV_DemoSP_GetCorpseOrigins(void)
{
  const char *v0; 
  const char *v1; 
  __int64 v2; 
  vec3_t *p_physicsOrigin; 

  if ( !sv_demo.playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 1775, ASSERT_TYPE_ASSERT, "(sv_demo.playing)", (const char *)&queryFormat, "sv_demo.playing") )
    __debugbreak();
  if ( sv_demo.readType == 24 )
  {
    v2 = 28i64;
    p_physicsOrigin = &GameScriptDataSP::GetGameScriptDataSP()->actorCorpseInfo[0].physicsOrigin;
    do
    {
      MSG_ReadVec3(&sv_demo.msg, p_physicsOrigin);
      p_physicsOrigin += 4;
      --v2;
    }
    while ( v2 );
    SV_DemoSP_ReadNextDemoType();
  }
  else
  {
    if ( sv_demo.readType > 0x19u )
      v0 = j_va("invalid:%i", sv_demo.readType);
    else
      v0 = s_svdDemoTypeNames[sv_demo.readType];
    v1 = j_va("SV_DemoSP_GetCorpseOrigins(): Invalid sv_demo.readType: '%s'", v0);
    SV_DemoSP_EndDemo(v1);
  }
}

/*
==============
SV_DemoSP_GetFreeDemoName
==============
*/
void SV_DemoSP_GetFreeDemoName(const char *baseName, int demoCount, char *testDemoName)
{
  int i; 
  __int64 v7; 
  __int64 v8; 
  __int64 v9; 
  fileHandle_t file; 
  char path[256]; 

  for ( i = 1; !demoCount || i < demoCount; ++i )
  {
    LODWORD(v8) = i;
    Com_sprintf(testDemoName, 0x40ui64, "%s%i", baseName, v8);
    Com_BuildPlayerProfilePath(path, 256, "save/%s.svg", testDemoName);
    v7 = FS_FOpenFileReadCurrentThread(path, &file);
    FS_FCloseFile(file);
    if ( v7 <= 0 )
      goto LABEL_7;
  }
  i = 0;
LABEL_7:
  if ( demoCount )
  {
    LODWORD(v8) = (i + 1) % demoCount;
    Com_sprintf(testDemoName, 0x40ui64, "%s%i", baseName, v8);
    Com_BuildPlayerProfilePath(path, 256, "save/%s.svg", testDemoName);
    FS_Delete(path);
    LODWORD(v9) = i;
    Com_sprintf(testDemoName, 0x40ui64, "%s%i", baseName, v9);
  }
}

/*
==============
SV_DemoSP_GetFxVisibility
==============
*/
float SV_DemoSP_GetFxVisibility()
{
  const char *v0; 
  const char *v1; 
  double Float; 

  if ( !sv_demo.playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 1733, ASSERT_TYPE_ASSERT, "(sv_demo.playing)", (const char *)&queryFormat, "sv_demo.playing") )
    __debugbreak();
  if ( sv_demo.readType == 1 )
  {
    Float = MSG_ReadFloat(&sv_demo.msg);
    SV_DemoSP_ReadNextDemoType();
  }
  else
  {
    if ( sv_demo.readType > 0x19u )
      v0 = j_va("invalid:%i", sv_demo.readType);
    else
      v0 = s_svdDemoTypeNames[sv_demo.readType];
    v1 = j_va("SV_DemoFxVisibility(): Invalid sv_demo.readType: '%s'", v0);
    SV_DemoSP_EndDemo(v1);
    LODWORD(Float) = 0;
  }
  return *(float *)&Float;
}

/*
==============
SV_DemoSP_GetIntInternal
==============
*/
__int64 SV_DemoSP_GetIntInternal(int readType)
{
  __int64 v2; 
  const char *v3; 
  char *v4; 
  const char *v5; 
  const char *v6; 
  unsigned int Long; 

  if ( !sv_demo.playing )
    return 0i64;
  v2 = sv_demo.readType;
  if ( sv_demo.readType == readType )
  {
    Long = MSG_ReadLong(&sv_demo.msg);
    SV_DemoSP_ReadNextDemoType();
    return Long;
  }
  else
  {
    if ( (unsigned int)readType > 0x19 )
    {
      v4 = j_va("invalid:%i", (unsigned int)readType);
      v2 = (unsigned int)sv_demo.readType;
      v3 = v4;
    }
    else
    {
      v3 = s_svdDemoTypeNames[sv_demo.readType];
    }
    if ( (unsigned int)v2 > 0x19 )
      v5 = j_va("invalid:%i", v2);
    else
      v5 = s_svdDemoTypeNames[(int)v2];
    v6 = j_va("DemoInt_Internal(): Invalid sv_demo.readType: '%s'. Should be '%s'.", v5, v3);
    SV_DemoSP_EndDemo(v6);
    return 0i64;
  }
}

/*
==============
SV_DemoSP_GetIsCinematicLoaded
==============
*/
bool SV_DemoSP_GetIsCinematicLoaded()
{
  return SV_DemoSP_GetBoolInternal(20);
}

/*
==============
SV_DemoSP_GetIsCinematicPlaying
==============
*/
bool SV_DemoSP_GetIsCinematicPlaying()
{
  return SV_DemoSP_GetBoolInternal(16);
}

/*
==============
SV_DemoSP_GetIsRecentlyLoaded
==============
*/
bool SV_DemoSP_GetIsRecentlyLoaded()
{
  return SV_DemoSP_GetBoolInternal(14);
}

/*
==============
SV_DemoSP_GetLoadIntelligence
==============
*/
void SV_DemoSP_GetLoadIntelligence(MemoryFile *memFile)
{
  int i; 
  int v3; 
  int p; 
  int cheat_items_set2; 
  int cheat_items_set1; 

  for ( i = 0; i < 8; ++i )
  {
    MemFile_ReadData(memFile, 4ui64, &p);
    v3 = p;
    if ( p != i && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 1706, ASSERT_TYPE_ASSERT, "(cntrllrIndex == controllerIndex)", (const char *)&queryFormat, "cntrllrIndex == controllerIndex") )
      __debugbreak();
    MemFile_ReadData(memFile, 4ui64, &cheat_items_set1);
    MemFile_ReadData(memFile, 4ui64, &cheat_items_set2);
    GamerProfile_SetIntelligence(v3, cheat_items_set1, cheat_items_set2);
  }
}

/*
==============
SV_DemoSP_GetPreloadZonesState
==============
*/
bool SV_DemoSP_GetPreloadZonesState()
{
  return SV_DemoSP_GetBoolInternal(23);
}

/*
==============
SV_DemoSP_GetSaveCommitWouldBeValid
==============
*/
bool SV_DemoSP_GetSaveCommitWouldBeValid()
{
  return SV_DemoSP_GetBoolInternal(18);
}

/*
==============
SV_DemoSP_GetTimeSincePaused
==============
*/
__int64 SV_DemoSP_GetTimeSincePaused()
{
  const char *v0; 
  const char *v1; 
  unsigned int Long; 

  if ( !sv_demo.playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2290, ASSERT_TYPE_ASSERT, "(sv_demo.playing)", (const char *)&queryFormat, "sv_demo.playing") )
    __debugbreak();
  if ( sv_demo.readType == 15 )
  {
    Long = MSG_ReadLong(&sv_demo.msg);
    SV_DemoSP_ReadNextDemoType();
    return Long;
  }
  else
  {
    if ( sv_demo.readType > 0x19u )
      v0 = j_va("invalid:%i", sv_demo.readType);
    else
      v0 = s_svdDemoTypeNames[sv_demo.readType];
    v1 = j_va("SV_DemoTimeSincePaused(): Invalid sv_demo.readType: '%s'", v0);
    SV_DemoSP_EndDemo(v1);
    return 0i64;
  }
}

/*
==============
SV_DemoSP_GetTransientState
==============
*/
__int64 SV_DemoSP_GetTransientState()
{
  const char *v0; 
  const char *v1; 
  unsigned int Long; 

  if ( !sv_demo.playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 1889, ASSERT_TYPE_ASSERT, "(sv_demo.playing)", (const char *)&queryFormat, "sv_demo.playing") )
    __debugbreak();
  if ( sv_demo.readType == 19 )
  {
    Long = MSG_ReadLong(&sv_demo.msg);
    SV_DemoSP_ReadNextDemoType();
    return Long;
  }
  else
  {
    if ( sv_demo.readType > 0x19u )
      v0 = j_va("invalid:%i", sv_demo.readType);
    else
      v0 = s_svdDemoTypeNames[sv_demo.readType];
    v1 = j_va("SV_DemoGetTransientState(): Invalid sv_demo.readType: '%s'", v0);
    SV_DemoSP_EndDemo(v1);
    return 0i64;
  }
}

/*
==============
SV_DemoSP_Goto_f
==============
*/
void SV_DemoSP_Goto_f(void)
{
  const char *v0; 
  FileMarkSkip *MarkSkip; 

  if ( !sv_demo.msg.data )
  {
    Com_Printf(0, "No replay.\n");
    return;
  }
  if ( SV_Cmd_Argc() <= 1 )
    v0 = (char *)&queryFormat.fmt + 3;
  else
    v0 = SV_Cmd_Argv(1);
  if ( !g_history || !g_history->manual || I_stricmp(g_history->name, v0) )
  {
    SV_DemoSP_GetBuffer();
    MarkSkip = SV_DemoSP_FindMarkSkip(v0);
    if ( !MarkSkip )
    {
      g_history = NULL;
LABEL_11:
      Com_Printf(0, "Mark not found.\n");
      return;
    }
    if ( !SV_DemoSP_LoadHistory(g_fileMarkHistory, MarkSkip->fileOffset) )
      goto LABEL_11;
    if ( !g_history->save.buf && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 3091, ASSERT_TYPE_SANITY, "( g_history->save.buf )", (const char *)&queryFormat, "g_history->save.buf") )
      __debugbreak();
    if ( !g_history->freeEntBuf && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 3092, ASSERT_TYPE_SANITY, "( g_history->freeEntBuf )", (const char *)&queryFormat, "g_history->freeEntBuf") )
      __debugbreak();
    if ( !g_history->manual && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 3093, ASSERT_TYPE_SANITY, "( g_history->manual )", (const char *)&queryFormat, "g_history->manual") )
      __debugbreak();
  }
  sv_demo.nextLevelSave = g_history;
  SV_DemoSP_Restart();
}

/*
==============
SV_DemoSP_HasMark
==============
*/
bool SV_DemoSP_HasMark()
{
  if ( !sv_demo.playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2526, ASSERT_TYPE_ASSERT, "(sv_demo.playing)", (const char *)&queryFormat, "sv_demo.playing") )
    __debugbreak();
  return g_history && g_history->manual;
}

/*
==============
SV_DemoSP_HistoryAlloc
==============
*/
__int64 SV_DemoSP_HistoryAlloc(server_demo_history_t *history, unsigned __int8 **pData, unsigned __int64 size)
{
  __int64 v6; 
  __int64 v7; 
  SvDemo *v8; 
  SvDemo_vtbl *v9; 
  SvDemo_vtbl *v10; 
  unsigned __int8 *v11; 
  __int64 result; 

  if ( !size && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 252, ASSERT_TYPE_ASSERT, "( ( size > 0 ) )", "( size ) = %zu", 0i64) )
    __debugbreak();
  if ( !history && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 253, ASSERT_TYPE_ASSERT, "(history)", (const char *)&queryFormat, "history") )
    __debugbreak();
  if ( (_BYTE)SvDemo::ms_allocatedType != HALF && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.h", 128, ASSERT_TYPE_ASSERT, "( ms_allocatedType == GameModeType::SP )", (const char *)&queryFormat, "ms_allocatedType == GameModeType::SP") )
    __debugbreak();
  if ( history == (server_demo_history_t *)&SvDemo::ms_gServerDemoSystem[1584607] )
  {
    v6 = 6311936i64;
    v7 = 1577988i64;
  }
  else
  {
    if ( history != (server_demo_history_t *)&SvDemo::ms_gServerDemoSystem[1577989] && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 211, ASSERT_TYPE_ASSERT, "(history == &svDemo->m_historyBuffers[0])", (const char *)&queryFormat, "history == &svDemo->m_historyBuffers[0]") )
      __debugbreak();
    v6 = 0i64;
    v7 = 1577987i64;
  }
  if ( (_BYTE)SvDemo::ms_allocatedType != HALF && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.h", 128, ASSERT_TYPE_ASSERT, "( ms_allocatedType == GameModeType::SP )", (const char *)&queryFormat, "ms_allocatedType == GameModeType::SP") )
    __debugbreak();
  v8 = SvDemo::ms_gServerDemoSystem;
  v9 = SvDemo::ms_gServerDemoSystem[v7].__vftable;
  v10 = (SvDemo_vtbl *)((char *)v9 + size);
  if ( (unsigned __int64)v9 + size > 0x605000 )
  {
    Com_PrintError(1, "SV_HistoryAlloc failed. Needed %zd more memory\n", (size_t)&v10[-39450].RecordShort);
    return 0i64;
  }
  else
  {
    v11 = (unsigned __int8 *)&SvDemo::ms_gServerDemoSystem[3] + (_QWORD)v9 + v6;
    *pData = v11;
    memset_0(v11, 0, size);
    result = 1i64;
    v8[v7].__vftable = v10;
  }
  return result;
}

/*
==============
SV_DemoSP_HistoryFree
==============
*/
void SV_DemoSP_HistoryFree(unsigned __int8 *ptr, unsigned __int64 size)
{
  SvDemo *v4; 
  __int64 v5; 
  __int64 v6; 
  __int64 v7; 

  if ( (_BYTE)SvDemo::ms_allocatedType != HALF && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.h", 128, ASSERT_TYPE_ASSERT, "( ms_allocatedType == GameModeType::SP )", (const char *)&queryFormat, "ms_allocatedType == GameModeType::SP") )
    __debugbreak();
  v4 = SvDemo::ms_gServerDemoSystem;
  if ( (_BYTE)SvDemo::ms_allocatedType != HALF && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.h", 128, ASSERT_TYPE_ASSERT, "( ms_allocatedType == GameModeType::SP )", (const char *)&queryFormat, "ms_allocatedType == GameModeType::SP") )
    __debugbreak();
  v5 = 0i64;
  while ( 1 )
  {
    v6 = 788992i64 * (int)v5;
    if ( ptr >= (unsigned __int8 *)&SvDemo::ms_gServerDemoSystem[v6 + 3] && ptr < (unsigned __int8 *)&SvDemo::ms_gServerDemoSystem[v6 + 788995] )
      break;
    v5 = (unsigned int)(v5 + 1);
    if ( (int)v5 >= 2 )
    {
      if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 227, ASSERT_TYPE_ASSERT, (const char *)&queryFormat.fmt + 3, "SV_GetBufferIndex: ptr 0x%p isn't in either of the history buffers.\n", ptr) )
        __debugbreak();
      v5 = 0i64;
      break;
    }
  }
  v7 = (unsigned int)v5;
  if ( v4[v5 + 1577987].__vftable < (SvDemo_vtbl *)size && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 239, ASSERT_TYPE_ASSERT, "(svDemo->m_bufSize[bufferIndex] >= size)", (const char *)&queryFormat, "svDemo->m_bufSize[bufferIndex] >= size") )
    __debugbreak();
  v4[v7 + 1577987].__vftable = (SvDemo_vtbl *)((char *)v4[v7 + 1577987].__vftable - size);
  if ( ptr != (unsigned __int8 *)((char *)&v4[v7 + 1577987].GetCheatsOk + 6311936 * v7 + (unsigned __int64)v4) && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 243, ASSERT_TYPE_ASSERT, "(ptr == svDemo->m_buf[bufferIndex] + svDemo->m_bufSize[bufferIndex])", (const char *)&queryFormat, "ptr == svDemo->m_buf[bufferIndex] + svDemo->m_bufSize[bufferIndex]") )
    __debugbreak();
}

/*
==============
SV_DemoSP_Info_f
==============
*/
void SV_DemoSP_Info_f(void)
{
  int v0; 
  int v1; 
  __int64 *p_fileOffset; 
  FileSkip *v3; 

  if ( g_fileTimeHistory.handle == -1 || g_fileMarkHistory.handle == -1 )
  {
    Com_PrintError(1, "Failed to open demo cache file.\n");
  }
  else
  {
    v0 = 0;
    if ( g_numFileMarkSkips > 0 )
    {
      Com_Printf(0, "Named Marks(%d):\n", (unsigned int)g_numFileMarkSkips);
      v1 = 0;
      if ( g_numFileMarkSkips > 0 )
      {
        p_fileOffset = &g_fileMarkSkips[0].fileOffset;
        do
        {
          Com_Printf(0, "\t'%s':%zd\n", g_fileMarkSkips[v1++].name, *p_fileOffset);
          p_fileOffset += 9;
        }
        while ( v1 < g_numFileMarkSkips );
      }
    }
    if ( g_numFileSkips > 0 )
    {
      Com_Printf(0, "Time Marks(%d):\n", (unsigned int)g_numFileSkips);
      if ( g_numFileSkips > 0 )
      {
        v3 = g_fileSkips;
        do
        {
          Com_Printf(0, "\t%d:%zd\n", (unsigned int)v3->time, v3->fileEndOffset);
          ++v0;
          ++v3;
        }
        while ( v0 < g_numFileSkips );
      }
    }
  }
}

/*
==============
SV_DemoSP_Init
==============
*/
void SV_DemoSP_Init(unsigned int *randomSeed)
{
  unsigned int v2; 
  unsigned int i; 
  TransientSPZoneState ZoneModeByIndex; 
  __int64 v5; 
  __int64 v6; 
  __int64 v7; 

  if ( !randomSeed && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 1439, ASSERT_TYPE_ASSERT, "( randomSeed )", (const char *)&queryFormat, "randomSeed") )
    __debugbreak();
  if ( !SvDemo::ms_gServerDemoSystem && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 1440, ASSERT_TYPE_ASSERT, "( SvDemo::IsSystemEnabled() )", (const char *)&queryFormat, "SvDemo::IsSystemEnabled()") )
    __debugbreak();
  sv_demo.autoSaveTime = G_Main_GetTime();
  if ( sv_demo.nextLevelplaying )
  {
    SV_DemoSP_InitReadDemo(randomSeed);
    return;
  }
  v2 = *randomSeed;
  ProfLoad_Begin("SV_InitWriteDemo");
  if ( sv_demo.nextLevelplaying && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 1193, ASSERT_TYPE_ASSERT, "(!sv_demo.nextLevelplaying)", (const char *)&queryFormat, "!sv_demo.nextLevelplaying") )
    __debugbreak();
  sv_demo.changed = 0;
  if ( g_history )
  {
    SV_DemoSP_FreeHistoryData(g_history);
    g_history = NULL;
  }
  if ( sv_demo.msg.data )
  {
    sv_demo.msg.data = NULL;
    sv_demo.msg.maxsize = 0;
  }
  sv_demo.recording = 1;
  sv_demo.startTime = G_Main_GetTime();
  if ( sv_demo.msg.data && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 1200, ASSERT_TYPE_ASSERT, "(!sv_demo.msg.data)", (const char *)&queryFormat, "!sv_demo.msg.data") )
    __debugbreak();
  MSG_Init(&sv_demo.msg, NULL, 0);
  SV_DemoSP_CheckSize();
  MSG_WriteLong(&sv_demo.msg, v2);
  MSG_WriteLong(&sv_demo.msg, sv_serverId_value);
  MSG_WriteLong(&sv_demo.msg, 32);
  for ( i = 0; i < 0x20; ++i )
  {
    ZoneModeByIndex = CL_TransientsSP_GetZoneModeByIndex(i);
    if ( !ZoneModeByIndex )
    {
      v5 = 0i64;
      goto LABEL_25;
    }
    if ( ZoneModeByIndex == 4 )
    {
      v5 = 1i64;
LABEL_25:
      MSG_WriteByte(&sv_demo.msg, v5);
      continue;
    }
    LODWORD(v7) = ZoneModeByIndex;
    LODWORD(v6) = i;
    if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 1147, ASSERT_TYPE_ASSERT, (const char *)&queryFormat.fmt + 3, "Bad transient state recorded: %d %d", v6, v7) )
      __debugbreak();
  }
  g_numFileSkips = 0;
  g_writtenFileTimeHistory = 0i64;
  if ( g_fileTimeHistory.handle != -1 )
    FS_FileSeek(g_fileTimeHistory, 0i64, 2);
  g_numFileMarkSkips = 0;
  if ( g_fileMarkHistory.handle != -1 )
    FS_FileSeek(g_fileMarkHistory, 0i64, 2);
  G_SaveSP_UpdateAllEntities();
  ProfLoad_End();
}

/*
==============
SV_DemoSP_InitReadDemo
==============
*/
void SV_DemoSP_InitReadDemo(unsigned int *randomSeed)
{
  server_demo_history_t *nextLevelSave; 
  int Long; 
  unsigned int i; 
  SvClient *CommonClient; 
  __int64 v6; 
  usercmd_s *p_lastUsercmd; 
  usercmd_s *lastUsercmd; 
  __int128 v9; 
  int v10; 
  int nextLevelTime; 

  ProfLoad_Begin("SV_InitReadDemo");
  if ( !randomSeed && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 1297, ASSERT_TYPE_ASSERT, "(randomSeed)", (const char *)&queryFormat, "randomSeed") )
    __debugbreak();
  if ( !sv_demo.nextLevelplaying && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 1299, ASSERT_TYPE_ASSERT, "(sv_demo.nextLevelplaying)", (const char *)&queryFormat, "sv_demo.nextLevelplaying") )
    __debugbreak();
  sv_demo.nextLevelplaying = 0;
  *(_WORD *)&sv_demo.playing = 257;
  sv_demo.residualTime = 0;
  MSG_BeginReading(&sv_demo.msg);
  nextLevelSave = sv_demo.nextLevelSave;
  if ( sv_demo.nextLevelSave )
  {
    if ( !sv_demo.nextLevelSave->freeEntBuf )
    {
      if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 1327, ASSERT_TYPE_ASSERT, "(sv_demo.nextLevelSave->freeEntBuf)", (const char *)&queryFormat, "sv_demo.nextLevelSave->freeEntBuf") )
        __debugbreak();
      nextLevelSave = sv_demo.nextLevelSave;
    }
    G_DemoSP_LoadFreeEntities(nextLevelSave->freeEntBuf);
    G_SaveSP_UpdateAllEntities();
    *randomSeed = sv_demo.nextLevelSave->randomSeed;
    sv_serverId_value = sv_demo.nextLevelSave->serverId;
    if ( SvClient::ms_clientCount != 1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 1335, ASSERT_TYPE_ASSERT, "( SvClient::GetClientCount() == 1 )", (const char *)&queryFormat, "SvClient::GetClientCount() == 1") )
      __debugbreak();
    if ( (_BYTE)SvClient::ms_allocatedType != HALF && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_client_sp.h", 83, ASSERT_TYPE_ASSERT, "( ms_allocatedType == ALLOCATION_TYPE )", (const char *)&queryFormat, "ms_allocatedType == ALLOCATION_TYPE") )
      __debugbreak();
    CommonClient = SvClient::GetCommonClient(0);
    v6 = 2i64;
    p_lastUsercmd = &CommonClient->lastUsercmd;
    lastUsercmd = sv_demo.nextLevelSave->lastUsercmd;
    do
    {
      p_lastUsercmd = (usercmd_s *)((char *)p_lastUsercmd + 128);
      v9 = *(_OWORD *)&lastUsercmd->buttons;
      lastUsercmd = (usercmd_s *)((char *)lastUsercmd + 128);
      *(_OWORD *)&p_lastUsercmd[-1].offHand.attachmentVariationIndices[13] = v9;
      *(_OWORD *)&p_lastUsercmd[-1].offHand.weaponCamo = *(_OWORD *)&lastUsercmd[-1].offHand.weaponCamo;
      *(_OWORD *)p_lastUsercmd[-1].remoteControlMove = *(_OWORD *)lastUsercmd[-1].remoteControlMove;
      *(_OWORD *)p_lastUsercmd[-1].vehAngles = *(_OWORD *)lastUsercmd[-1].vehAngles;
      *(_OWORD *)&p_lastUsercmd[-1].vehOrgZ = *(_OWORD *)&lastUsercmd[-1].vehOrgZ;
      *(_OWORD *)&p_lastUsercmd[-1].gunYOfs = *(_OWORD *)&lastUsercmd[-1].gunYOfs;
      *(_OWORD *)p_lastUsercmd[-1].sightedClientsMask.data = *(_OWORD *)lastUsercmd[-1].sightedClientsMask.data;
      *(_OWORD *)&p_lastUsercmd[-1].sightedClientsMask.data[4] = *(_OWORD *)&lastUsercmd[-1].sightedClientsMask.data[4];
      --v6;
    }
    while ( v6 );
    p_lastUsercmd->buttons = lastUsercmd->buttons;
    sv_demo.nextFramePos = sv_demo.nextLevelSave->nextFramePos;
    sv_demo.msg.readcount = sv_demo.nextLevelSave->msgReadcount;
    sv_demo.msg.bit = 8 * sv_demo.msg.readcount;
    sv_demo.readType = sv_demo.nextLevelSave->readType;
    if ( sv_demo.readType == 13 )
      SV_DemoSP_ReadNextDemoType();
  }
  else
  {
    *randomSeed = MSG_ReadLong(&sv_demo.msg);
    sv_serverId_value = MSG_ReadLong(&sv_demo.msg);
    Long = MSG_ReadLong(&sv_demo.msg);
    if ( Long != 32 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 1160, ASSERT_TYPE_ASSERT, "( count ) == ( MAX_TRANSIENT_SP_FASTFILES )", "%s == %s\n\t%i, %i", "count", "MAX_TRANSIENT_SP_FASTFILES", Long, 32) )
      __debugbreak();
    CL_TransientsSP_QueueUnloadAll();
    for ( i = 0; i < 0x20; ++i )
    {
      if ( MSG_ReadByte(&sv_demo.msg) )
        CL_TransientsSP_QueueLoad(i);
    }
    if ( s_demoSPReadTransientStateSync && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 1174, ASSERT_TYPE_ASSERT, "(!s_demoSPReadTransientStateSync)", (const char *)&queryFormat, "!s_demoSPReadTransientStateSync") )
      __debugbreak();
    s_demoSPReadTransientStateSync = 1;
    CL_TransientsSP_HardSyncNow();
    s_demoSPReadTransientStateSync = 0;
    sv_demo.nextFramePos = -1;
    SV_DemoSP_ReadNextDemoType();
    G_SaveSP_UpdateAllEntities();
  }
  if ( sv_demo.nextLevelTime )
  {
    v10 = sv_demo.nextLevelTime - G_Main_GetTime();
    nextLevelTime = 0;
    if ( v10 > 0 )
      nextLevelTime = sv_demo.nextLevelTime;
    sv_demo.forwardTime = nextLevelTime;
    sv_demo.nextLevelTime = 0;
  }
  ProfLoad_End();
}

/*
==============
SV_DemoSP_InitReadDemoSavegame
==============
*/
void SV_DemoSP_InitReadDemoSavegame(SaveGame **saveHandle)
{
  SaveGame *v2; 
  server_demo_save_t *p_save; 
  scrContext_t *i; 
  MemoryFile *MemoryFile; 
  int j; 
  int v7; 
  scrContext_t *k; 
  MemoryFile *v9; 
  const SaveHeader *Header; 
  const scrContext_t *v11; 
  int p; 
  int cheat_items_set2; 
  int cheat_items_set1; 

  if ( !saveHandle && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 1229, ASSERT_TYPE_ASSERT, "(saveHandle)", (const char *)&queryFormat, "saveHandle") )
    __debugbreak();
  if ( !sv_demo.nextLevelplaying && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 1230, ASSERT_TYPE_ASSERT, "(sv_demo.nextLevelplaying)", (const char *)&queryFormat, "sv_demo.nextLevelplaying") )
    __debugbreak();
  v2 = *saveHandle;
  if ( *saveHandle )
  {
    SV_DemoSP_TruncateHistoryTimeCache(0);
    g_numFileMarkSkips = 0;
    FS_FileSeek(g_fileMarkHistory, 0i64, 2);
  }
  else
  {
    if ( sv_demo.nextLevelSave )
    {
      p_save = &sv_demo.nextLevelSave->save;
    }
    else
    {
      p_save = &sv_demo.save;
      for ( i = ScriptContext_GetFirst(); i; i = ScriptContext_GetNext(i) )
        Scr_SetUseCodePosMap(i, 1);
    }
    if ( !p_save->buf && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 1257, ASSERT_TYPE_ASSERT, "(demosave->buf)", (const char *)&queryFormat, "demosave->buf") )
      __debugbreak();
    v2 = G_SaveMemorySP_GetSaveHandle(SAVE_LAST_COMMITTED);
    G_SaveMemory_InitializeLoadFromBuffer(v2, p_save->buf, p_save->bufLen, 0);
    MemoryFile = SaveMemory_GetMemoryFile(v2);
    Dvar_LoadDvars(MemoryFile);
    for ( j = 0; j < 8; ++j )
    {
      MemFile_ReadData(MemoryFile, 4ui64, &p);
      v7 = p;
      if ( p != j && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 1706, ASSERT_TYPE_ASSERT, "(cntrllrIndex == controllerIndex)", (const char *)&queryFormat, "cntrllrIndex == controllerIndex") )
        __debugbreak();
      MemFile_ReadData(MemoryFile, 4ui64, &cheat_items_set1);
      MemFile_ReadData(MemoryFile, 4ui64, &cheat_items_set2);
      GamerProfile_SetIntelligence(v7, cheat_items_set1, cheat_items_set2);
    }
    for ( k = ScriptContext_GetFirst(); k; k = ScriptContext_GetNext(k) )
      Scr_SkipSource(k, MemoryFile, MEMCARD_INVALID_FILE_HANDLE_2, 0);
  }
  v9 = SaveMemory_GetMemoryFile(v2);
  if ( MemFile_AtEnd(v9) )
  {
    MemFile_MoveToSegment(v9, -1, StreamModeSource_SPInitReadDemoSavegame);
    G_SaveMemorySP_FinalizeLoad(v2);
    *saveHandle = NULL;
  }
  else if ( !*saveHandle )
  {
    Header = G_SaveMemorySP_GetHeader(v2);
    v11 = ScriptContext_Server();
    Scr_GetChecksum(v11, Header->scrCheckSum);
    *saveHandle = v2;
  }
}

/*
==============
SV_DemoSP_InitSavegame
==============
*/
void SV_DemoSP_InitSavegame(SaveGame **save)
{
  if ( !save && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 1413, ASSERT_TYPE_ASSERT, "( save )", (const char *)&queryFormat, "save") )
    __debugbreak();
  if ( !SvDemo::ms_gServerDemoSystem && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 1414, ASSERT_TYPE_ASSERT, "( SvDemo::IsSystemEnabled() )", (const char *)&queryFormat, "SvDemo::IsSystemEnabled()") )
    __debugbreak();
  if ( sv_demo.nextLevelplaying )
  {
    SV_DemoSP_InitReadDemoSavegame(save);
  }
  else
  {
    sv_demo.nextLevelSave = NULL;
    if ( sv_demo.save.buf )
    {
      SV_DemoSP_HistoryFree(sv_demo.save.buf, sv_demo.save.bufLen);
      sv_demo.save.buf = NULL;
      sv_demo.save.bufLen = 0i64;
    }
    if ( !(unsigned int)SV_DemoSP_AddDemoSave(*save, &sv_demo.save, 0) && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 1428, ASSERT_TYPE_ASSERT, "(result)", (const char *)&queryFormat, "result") )
      __debugbreak();
  }
}

/*
==============
SV_DemoSP_InitSystem
==============
*/
void SV_DemoSP_InitSystem(__int64 a1, const char *a2)
{
  const char *v2; 

  if ( g_fileTimeHistory.handle != -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2737, ASSERT_TYPE_ASSERT, "(!g_fileTimeHistory)", (const char *)&queryFormat, "!g_fileTimeHistory") )
    __debugbreak();
  if ( g_fileMarkHistory.handle != -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2738, ASSERT_TYPE_ASSERT, "(!g_fileMarkHistory)", (const char *)&queryFormat, "!g_fileMarkHistory") )
    __debugbreak();
  g_fileTimeHistory.handle = (__int64)SV_DemoSP_OpenFile((sysFileHandle_t *)&stru_1444D59E8, a2);
  g_fileMarkHistory.handle = (__int64)SV_DemoSP_OpenFile((sysFileHandle_t *)&stru_1444D5A00, v2);
}

/*
==============
SV_DemoSP_IsInReadTransientStateSync
==============
*/
_BOOL8 SV_DemoSP_IsInReadTransientStateSync()
{
  return s_demoSPReadTransientStateSync;
}

/*
==============
SV_DemoSP_Live_f
==============
*/
void SV_DemoSP_Live_f(void)
{
  if ( sv_demo.playing )
    sv_demo.startLive = 1;
  else
    Com_Printf(0, "Not playing replay.\n");
}

/*
==============
SV_DemoSP_LoadDemo
==============
*/
void SV_DemoSP_LoadDemo(const SaveHeader *header, MemoryFile *memFile, MemCardFileHandle fileHandle)
{
  SvDemo *v6; 
  __int64 v7; 
  int v8; 
  int buffer; 

  SV_Demo_ResetDemo();
  sv_demo.changed = 0;
  if ( g_history )
  {
    SV_DemoSP_FreeHistoryData(g_history);
    g_history = NULL;
  }
  if ( sv_demo.msg.data )
  {
    sv_demo.msg.data = NULL;
    sv_demo.msg.maxsize = 0;
  }
  sv_demo.nextLevelplaying = 1;
  sv_demo.nextLevelSave = NULL;
  sv_demo.nextLevelTime = 0;
  ReadFromDevice(&sv_demo, 4ui64, fileHandle);
  ReadFromDevice(&sv_demo.endTime, 4ui64, fileHandle);
  ReadFromDevice(&buffer, 4ui64, fileHandle);
  if ( sv_demo.msg.data && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2546, ASSERT_TYPE_ASSERT, "(!sv_demo.msg.data)", (const char *)&queryFormat, "!sv_demo.msg.data") )
    __debugbreak();
  if ( !SV_DemoSP_MsgAlloc(buffer) )
  {
    v8 = 0x800000;
    LODWORD(v7) = buffer;
    Mem_Error_CannotAlloc_Dev(COUNT|DODGE|0x8, "SV_DemoSP_LoadDemo", "c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2549, "size=%d ServerDemoMessageSize=%d", v7, v8);
  }
  MSG_Init(&sv_demo.msg, sv_demo.msg.data, sv_demo.msg.maxsize);
  sv_demo.msg.cursize = buffer;
  ReadFromDevice(sv_demo.msg.data, buffer, fileHandle);
  if ( sv_demo.save.buf )
  {
    SV_DemoSP_HistoryFree(sv_demo.save.buf, sv_demo.save.bufLen);
    sv_demo.save.buf = NULL;
    sv_demo.save.bufLen = 0i64;
  }
  if ( !header->bodySize && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2558, ASSERT_TYPE_ASSERT, "(header->bodySize)", (const char *)&queryFormat, "header->bodySize") )
    __debugbreak();
  sv_demo.save.bufLen = header->bodySize;
  if ( (_BYTE)SvDemo::ms_allocatedType != HALF && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.h", 128, ASSERT_TYPE_ASSERT, "( ms_allocatedType == GameModeType::SP )", (const char *)&queryFormat, "ms_allocatedType == GameModeType::SP") )
    __debugbreak();
  v6 = SvDemo::ms_gServerDemoSystem;
  if ( sv_demo.save.buf && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2564, ASSERT_TYPE_ASSERT, "(!sv_demo.save.buf)", (const char *)&queryFormat, "!sv_demo.save.buf") )
    __debugbreak();
  if ( !(unsigned int)SV_DemoSP_HistoryAlloc((server_demo_history_t *)&v6[1577989], &sv_demo.save.buf, sv_demo.save.bufLen) )
    Mem_Error_CannotAlloc_Dev(COUNT|DODGE|0x8, "SV_DemoSP_LoadDemo", "c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2567, "sv_demo.save.bufLen=%zu", sv_demo.save.bufLen);
  MemFile_CopySegments(memFile, 0, sv_demo.save.buf);
}

/*
==============
SV_DemoSP_LoadHistory
==============
*/
char SV_DemoSP_LoadHistory(sysFileHandle_t fileHistory, const __int64 fileOffset)
{
  server_demo_history_t *v5; 
  unsigned __int64 bufLen; 

  if ( fileHistory.handle == -1 )
    return 0;
  while ( g_historySaving )
    Sys_Sleep(1);
  if ( FS_FileSeek(fileHistory, fileOffset, 2) )
  {
    Com_PrintError(1, &stru_1440E06D8.buildNumber[112]);
    return 0;
  }
  SV_DemoSP_FreeHistoryData(g_history);
  v5 = g_history;
  if ( !g_history && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2987, ASSERT_TYPE_ASSERT, "(history)", (const char *)&queryFormat, "history") )
    __debugbreak();
  if ( FS_FileRead(v5, 0xCED0ui64, fileHistory) != 52944 )
  {
    Com_PrintError(1, "SV_DemoRead: read failed\n");
LABEL_11:
    memset_0(v5, 0, sizeof(server_demo_history_t));
    return 0;
  }
  bufLen = v5->save.bufLen;
  if ( !bufLen || !SV_DemoSP_AllocRead(v5, &v5->save.buf, bufLen, fileHistory) || v5->freeEntBufLen <= 0 || !SV_DemoSP_AllocRead(v5, &v5->freeEntBuf, v5->freeEntBufLen, fileHistory) )
    goto LABEL_11;
  return 1;
}

/*
==============
SV_DemoSP_LoadHistoryForTime
==============
*/
void SV_DemoSP_LoadHistoryForTime(const int time)
{
  int v2; 
  FileSkip *v3; 
  __int64 v4; 

  SV_DemoSP_GetBuffer();
  SV_Demo_WaitForSaveHistoryDone();
  v2 = 0;
  if ( g_numFileSkips > 0 )
  {
    v3 = g_fileSkips;
    do
    {
      if ( v3->time > time )
        break;
      ++v2;
      ++v3;
    }
    while ( v2 < g_numFileSkips );
  }
  if ( !v2 )
    goto LABEL_13;
  if ( v2 - 1 >= g_numFileSkips && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 3049, ASSERT_TYPE_ASSERT, "(fileSkipIndex < g_numFileSkips)", (const char *)&queryFormat, "fileSkipIndex < g_numFileSkips") )
    __debugbreak();
  v4 = v2 == 1 ? 0i64 : g_fileSkips[v2 - 2].fileEndOffset;
  if ( !SV_DemoSP_LoadHistory(g_fileTimeHistory, v4) )
  {
LABEL_13:
    if ( g_history )
    {
      SV_DemoSP_FreeHistoryData(g_history);
      g_history = NULL;
    }
  }
}

/*
==============
SV_DemoSP_Mark_f
==============
*/
void SV_DemoSP_Mark_f(void)
{
  const char *v0; 
  __int64 v1; 

  if ( sv_demo.msg.data )
  {
    if ( sv_demo.playing || sv_demo.recording )
    {
      if ( ((unsigned __int64)&g_serverThreadOwnership & 3) != 0 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\qcommon\\threads_interlock_pc.h", 37, ASSERT_TYPE_ASSERT, "( ( IsAligned( addend, sizeof( volatile_int32 ) ) ) )", "( addend ) = %p", &g_serverThreadOwnership) )
        __debugbreak();
      if ( _InterlockedIncrement(&g_serverThreadOwnership) != 1 )
      {
        LODWORD(v1) = g_serverThreadOwnership;
        if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2946, ASSERT_TYPE_ASSERT, "( ( Sys_InterlockedIncrement( (volatile_int32 *)&g_serverThreadOwnership ) == 1 ) )", "( g_serverThreadOwnership ) = %i", v1) )
          __debugbreak();
      }
      if ( SV_Cmd_Argc() <= 1 )
        v0 = (char *)&queryFormat.fmt + 3;
      else
        v0 = SV_Cmd_Argv(1);
      SV_DemoSP_GetBuffer();
      SV_Demo_WaitForSaveHistoryDone();
      g_history->manual = 1;
      Core_strcpy(g_history->name, 0x40ui64, v0);
      SV_DemoSP_FreeHistoryData(g_history);
      if ( !(unsigned int)SV_DemoSP_DemoSaveHistory(g_history) && g_history )
      {
        SV_DemoSP_FreeHistoryData(g_history);
        g_history = NULL;
      }
      if ( ((unsigned __int64)&g_serverThreadOwnership & 3) != 0 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\qcommon\\threads_interlock_pc.h", 44, ASSERT_TYPE_ASSERT, "( ( IsAligned( addend, sizeof( volatile_int32 ) ) ) )", "( addend ) = %p", &g_serverThreadOwnership) )
        __debugbreak();
      if ( _InterlockedExchangeAdd(&g_serverThreadOwnership, 0xFFFFFFFF) != 1 )
      {
        LODWORD(v1) = g_serverThreadOwnership;
        if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2955, ASSERT_TYPE_ASSERT, "( ( Sys_InterlockedDecrement( (volatile_int32 *)&g_serverThreadOwnership ) == 0 ) )", "( g_serverThreadOwnership ) = %i", v1) )
          __debugbreak();
      }
    }
    else
    {
      Com_Printf(0, "Past end of replay.\n");
    }
  }
  else
  {
    Com_Printf(0, "No replay.\n");
  }
}

/*
==============
SV_DemoSP_MsgAlloc
==============
*/
char SV_DemoSP_MsgAlloc(unsigned int maxsize)
{
  SvDemo_vtbl *v1; 

  v1 = (SvDemo_vtbl *)maxsize;
  if ( sv_demo.msg.data && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 300, ASSERT_TYPE_ASSERT, "(!sv_demo.msg.data)", (const char *)&queryFormat, "!sv_demo.msg.data") )
    __debugbreak();
  if ( (_BYTE)SvDemo::ms_allocatedType != HALF && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.h", 128, ASSERT_TYPE_ASSERT, "( ms_allocatedType == GameModeType::SP )", (const char *)&queryFormat, "ms_allocatedType == GameModeType::SP") )
    __debugbreak();
  if ( v1 > SvDemo::ms_gServerDemoSystem[2].__vftable )
    return 0;
  sv_demo.msg.data = (unsigned __int8 *)SvDemo::ms_gServerDemoSystem[1].__vftable;
  sv_demo.msg.maxsize = truncate_cast<int,unsigned __int64>((unsigned __int64)SvDemo::ms_gServerDemoSystem[2].__vftable);
  memset_0(sv_demo.msg.data, 0, sv_demo.msg.maxsize);
  return 1;
}

/*
==============
SV_DemoSP_OpenFile
==============
*/
sysFileHandle_t *SV_DemoSP_OpenFile(sysFileHandle_t *result, const char *fileName)
{
  const char *DevHddPath; 
  const char *v4; 
  char ospath[256]; 

  DevHddPath = Sys_GetDevHddPath();
  FS_BuildOSPath(DevHddPath, (const char *)&queryFormat.fmt + 3, (const char *)result, (char (*)[256])ospath);
  if ( !FS_CreatePath(ospath) )
    return FS_FileOpenWriteReadBinary((sysFileHandle_t *)ospath, v4);
  Com_PrintError(1, "Failed to create path '%s'\n", ospath);
  return (sysFileHandle_t *)INVALID_SYS_FILE_HANDLE_2.handle;
}

/*
==============
SV_DemoSP_ReadDvarPacket
==============
*/
void SV_DemoSP_ReadDvarPacket(int framePos)
{
  bool playing; 
  const char *v3; 
  const char *v4; 
  unsigned int Long; 
  const dvar_t *VarByChecksum; 
  const char *v7; 
  char string[1024]; 

  playing = sv_demo.playing;
  if ( sv_demo.playing && framePos == sv_demo.nextFramePos )
  {
    while ( 1 )
    {
      if ( !playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 1541, ASSERT_TYPE_ASSERT, "(sv_demo.playing)", (const char *)&queryFormat, "sv_demo.playing") )
        __debugbreak();
      if ( sv_demo.readType == 10 )
      {
        Long = MSG_ReadLong(&sv_demo.msg);
        VarByChecksum = Dvar_FindVarByChecksum(Long);
        if ( VarByChecksum )
        {
          if ( MSG_ReadString(&sv_demo.msg, string, 0x400u) )
          {
            SV_DemoSP_ReadNextDemoType();
            Dvar_SetFromString(VarByChecksum, string);
          }
          else
          {
            SV_DemoSP_EndDemo("SV_ReadDvarPacket() svd_setDvarString somehow got a NULL string when parsing sv_demo.msg the second time");
          }
        }
        else
        {
          v7 = j_va("SV_ReadDvarPacket() could not find a dvar named '%s'", string);
          SV_DemoSP_EndDemo(v7);
        }
      }
      else
      {
        v3 = sv_demo.readType > 0x19u ? j_va("invalid:%i", sv_demo.readType) : s_svdDemoTypeNames[sv_demo.readType];
        v4 = j_va("SV_ReadDvarPacket(): Invalid sv_demo.readType: '%s'", v3);
        SV_DemoSP_EndDemo(v4);
      }
      if ( framePos != sv_demo.nextFramePos )
        break;
      playing = sv_demo.playing;
    }
  }
}

/*
==============
SV_DemoSP_ReadNextDemoType
==============
*/
void SV_DemoSP_ReadNextDemoType()
{
  unsigned int Byte; 
  const char *v1; 
  const char *v2; 

  if ( !sv_demo.playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 738, ASSERT_TYPE_ASSERT, "(sv_demo.playing)", (const char *)&queryFormat, "sv_demo.playing") )
    __debugbreak();
  if ( sv_demo.recording && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 739, ASSERT_TYPE_ASSERT, "(!sv_demo.recording)", (const char *)&queryFormat, "!sv_demo.recording") )
    __debugbreak();
  if ( sv_demo.startLive )
  {
LABEL_16:
    SV_DemoSP_EndDemo(NULL);
  }
  else
  {
    Byte = MSG_ReadByte(&sv_demo.msg);
    sv_demo.readType = Byte;
    switch ( Byte )
    {
      case 0u:
      case 2u:
      case 0xAu:
        sv_demo.nextFramePos = MSG_ReadLong(&sv_demo.msg);
        break;
      case 1u:
      case 3u:
      case 4u:
      case 5u:
      case 6u:
      case 7u:
      case 8u:
      case 9u:
      case 0xBu:
      case 0xCu:
      case 0xEu:
      case 0xFu:
      case 0x10u:
      case 0x11u:
      case 0x12u:
      case 0x13u:
      case 0x14u:
      case 0x15u:
      case 0x16u:
      case 0x17u:
      case 0x18u:
      case 0x19u:
        sv_demo.nextFramePos = -1;
        break;
      default:
        if ( Byte == -1 )
          goto LABEL_16;
        if ( Byte > 0x19 )
          v1 = j_va("invalid:%i", Byte);
        else
          v1 = s_svdDemoTypeNames[Byte];
        v2 = j_va("SV_DemoSP_ReadNextDemoType() Invalid sv_demo.readType: '%s'", v1);
        SV_DemoSP_EndDemo(v2);
        break;
    }
  }
}

/*
==============
SV_DemoSP_ReadPacket
==============
*/
void SV_DemoSP_ReadPacket(int framePos)
{
  SvGameModeApplication *ActiveServerApplication; 
  const char *v3; 
  const char *v4; 
  int Byte; 
  LocalClientNum_t v6; 
  SvClient *CommonClient; 
  int v8; 
  unsigned __int8 v9; 
  msg_t buf; 
  usercmd_s to; 
  char string[1024]; 
  unsigned __int8 data[2480]; 

  if ( sv_demo.playing )
  {
    ActiveServerApplication = SvGameModeApplication::GetActiveServerApplication();
    while ( framePos == sv_demo.nextFramePos )
    {
      if ( !sv_demo.playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 1476, ASSERT_TYPE_ASSERT, "(sv_demo.playing)", (const char *)&queryFormat, "sv_demo.playing") )
        __debugbreak();
      if ( sv_demo.readType )
      {
        if ( sv_demo.readType == 2 )
        {
          Byte = MSG_ReadByte(&sv_demo.msg);
          if ( MSG_ReadString(&sv_demo.msg, string, 0x400u) )
          {
            SV_DemoSP_ReadNextDemoType();
            SV_ClientSP_ExecuteCommand(Byte, string);
            CL_InputSP_ClearClientCommandPacket((LocalClientNum_t)Byte);
          }
          else
          {
            SV_DemoSP_EndDemo("SV_ReadPacket() svd_serverCommand somehow got a NULL string when parsing sv_demo.msg");
          }
        }
        else
        {
          if ( sv_demo.readType > 0x19u )
            v3 = j_va("invalid:%i", sv_demo.readType);
          else
            v3 = s_svdDemoTypeNames[sv_demo.readType];
          v4 = j_va("SV_ReadPacket(): Invalid sv_demo.readType: '%s'", v3);
          SV_DemoSP_EndDemo(v4);
        }
      }
      else
      {
        v6 = MSG_ReadByte(&sv_demo.msg);
        if ( (_BYTE)SvClient::ms_allocatedType != HALF && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_client_sp.h", 83, ASSERT_TYPE_ASSERT, "( ms_allocatedType == ALLOCATION_TYPE )", (const char *)&queryFormat, "ms_allocatedType == ALLOCATION_TYPE") )
          __debugbreak();
        CommonClient = SvClient::GetCommonClient(v6);
        MSG_Init(&buf, data, 2474);
        buf.cursize = MSG_ReadShort(&sv_demo.msg);
        MSG_ReadData(&sv_demo.msg, buf.cursize, buf.data, buf.maxsize);
        MSG_ReadDeltaUsercmd(&buf, &CommonClient->lastUsercmd, &to);
        SV_DemoSP_ReadNextDemoType();
        SV_ClientSP_Think(v6, &to, 0);
        if ( !ActiveServerApplication->m_frameDuration && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server\\sv_gamemode_app.h", 162, ASSERT_TYPE_ASSERT, "(m_frameDuration > 0)", "%s\n\tFrame duration has not been initialized", "m_frameDuration > 0") )
          __debugbreak();
        v8 = to.serverTime % (signed int)ActiveServerApplication->m_frameDuration;
        v9 = v8;
        if ( (v8 < 0 || (unsigned int)v8 > 0xFF) && CoreAssert_Handler("c:\\workspace\\iw8\\shared\\codware\\core\\core_assert.h", 385, ASSERT_TYPE_ASSERT, (const char *)&queryFormat.fmt + 3, "%s (SmallType) %s 0x%jx == (BigType) %s 0x%jx", "unsigned char __cdecl truncate_cast_impl<unsigned char,int>(int)", "unsigned", (unsigned __int8)v8, "signed", v8) )
          __debugbreak();
        sv_demo.residualTime = v9;
        CL_InputSP_ClearClientThinkPacket(v6, &to);
      }
    }
  }
}

/*
==============
SV_DemoSP_RecordButtonPressed
==============
*/
void SV_DemoSP_RecordButtonPressed(int buttonPressed)
{
  __int64 v1; 

  v1 = buttonPressed;
  if ( sv_demo.recording )
  {
    SV_DemoSP_CheckSize();
    MSG_WriteByte(&sv_demo.msg, 12i64);
    MSG_WriteByte(&sv_demo.msg, v1);
  }
}

/*
==============
SV_DemoSP_RecordCinematicGetFrame
==============
*/
void SV_DemoSP_RecordCinematicGetFrame(int frame)
{
  if ( sv_demo.recording )
  {
    SV_DemoSP_CheckSize();
    MSG_WriteByte(&sv_demo.msg, 21i64);
    MSG_WriteLong(&sv_demo.msg, frame);
  }
}

/*
==============
SV_DemoSP_RecordCinematicGetTimeInMsec
==============
*/
void SV_DemoSP_RecordCinematicGetTimeInMsec(int timeMsec)
{
  if ( sv_demo.recording )
  {
    SV_DemoSP_CheckSize();
    MSG_WriteByte(&sv_demo.msg, 22i64);
    MSG_WriteLong(&sv_demo.msg, timeMsec);
  }
}

/*
==============
SV_DemoSP_RecordClientCommand
==============
*/
void SV_DemoSP_RecordClientCommand(int clientNum, const char *s)
{
  __int64 v3; 
  int FramePos; 

  v3 = clientNum;
  if ( sv_demo.recording )
  {
    SV_DemoSP_CheckSize();
    MSG_WriteByte(&sv_demo.msg, 2i64);
    FramePos = G_MainSP_GetFramePos();
    MSG_WriteLong(&sv_demo.msg, FramePos);
    MSG_WriteByte(&sv_demo.msg, v3);
    MSG_WriteString(&sv_demo.msg, s);
  }
}

/*
==============
SV_DemoSP_RecordClientThink
==============
*/
void SV_DemoSP_RecordClientThink(int clientNum, usercmd_s *cmd)
{
  __int64 v3; 
  int FramePos; 
  SvClient *CommonClient; 
  msg_t buf; 
  unsigned __int8 data[2480]; 

  v3 = clientNum;
  if ( sv_demo.recording )
  {
    SV_DemoSP_CheckSize();
    if ( !cmd && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 1607, ASSERT_TYPE_ASSERT, "( cmd )", (const char *)&queryFormat, "cmd") )
      __debugbreak();
    MSG_WriteByte(&sv_demo.msg, 0i64);
    FramePos = G_MainSP_GetFramePos();
    MSG_WriteLong(&sv_demo.msg, FramePos);
    MSG_WriteByte(&sv_demo.msg, v3);
    if ( (_BYTE)SvClient::ms_allocatedType != HALF && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_client_sp.h", 83, ASSERT_TYPE_ASSERT, "( ms_allocatedType == ALLOCATION_TYPE )", (const char *)&queryFormat, "ms_allocatedType == ALLOCATION_TYPE") )
      __debugbreak();
    CommonClient = SvClient::GetCommonClient(v3);
    MSG_Init(&buf, data, 2474);
    MSG_WriteDeltaUsercmd(&buf, &CommonClient->lastUsercmd, cmd);
    MSG_WriteShort(&sv_demo.msg, buf.cursize);
    MSG_WriteData(&sv_demo.msg, data, buf.cursize);
  }
}

/*
==============
SV_DemoSP_RecordCorpseOrigins
==============
*/
void SV_DemoSP_RecordCorpseOrigins(void)
{
  __int64 v0; 
  vec3_t *p_physicsOrigin; 

  if ( sv_demo.recording )
  {
    SV_DemoSP_CheckSize();
    MSG_WriteByte(&sv_demo.msg, 24i64);
    v0 = 28i64;
    p_physicsOrigin = &GameScriptDataSP::GetGameScriptDataSP()->actorCorpseInfo[0].physicsOrigin;
    do
    {
      MSG_WriteVec3(&sv_demo.msg, p_physicsOrigin);
      p_physicsOrigin += 4;
      --v0;
    }
    while ( v0 );
  }
}

/*
==============
SV_DemoSP_RecordFxVisibility
==============
*/
void SV_DemoSP_RecordFxVisibility(float visibility)
{
  if ( sv_demo.recording )
  {
    SV_DemoSP_CheckSize();
    MSG_WriteByte(&sv_demo.msg, 1i64);
    MSG_WriteFloat(&sv_demo.msg, visibility);
  }
}

/*
==============
SV_DemoSP_RecordIntelligence
==============
*/
void SV_DemoSP_RecordIntelligence(int controllerIndex, int *cheat_items_set1, int *cheat_items_set2)
{
  int v6; 
  int v7; 
  int Long; 
  const char *v9; 
  const char *v10; 

  if ( SV_IsDemoPlaying() )
  {
    Long = 0;
    if ( !sv_demo.playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 1647, ASSERT_TYPE_ASSERT, "(sv_demo.playing)", (const char *)&queryFormat, "sv_demo.playing") )
      __debugbreak();
    if ( sv_demo.readType == 17 )
    {
      Long = MSG_ReadLong(&sv_demo.msg);
      *cheat_items_set1 = MSG_ReadLong(&sv_demo.msg);
      *cheat_items_set2 = MSG_ReadLong(&sv_demo.msg);
      SV_DemoSP_ReadNextDemoType();
    }
    else
    {
      if ( sv_demo.readType > 0x19u )
        v9 = j_va("invalid:%i", sv_demo.readType);
      else
        v9 = s_svdDemoTypeNames[sv_demo.readType];
      v10 = j_va("SV_DemoSetIntelligence(): Invalid sv_demo.readType: '%s'", v9);
      SV_DemoSP_EndDemo(v10);
    }
    if ( Long != controllerIndex && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 1676, ASSERT_TYPE_ASSERT, "(ctrllrIndex == controllerIndex)", (const char *)&queryFormat, "ctrllrIndex == controllerIndex") )
      __debugbreak();
  }
  else
  {
    v6 = *cheat_items_set2;
    v7 = *cheat_items_set1;
    if ( sv_demo.recording )
    {
      SV_DemoSP_CheckSize();
      MSG_WriteByte(&sv_demo.msg, 17i64);
      MSG_WriteLong(&sv_demo.msg, controllerIndex);
      MSG_WriteLong(&sv_demo.msg, v7);
      MSG_WriteLong(&sv_demo.msg, v6);
    }
  }
}

/*
==============
SV_DemoSP_RecordIsCinematicLoaded
==============
*/
void SV_DemoSP_RecordIsCinematicLoaded(bool isCinematicLoaded)
{
  if ( sv_demo.recording )
  {
    SV_DemoSP_CheckSize();
    MSG_WriteByte(&sv_demo.msg, 20i64);
    MSG_WriteByte(&sv_demo.msg, isCinematicLoaded);
  }
}

/*
==============
SV_DemoSP_RecordIsCinematicPlaying
==============
*/
void SV_DemoSP_RecordIsCinematicPlaying(bool isCinematicPlaying)
{
  if ( sv_demo.recording )
  {
    SV_DemoSP_CheckSize();
    MSG_WriteByte(&sv_demo.msg, 16i64);
    MSG_WriteByte(&sv_demo.msg, isCinematicPlaying);
  }
}

/*
==============
SV_DemoSP_RecordIsRecentlyLoaded
==============
*/
void SV_DemoSP_RecordIsRecentlyLoaded(bool isRecentlyLoaded)
{
  if ( sv_demo.recording )
  {
    SV_DemoSP_CheckSize();
    MSG_WriteByte(&sv_demo.msg, 14i64);
    MSG_WriteByte(&sv_demo.msg, isRecentlyLoaded);
  }
}

/*
==============
SV_DemoSP_RecordPreloadZonesState
==============
*/
void SV_DemoSP_RecordPreloadZonesState(bool loadComplete)
{
  if ( sv_demo.recording )
  {
    SV_DemoSP_CheckSize();
    MSG_WriteByte(&sv_demo.msg, 23i64);
    MSG_WriteByte(&sv_demo.msg, loadComplete);
  }
}

/*
==============
SV_DemoSP_RecordSaveCommitWouldBeValid
==============
*/
void SV_DemoSP_RecordSaveCommitWouldBeValid(bool saveCommitWouldBeValid)
{
  if ( sv_demo.recording )
  {
    SV_DemoSP_CheckSize();
    MSG_WriteByte(&sv_demo.msg, 18i64);
    MSG_WriteByte(&sv_demo.msg, saveCommitWouldBeValid);
  }
}

/*
==============
SV_DemoSP_RecordTimeSincePaused
==============
*/
void SV_DemoSP_RecordTimeSincePaused(int timeSincePaused)
{
  if ( sv_demo.recording )
  {
    SV_DemoSP_CheckSize();
    MSG_WriteByte(&sv_demo.msg, 15i64);
    MSG_WriteLong(&sv_demo.msg, timeSincePaused);
  }
}

/*
==============
SV_DemoSP_RecordTransientState
==============
*/
void SV_DemoSP_RecordTransientState(int syncType)
{
  if ( sv_demo.recording )
  {
    SV_DemoSP_CheckSize();
    MSG_WriteByte(&sv_demo.msg, 19i64);
    MSG_WriteLong(&sv_demo.msg, syncType);
  }
}

/*
==============
SV_DemoSP_Restart
==============
*/
void SV_DemoSP_Restart()
{
  if ( !sv_demo.msg.data && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2502, ASSERT_TYPE_ASSERT, "(sv_demo.msg.data)", (const char *)&queryFormat, "sv_demo.msg.data") )
    __debugbreak();
  Com_SyncThreads();
  SV_Demo_ResetDemo();
  sv_demo.nextLevelplaying = 1;
  SV_CmdsSP_RequestMapRestart(0);
}

/*
==============
SV_DemoSP_Restart_f
==============
*/
void SV_DemoSP_Restart_f(void)
{
  if ( sv_demo.msg.data )
  {
    sv_demo.nextLevelSave = NULL;
    SV_DemoSP_Restart();
  }
  else
  {
    Com_Printf(0, "No replay.\n");
  }
}

/*
==============
SV_DemoSP_SaveDemo
==============
*/
void SV_DemoSP_SaveDemo(const char *demoName, const char *description, SaveType saveType)
{
  unsigned __int64 v3; 
  const char *v6; 
  SvGameGlobalsSP *SvGameGlobalsSP; 
  SaveHeader v8; 

  v3 = (unsigned __int64)&v8 & 0xFFFFFFFFFFFFFF80ui64;
  v6 = demoName;
  if ( sv_demo.msg.data )
  {
    if ( sv_demo.save.bufLen )
    {
      sv_demo.changed = 0;
      if ( !demoName )
      {
        SV_DemoSP_GetFreeDemoName("replay", 50, (char *)(v3 + 1152));
        v6 = (const char *)(v3 + 1152);
      }
      memset_0((void *)((unsigned __int64)&v8 & 0xFFFFFFFFFFFFFF80ui64), 0, 0x480ui64);
      SV_DemoSP_SaveMemory_InitializeDemoSave((MemoryFile *)(v3 + 896));
      MemFile_StartSegment((MemoryFile *)(v3 + 896), -1, StreamModeSource_DemoSPSaveDemo);
      if ( !*(_BYTE *)(((unsigned __int64)&v8 & 0xFFFFFFFFFFFFFF80ui64) + 0x425) )
      {
        if ( !sv_demo.save.bufLen && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2403, ASSERT_TYPE_ASSERT, "(sv_demo.save.bufLen)", (const char *)&queryFormat, "sv_demo.save.bufLen") )
          __debugbreak();
        if ( !sv_demo.save.buf && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2404, ASSERT_TYPE_ASSERT, "(sv_demo.save.buf)", (const char *)&queryFormat, "sv_demo.save.buf") )
          __debugbreak();
        MemFile_CommonInit((MemoryFile *)(v3 + 896), sv_demo.save.bufLen, sv_demo.save.buf, 0, 1);
        if ( BuildCleanSavePath((char *)(v3 + 1216), 0x40ui64, v6, saveType) )
        {
          SvGameGlobalsSP = SvGameGlobalsSP::GetSvGameGlobalsSP();
          G_SaveMemorySP_CreateHeaderInternal((const char *)(v3 + 1216), description, NULL, SvGameGlobalsSP->mapcrc, 1, 0, saveType, 0, (SaveHeader *)((unsigned __int64)&v8 & 0xFFFFFFFFFFFFFF80ui64), (MemoryFile *)(v3 + 896));
          MemCard_PushUseDevDrive(1);
          *(_BYTE *)(((unsigned __int64)&v8 & 0xFFFFFFFFFFFFFF80ui64) + 0x434) = 0;
          if ( SaveMemory_WriteSaveToDeviceInternal((SaveGame *)((unsigned __int64)&v8 & 0xFFFFFFFFFFFFFF80ui64)) )
            Com_PrintWarning(10, "There was an error trying to write demo file \"%s\".", (const char *)(v3 + 584));
          MemCard_PopUseDevDrive();
        }
      }
    }
    else
    {
      Com_Printf(15, "Replay start failed to save.\n");
    }
  }
  else
  {
    Com_Printf(15, "No replay.\n");
  }
}

/*
==============
SV_DemoSP_SaveHistory
==============
*/
void SV_DemoSP_SaveHistory(server_demo_history_t *history)
{
  FileMarkSkip *MarkSkip; 
  unsigned __int64 v3; 
  int time; 
  __int64 v5; 
  __int64 v6; 

  Profile_Begin(543);
  if ( !history->manual )
  {
    if ( g_fileTimeHistory.handle != -1 )
    {
      if ( history->freeEntBufLen < 0 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2644, ASSERT_TYPE_ASSERT, "(history->freeEntBufLen >= 0)", (const char *)&queryFormat, "history->freeEntBufLen >= 0") )
        __debugbreak();
      if ( g_numFileSkips == 3600 || (v3 = history->save.bufLen + history->freeEntBufLen + 52944, g_writtenFileTimeHistory >= (__int64)(0x7FFFFFFFFFFFFFFFi64 - v3)) )
      {
        Com_PrintWarning(15, "Failed to save demo history.  Disabling autosave.\n");
        Dvar_SetInt_Internal(DVARINT_replay_autosave, 0);
      }
      else
      {
        if ( g_numFileSkips && g_fileSkips[g_numFileSkips - 1].time >= history->time && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2672, ASSERT_TYPE_ASSERT, "(g_numFileSkips == 0 || g_fileSkips[g_numFileSkips - 1].time < history->time)", (const char *)&queryFormat, "g_numFileSkips == 0 || g_fileSkips[g_numFileSkips - 1].time < history->time") )
          __debugbreak();
        if ( !SV_DemoSP_WriteHistory(g_fileTimeHistory, history) )
          Com_PrintError(1, "Failed to save demo history.\n");
        time = history->time;
        g_writtenFileTimeHistory += v3;
        g_fileSkips[g_numFileSkips].time = time;
        v5 = FS_FileTell(g_fileTimeHistory);
        v6 = g_numFileSkips++;
        g_fileSkips[v6].fileEndOffset = v5;
      }
      goto LABEL_24;
    }
LABEL_10:
    Com_PrintError(1, "Failed to open demo cache file.\n");
    goto LABEL_24;
  }
  if ( g_fileMarkHistory.handle == -1 )
    goto LABEL_10;
  MarkSkip = SV_DemoSP_FindMarkSkip(history->name);
  if ( !MarkSkip )
  {
    if ( g_numFileMarkSkips == 50 )
    {
      Com_PrintError(1, "Out of mark slots.\n");
      goto LABEL_24;
    }
    MarkSkip = &g_fileMarkSkips[g_numFileMarkSkips];
    Core_strcpy(MarkSkip->name, 0x40ui64, history->name);
    ++g_numFileMarkSkips;
  }
  MarkSkip->fileOffset = FS_FileTell(g_fileMarkHistory);
  if ( !SV_DemoSP_WriteHistory(g_fileMarkHistory, history) )
  {
    Com_PrintError(1, "Failed to save demo history.\n");
    MarkSkip->name[0] = 0;
  }
LABEL_24:
  Profile_EndInternal(NULL);
}

/*
==============
SV_DemoSP_SaveMemory_InitializeDemoSave
==============
*/
void SV_DemoSP_SaveMemory_InitializeDemoSave(MemoryFile *memFile)
{
  if ( !memFile && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 906, ASSERT_TYPE_ASSERT, "(memFile)", (const char *)&queryFormat, "memFile") )
    __debugbreak();
  if ( (_BYTE)GSaveMemory::ms_allocatedType != HALF && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\game_sp\\g_savememory_sp.h", 131, ASSERT_TYPE_ASSERT, "( ms_allocatedType == ALLOCATION_TYPE )", (const char *)&queryFormat, "ms_allocatedType == ALLOCATION_TYPE") )
    __debugbreak();
  if ( !GSaveMemory::ms_gSaveMemory && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\game\\savememory.h", 199, ASSERT_TYPE_ASSERT, "( ms_gSaveMemory )", (const char *)&queryFormat, "ms_gSaveMemory") )
    __debugbreak();
  MemFile_InitForWriting(memFile, 0x600000ui64, &GSaveMemory::ms_gSaveMemory[1573168], 0, 0, StreamModeSource_SPInitializeDemoSave);
}

/*
==============
SV_DemoSP_Save_f
==============
*/
void SV_DemoSP_Save_f(void)
{
  const char *v0; 
  __int64 v1; 

  if ( SV_Cmd_Argc() <= 2 )
  {
    if ( ((unsigned __int8)&g_serverThreadOwnership & 3) != 0 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\qcommon\\threads_interlock_pc.h", 37, ASSERT_TYPE_ASSERT, "( ( IsAligned( addend, sizeof( volatile_int32 ) ) ) )", "( addend ) = %p", &g_serverThreadOwnership) )
      __debugbreak();
    if ( _InterlockedIncrement(&g_serverThreadOwnership) != 1 )
    {
      LODWORD(v1) = g_serverThreadOwnership;
      if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2491, ASSERT_TYPE_ASSERT, "( ( Sys_InterlockedIncrement( (volatile_int32 *)&g_serverThreadOwnership ) == 1 ) )", "( g_serverThreadOwnership ) = %i", v1) )
        __debugbreak();
    }
    if ( SV_Cmd_Argc() == 2 )
      v0 = SV_Cmd_Argv(1);
    else
      v0 = NULL;
    SV_DemoSP_SaveDemo(v0, "replay_save", SAVE_TYPE_CONSOLE);
    if ( ((unsigned __int64)&g_serverThreadOwnership & 3) != 0 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\qcommon\\threads_interlock_pc.h", 44, ASSERT_TYPE_ASSERT, "( ( IsAligned( addend, sizeof( volatile_int32 ) ) ) )", "( addend ) = %p", &g_serverThreadOwnership) )
      __debugbreak();
    if ( _InterlockedExchangeAdd(&g_serverThreadOwnership, 0xFFFFFFFF) != 1 )
    {
      LODWORD(v1) = g_serverThreadOwnership;
      if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2496, ASSERT_TYPE_ASSERT, "( ( Sys_InterlockedDecrement( (volatile_int32 *)&g_serverThreadOwnership ) == 0 ) )", "( g_serverThreadOwnership ) = %i", v1) )
        __debugbreak();
    }
  }
  else
  {
    Com_Printf(0, &stru_1440E06D8.description[184]);
  }
}

/*
==============
SV_DemoSP_SetMsecTime
==============
*/
void SV_DemoSP_SetMsecTime(int time)
{
  const char *v1; 
  int v2; 
  int v3; 
  scrContext_t *v4; 

  v1 = j_va("replay_setmsectime %d", (unsigned int)time);
  Sys_EnterCriticalSection(CRITSECT_CBUF);
  v2 = strlen_noncrt(v1);
  v3 = v2;
  if ( s_cmd_textArray[0].cmdsize + v2 < s_cmd_textArray[0].maxsize )
  {
    memcpy_noncrt(&s_cmd_textArray[0].data[s_cmd_textArray[0].cmdsize], v1, v2 + 1);
    s_cmd_textArray[0].cmdsize += v3;
    v4 = ScriptContext_Server();
    Scr_MonitorCommand(v4, v1);
  }
  else
  {
    Com_Printf(16, "Cbuf_AddText: overflow (adding '%s')\n", v1);
  }
  Sys_LeaveCriticalSection(CRITSECT_CBUF);
}

/*
==============
SV_DemoSP_SetMsecTime_f
==============
*/

void __fastcall SV_DemoSP_SetMsecTime_f(double _XMM0_8)
{
  SvGameModeApplication *ActiveServerApplication; 
  const char *v3; 

  if ( !sv_demo.msg.data )
  {
    Com_Printf(0, "No replay.\n");
    return;
  }
  if ( sv_demo.forwardTime )
  {
    Com_Printf(0, "replay_back ignored.\n");
    return;
  }
  if ( SV_Cmd_Argc() > 1 )
  {
    v3 = SV_Cmd_Argv(1);
    _XMM0_8 = atof(v3);
    __asm { vcvttsd2si ebx, xmm0 }
    if ( _EBX <= 0 )
    {
      Com_Printf(0, "SV_DemoSP_SetMsecTime_f: Can't use negative numbers or 0.\n");
      return;
    }
  }
  else
  {
    _EBX = 0;
  }
  if ( SvGameModeApplication::HasActiveServerApplication() )
  {
    ActiveServerApplication = SvGameModeApplication::GetActiveServerApplication();
    _EBX -= _EBX % SvGameModeApplication::GetFrameDuration(ActiveServerApplication);
  }
  SV_DemoSP_LoadHistoryForTime(_EBX);
  sv_demo.nextLevelSave = g_history;
  SV_DemoSP_Restart();
  if ( sv_demo.nextLevelSave && _EBX <= sv_demo.nextLevelSave->time + 2500 )
  {
    sv_demo.nextLevelTime = sv_demo.nextLevelSave->time;
  }
  else
  {
    if ( _EBX < 2500 )
      _EBX = 0;
    sv_demo.nextLevelTime = _EBX;
  }
}

/*
==============
SV_DemoSP_SetNextLevelTime
==============
*/
void SV_DemoSP_SetNextLevelTime(int time)
{
  if ( sv_demo.nextLevelSave && time <= sv_demo.nextLevelSave->time + 2500 )
  {
    sv_demo.nextLevelTime = sv_demo.nextLevelSave->time;
  }
  else
  {
    if ( time < 2500 )
      time = 0;
    sv_demo.nextLevelTime = time;
  }
}

/*
==============
SV_DemoSP_Shutdown
==============
*/
void SV_DemoSP_Shutdown(void)
{
  server_demo_history_t *v0; 

  SV_Demo_WaitForSaveHistoryDone();
  v0 = g_history;
  sv_demo.changed = 0;
  if ( g_history )
  {
    SV_DemoSP_FreeHistoryData(g_history);
    v0 = NULL;
    g_history = NULL;
  }
  if ( sv_demo.msg.data )
  {
    sv_demo.msg.data = NULL;
    sv_demo.msg.maxsize = 0;
  }
  if ( v0 )
  {
    SV_DemoSP_FreeHistoryData(v0);
    g_history = NULL;
  }
  if ( sv_demo.save.buf )
  {
    SV_DemoSP_HistoryFree(sv_demo.save.buf, sv_demo.save.bufLen);
    sv_demo.save.buf = NULL;
    sv_demo.save.bufLen = 0i64;
  }
}

/*
==============
SV_DemoSP_ShutdownSystem
==============
*/
void SV_DemoSP_ShutdownSystem(void)
{
  if ( g_fileTimeHistory.handle != -1 )
  {
    FS_FileClose((HANDLE)g_fileTimeHistory.handle);
    g_fileTimeHistory.handle = -1i64;
  }
  if ( g_fileMarkHistory.handle != -1 )
  {
    FS_FileClose((HANDLE)g_fileMarkHistory.handle);
    g_fileMarkHistory.handle = -1i64;
  }
}

/*
==============
SV_DemoSP_TruncateHistoryTimeCache
==============
*/
void SV_DemoSP_TruncateHistoryTimeCache(int maxTime, __int64 a2, __int64 a3)
{
  __int64 v3; 
  __int64 handle; 
  int v5; 
  FileSkip *v6; 
  bool v7; 

  v3 = (unsigned int)maxTime;
  handle = g_fileTimeHistory.handle;
  if ( g_fileTimeHistory.handle == -1 )
  {
    Com_PrintError(1, "Failed to open demo cache file.\n", a3, v3);
  }
  else
  {
    v5 = 0;
    if ( g_numFileSkips > 0 )
    {
      v6 = g_fileSkips;
      do
      {
        if ( v6->time > (int)v3 )
          break;
        ++v5;
        ++v6;
      }
      while ( v5 < g_numFileSkips );
    }
    g_numFileSkips = v5;
    v7 = v5 == 0;
    if ( v5 < 0 )
    {
      if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 607, ASSERT_TYPE_SANITY, "( g_numFileSkips >= 0 )", (const char *)&queryFormat, "g_numFileSkips >= 0") )
        __debugbreak();
      v5 = g_numFileSkips;
      v7 = g_numFileSkips == 0;
      handle = g_fileTimeHistory.handle;
    }
    if ( v7 )
      FS_FileSeek((sysFileHandle_t)handle, 0i64, 2);
    else
      FS_FileSeek((sysFileHandle_t)handle, g_fileSkips[v5 - 1].fileEndOffset, 2);
  }
}

/*
==============
SV_DemoSP_UpdateDemo
==============
*/
void SV_DemoSP_UpdateDemo(void)
{
  if ( sv_demo.recording )
    sv_demo.endTime = G_Main_GetTime();
}

/*
==============
SV_DemoSP_UsingDemoSave
==============
*/
bool SV_DemoSP_UsingDemoSave()
{
  return sv_demo.nextLevelSave != NULL;
}

/*
==============
SV_DemoSP_WriteHistory
==============
*/
bool SV_DemoSP_WriteHistory(sysFileHandle_t fileHistory, const server_demo_history_t *history)
{
  unsigned __int64 bufLen; 
  unsigned __int64 freeEntBufLen; 
  bool result; 

  if ( !history && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2625, ASSERT_TYPE_ASSERT, "(history)", (const char *)&queryFormat, "history") )
    __debugbreak();
  FS_FileSeek(fileHistory, 0i64, 0);
  result = 0;
  if ( FS_FileWrite(history, 0xCED0ui64, fileHistory) == 52944 )
  {
    bufLen = history->save.bufLen;
    if ( bufLen == FS_FileWrite(history->save.buf, bufLen, fileHistory) )
    {
      freeEntBufLen = history->freeEntBufLen;
      if ( freeEntBufLen == FS_FileWrite(history->freeEntBuf, freeEntBufLen, fileHistory) )
        return 1;
    }
  }
  return result;
}

/*
==============
SvDemoSP::SaveHistory
==============
*/
void SvDemoSP::SaveHistory(SvDemoSP *this)
{
  if ( !g_historySaving && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 876, ASSERT_TYPE_ASSERT, "(g_historySaving)", (const char *)&queryFormat, "g_historySaving") )
    __debugbreak();
  SV_DemoSP_SaveHistory(g_historySaving);
  SV_DemoSP_FreeHistoryData(g_historySaving);
  g_historySaving = NULL;
  Sys_SetSaveHistoryDoneEvent();
}

/*
==============
SvDemoSP::SaveImmediate
==============
*/
void SvDemoSP::SaveImmediate(SvDemoSP *this, SaveImmediate *save)
{
  if ( !sv_demo.msg.data && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2350, ASSERT_TYPE_ASSERT, "(sv_demo.msg.data)", (const char *)&queryFormat, "sv_demo.msg.data") )
    __debugbreak();
  if ( !save && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2351, ASSERT_TYPE_ASSERT, "(save)", (const char *)&queryFormat, "save") )
    __debugbreak();
  if ( !save->buf && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_sp\\sv_demo_sp.cpp", 2353, ASSERT_TYPE_ASSERT, "(save->buf != nullptr)", (const char *)&queryFormat, "save->buf != nullptr") )
    __debugbreak();
  save->bufOffset = 0;
  SaveMemory_SaveWriteImmediate(&sv_demo, 4, save);
  SaveMemory_SaveWriteImmediate(&sv_demo.endTime, 4, save);
  SaveMemory_SaveWriteImmediate(&sv_demo.msg.cursize, 4, save);
  SaveMemory_SaveWriteImmediate(sv_demo.msg.data, sv_demo.msg.cursize, save);
  SaveMemory_SaveWriteImmediateBufFlush(save);
}

