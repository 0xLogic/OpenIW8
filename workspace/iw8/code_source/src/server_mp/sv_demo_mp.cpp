/*
==============
SV_DemoMP_GetInt64
==============
*/

__int64 __fastcall SV_DemoMP_GetInt64()
{
  return ?SV_DemoMP_GetInt64@@YA_JXZ();
}

/*
==============
SvDemoMP::GetCheatsOk
==============
*/

int __fastcall SvDemoMP::GetCheatsOk(SvDemoMP *this)
{
  return ?GetCheatsOk@SvDemoMP@@UEAAHXZ(this);
}

/*
==============
SV_DemoMP_FullForward_f
==============
*/

void SV_DemoMP_FullForward_f(void)
{
  ?SV_DemoMP_FullForward_f@@YAXXZ();
}

/*
==============
SvDemoMP::RecordInt64
==============
*/

void __fastcall SvDemoMP::RecordInt64(SvDemoMP *this, __int64 value)
{
  ?RecordInt64@SvDemoMP@@UEAAX_J@Z(this, value);
}

/*
==============
SvDemoMP::GetServerDemoMessageSize
==============
*/

unsigned int __fastcall SvDemoMP::GetServerDemoMessageSize()
{
  return ?GetServerDemoMessageSize@SvDemoMP@@SAIXZ();
}

/*
==============
SV_DemoMP_SetMsecTime_f
==============
*/

void SV_DemoMP_SetMsecTime_f(void)
{
  ?SV_DemoMP_SetMsecTime_f@@YAXXZ();
}

/*
==============
SV_DemoMP_SetMsecTime
==============
*/

void __fastcall SV_DemoMP_SetMsecTime(int time)
{
  ?SV_DemoMP_SetMsecTime@@YAXH@Z(time);
}

/*
==============
SV_DemoMP_GetStringInBuffer
==============
*/

int __fastcall SV_DemoMP_GetStringInBuffer(char *buffer, unsigned int size)
{
  return ?SV_DemoMP_GetStringInBuffer@@YAHPEADI@Z(buffer, size);
}

/*
==============
SV_DemoMP_Write
==============
*/

bool __fastcall SV_DemoMP_Write(const void *buffer, unsigned __int64 len, sysFileHandle_t fileDemo)
{
  return ?SV_DemoMP_Write@@YA_NPEBX_KUsysFileHandle_t@@@Z(buffer, len, fileDemo);
}

/*
==============
SvDemoMP::DvarSet
==============
*/

bool __fastcall SvDemoMP::DvarSet(SvDemoMP *this, unsigned int var_checksum, const char *value)
{
  return ?DvarSet@SvDemoMP@@UEAA_NIPEBD@Z(this, var_checksum, value);
}

/*
==============
SV_DemoMP_Init
==============
*/

void __fastcall SV_DemoMP_Init(const SvServerInitSettings *initSettings, SaveGame *save, unsigned int *randomSeed, int *levelTime)
{
  ?SV_DemoMP_Init@@YAXPEBUSvServerInitSettings@@PEAUSaveGame@@PEAIPEAH@Z(initSettings, save, randomSeed, levelTime);
}

/*
==============
SV_DemoMP_Forward_f
==============
*/

void SV_DemoMP_Forward_f(void)
{
  ?SV_DemoMP_Forward_f@@YAXXZ();
}

/*
==============
SvDemoMP::RecordString
==============
*/

void __fastcall SvDemoMP::RecordString(SvDemoMP *this, const char *buffer)
{
  ?RecordString@SvDemoMP@@UEAAXPEBD@Z(this, buffer);
}

/*
==============
SV_DemoMP_Back_f
==============
*/

void SV_DemoMP_Back_f(void)
{
  ?SV_DemoMP_Back_f@@YAXXZ();
}

/*
==============
SvDemoMP::GetByte
==============
*/

unsigned __int8 __fastcall SvDemoMP::GetByte(SvDemoMP *this)
{
  return ?GetByte@SvDemoMP@@UEAAEXZ(this);
}

/*
==============
SV_DemoMP_UpdateReplayClient
==============
*/

void SV_DemoMP_UpdateReplayClient(void)
{
  ?SV_DemoMP_UpdateReplayClient@@YAXXZ();
}

/*
==============
SV_DemoMP_PreLoadDemo
==============
*/

void __fastcall SV_DemoMP_PreLoadDemo(const SvServerInitSettings *initSettings, SaveGame **saveGame)
{
  ?SV_DemoMP_PreLoadDemo@@YAXPEBUSvServerInitSettings@@PEAPEAUSaveGame@@@Z(initSettings, saveGame);
}

/*
==============
SV_DemoMP_GetData
==============
*/

int __fastcall SV_DemoMP_GetData(unsigned __int8 *buf, const int maxBufSize)
{
  return ?SV_DemoMP_GetData@@YAHPEAEH@Z(buf, maxBufSize);
}

/*
==============
SvDemoMP::GetShort
==============
*/

__int16 __fastcall SvDemoMP::GetShort(SvDemoMP *this)
{
  return ?GetShort@SvDemoMP@@UEAAFXZ(this);
}

/*
==============
SV_DemoMP_SaveDemoForClient
==============
*/

void __fastcall SV_DemoMP_SaveDemoForClient(const int clientNum, const char *name)
{
  ?SV_DemoMP_SaveDemoForClient@@YAXHPEBD@Z(clientNum, name);
}

/*
==============
SV_DemoMP_UpdateDemo
==============
*/

void SV_DemoMP_UpdateDemo(void)
{
  ?SV_DemoMP_UpdateDemo@@YAXXZ();
}

/*
==============
SvDemoMP::InitServerDemoMessageMem
==============
*/

void __fastcall SvDemoMP::InitServerDemoMessageMem(SvDemoMP *this, unsigned __int8 *mem, unsigned __int64 size)
{
  ?InitServerDemoMessageMem@SvDemoMP@@UEAAXPEAE_K@Z(this, mem, size);
}

/*
==============
SvDemoMP::RecordInt
==============
*/

void __fastcall SvDemoMP::RecordInt(SvDemoMP *this, int value)
{
  ?RecordInt@SvDemoMP@@UEAAXH@Z(this, value);
}

/*
==============
SV_DemoMP_Read
==============
*/

bool __fastcall SV_DemoMP_Read(void *buffer, unsigned __int64 len, sysFileHandle_t fileDemo)
{
  return ?SV_DemoMP_Read@@YA_NPEAX_KUsysFileHandle_t@@@Z(buffer, len, fileDemo);
}

/*
==============
SvDemoMP::SaveHistory
==============
*/

void __fastcall SvDemoMP::SaveHistory(SvDemoMP *this)
{
  ?SaveHistory@SvDemoMP@@UEAAXXZ(this);
}

/*
==============
SV_DemoMP_Info_f
==============
*/

void SV_DemoMP_Info_f(void)
{
  ?SV_DemoMP_Info_f@@YAXXZ();
}

/*
==============
SV_DemoMP_Restart_f
==============
*/

void SV_DemoMP_Restart_f(void)
{
  ?SV_DemoMP_Restart_f@@YAXXZ();
}

/*
==============
SV_DemoMP_RecordInt64
==============
*/

void __fastcall SV_DemoMP_RecordInt64(__int64 value)
{
  ?SV_DemoMP_RecordInt64@@YAX_J@Z(value);
}

/*
==============
SV_DemoMP_CanReadDemo
==============
*/

bool __fastcall SV_DemoMP_CanReadDemo()
{
  return ?SV_DemoMP_CanReadDemo@@YA_NXZ();
}

/*
==============
SvDemoMP::GetInt64
==============
*/

__int64 __fastcall SvDemoMP::GetInt64(SvDemoMP *this)
{
  return ?GetInt64@SvDemoMP@@UEAA_JXZ(this);
}

/*
==============
SV_DemoMP_AutoSaveEndDemo
==============
*/

void SV_DemoMP_AutoSaveEndDemo(void)
{
  ?SV_DemoMP_AutoSaveEndDemo@@YAXXZ();
}

/*
==============
SvDemoMP::RecordCheatsOk
==============
*/

void __fastcall SvDemoMP::RecordCheatsOk(SvDemoMP *this, int cheatsOk)
{
  ?RecordCheatsOk@SvDemoMP@@UEAAXH@Z(this, cheatsOk);
}

/*
==============
SvDemoMP::GetFloat
==============
*/

double __fastcall SvDemoMP::GetFloat(SvDemoMP *this)
{
  double result; 

  *(float *)&result = ?GetFloat@SvDemoMP@@UEAAMXZ(this);
  return result;
}

/*
==============
SvDemoMP::GetString
==============
*/

const char *__fastcall SvDemoMP::GetString(SvDemoMP *this)
{
  return ?GetString@SvDemoMP@@UEAAPEBDXZ(this);
}

/*
==============
SV_DemoMP_SetPendingLoadName
==============
*/

void __fastcall SV_DemoMP_SetPendingLoadName(const char *filename)
{
  ?SV_DemoMP_SetPendingLoadName@@YAXPEBD@Z(filename);
}

/*
==============
SV_DemoMP_InitSystem
==============
*/

void SV_DemoMP_InitSystem(void)
{
  ?SV_DemoMP_InitSystem@@YAXXZ();
}

/*
==============
SV_DemoMP_HasDemoEnded
==============
*/

bool __fastcall SV_DemoMP_HasDemoEnded()
{
  return ?SV_DemoMP_HasDemoEnded@@YA_NXZ();
}

/*
==============
SV_DemoMP_Save_f
==============
*/

void SV_DemoMP_Save_f(void)
{
  ?SV_DemoMP_Save_f@@YAXXZ();
}

/*
==============
SV_DemoMP_FinishDemoInit
==============
*/

void __fastcall SV_DemoMP_FinishDemoInit(const SvServerInitSettings *initSettings)
{
  ?SV_DemoMP_FinishDemoInit@@YAXPEBUSvServerInitSettings@@@Z(initSettings);
}

/*
==============
SvDemoMP::SaveImmediate
==============
*/

void __fastcall SvDemoMP::SaveImmediate(SvDemoMP *this, SaveImmediate *save)
{
  ?SaveImmediate@SvDemoMP@@UEAAXPEAU0@@Z(this, save);
}

/*
==============
SV_DemoMP_HostNum
==============
*/

int __fastcall SV_DemoMP_HostNum()
{
  return ?SV_DemoMP_HostNum@@YAHXZ();
}

/*
==============
SV_DemoMP_ShutdownSystem
==============
*/

void SV_DemoMP_ShutdownSystem(void)
{
  ?SV_DemoMP_ShutdownSystem@@YAXXZ();
}

/*
==============
SV_DemoMP_RecordPacketEvent
==============
*/

void __fastcall SV_DemoMP_RecordPacketEvent(netadr_t *from, msg_t *msg, NetPingInfo *info)
{
  ?SV_DemoMP_RecordPacketEvent@@YAXUnetadr_t@@PEAUmsg_t@@PEAUNetPingInfo@@@Z(from, msg, info);
}

/*
==============
SvDemoMP::RecordFloat
==============
*/

void __fastcall SvDemoMP::RecordFloat(SvDemoMP *this, float value)
{
  ?RecordFloat@SvDemoMP@@UEAAXM@Z(this, value);
}

/*
==============
SV_DemoMP_ReadPacket
==============
*/

void SV_DemoMP_ReadPacket(void)
{
  ?SV_DemoMP_ReadPacket@@YAXXZ();
}

/*
==============
SvDemoMP::RecordShort
==============
*/

void __fastcall SvDemoMP::RecordShort(SvDemoMP *this, __int16 value)
{
  ?RecordShort@SvDemoMP@@UEAAXF@Z(this, value);
}

/*
==============
SV_DemoMP_RecordProcessClientThinks
==============
*/

void SV_DemoMP_RecordProcessClientThinks(void)
{
  ?SV_DemoMP_RecordProcessClientThinks@@YAXXZ();
}

/*
==============
SV_DemoMP_RecordProcessUsermoveOutput
==============
*/

void SV_DemoMP_RecordProcessUsermoveOutput(void)
{
  ?SV_DemoMP_RecordProcessUsermoveOutput@@YAXXZ();
}

/*
==============
SV_DemoMP_StopClientReplay
==============
*/

void SV_DemoMP_StopClientReplay(void)
{
  ?SV_DemoMP_StopClientReplay@@YAXXZ();
}

/*
==============
SvDemoMP::AutoSave
==============
*/

void __fastcall SvDemoMP::AutoSave(SvDemoMP *this, AutoSaveType autosaveType, const char *description, int demoCount, bool force)
{
  ?AutoSave@SvDemoMP@@UEAAXW4AutoSaveType@@PEBDH_N@Z(this, autosaveType, description, demoCount, force);
}

/*
==============
SvDemoMP::GetInt
==============
*/

int __fastcall SvDemoMP::GetInt(SvDemoMP *this)
{
  return ?GetInt@SvDemoMP@@UEAAHXZ(this);
}

/*
==============
SV_DemoMP_UsingDemoHistory
==============
*/

bool __fastcall SV_DemoMP_UsingDemoHistory()
{
  return ?SV_DemoMP_UsingDemoHistory@@YA_NXZ();
}

/*
==============
SV_DemoMP_SetNextLevelTime
==============
*/

void __fastcall SV_DemoMP_SetNextLevelTime(int time)
{
  ?SV_DemoMP_SetNextLevelTime@@YAXH@Z(time);
}

/*
==============
SvDemoMP::RecordByte
==============
*/

void __fastcall SvDemoMP::RecordByte(SvDemoMP *this, unsigned __int8 value)
{
  ?RecordByte@SvDemoMP@@UEAAXE@Z(this, value);
}

/*
==============
SV_DemoMP_StartServerFinalize
==============
*/

void SV_DemoMP_StartServerFinalize(void)
{
  ?SV_DemoMP_StartServerFinalize@@YAXXZ();
}

/*
==============
SV_DemoMP_RecordData
==============
*/

void __fastcall SV_DemoMP_RecordData(const unsigned __int8 *buf, const int size)
{
  ?SV_DemoMP_RecordData@@YAXPEBEH@Z(buf, size);
}

/*
==============
SvDemoMP::AutoSave
==============
*/
void SvDemoMP::AutoSave(SvDemoMP *this, AutoSaveType autosaveType, const char *description, int demoCount, bool force)
{
  __int64 v5; 

  if ( autosaveType != DODGE )
  {
    v5 = (unsigned int)autosaveType;
    if ( SV_DemoMP_ShouldAutoSave(autosaveType, force) )
      SV_DemoMP_AutoSaveInternal((const AutoSaveType)v5, s_autoSaveBaseNamesMP[v5], description, demoCount, force);
  }
}

/*
==============
SvDemoMP::DvarSet
==============
*/
bool SvDemoMP::DvarSet(SvDemoMP *this, unsigned int var_checksum, const char *value)
{
  SvPersistentGlobalsMP *PersistentGlobalsMP; 
  bool result; 

  if ( !Sys_IsMainThread() && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1217, ASSERT_TYPE_ASSERT, "( Sys_IsMainThread() )", (const char *)&queryFormat, "Sys_IsMainThread()") )
    __debugbreak();
  if ( SV_IsDemoPlaying() && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1218, ASSERT_TYPE_ASSERT, "( !SV_IsDemoPlaying() )", (const char *)&queryFormat, "!SV_IsDemoPlaying()") )
    __debugbreak();
  if ( !SV_Demo_IsRecording() && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1219, ASSERT_TYPE_ASSERT, "( SV_Demo_IsRecording() )", (const char *)&queryFormat, "SV_Demo_IsRecording()") )
    __debugbreak();
  SV_DemoMP_CheckSize();
  if ( s_svdMsgProf[1].start != -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 188, ASSERT_TYPE_ASSERT, "( s_svdMsgProf[type].start == -1 )", (const char *)&queryFormat, "s_svdMsgProf[type].start == -1") )
    __debugbreak();
  s_svdMsgProf[1].start = sv_demo.msg.cursize;
  MSG_WriteByte(&sv_demo.msg, 1i64);
  PersistentGlobalsMP = SvPersistentGlobalsMP::GetPersistentGlobalsMP();
  MSG_WriteLong(&sv_demo.msg, PersistentGlobalsMP->time);
  MSG_WriteLong(&sv_demo.msg, var_checksum);
  MSG_WriteString(&sv_demo.msg, value);
  if ( s_svdMsgProf[1].start == -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 195, ASSERT_TYPE_ASSERT, "( s_svdMsgProf[type].start != -1 )", (const char *)&queryFormat, "s_svdMsgProf[type].start != -1") )
    __debugbreak();
  s_svdMsgProf[1].total += sv_demo.msg.cursize - s_svdMsgProf[1].start;
  result = 1;
  s_svdMsgProf[1].start = -1;
  return result;
}

/*
==============
SvDemoMP::GetByte
==============
*/
char SvDemoMP::GetByte(SvDemoMP *this)
{
  int Byte; 
  char v3; 

  if ( !sv_demo.playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1034, ASSERT_TYPE_ASSERT, "( sv_demo.playing )", (const char *)&queryFormat, "sv_demo.playing") )
    __debugbreak();
  if ( sv_demo.serverThreadStarted && !Sys_IsServerThread() && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 957, ASSERT_TYPE_ASSERT, "( Sys_IsServerThread() )", (const char *)&queryFormat, "Sys_IsServerThread()") )
    __debugbreak();
  if ( sv_demo.readType == 6 )
  {
    Byte = MSG_ReadByte(&sv_demo.msg);
    v3 = Byte;
    if ( (Byte < 0 || (unsigned int)Byte > 0xFF) && CoreAssert_Handler("c:\\workspace\\iw8\\shared\\codware\\core\\core_assert.h", 385, ASSERT_TYPE_ASSERT, (const char *)&queryFormat.fmt + 3, "%s (SmallType) %s 0x%jx == (BigType) %s 0x%jx", "unsigned char __cdecl truncate_cast_impl<unsigned char,int>(int)", "unsigned", (unsigned __int8)Byte, "signed", Byte) )
      __debugbreak();
    SV_DemoMP_ReadNextDemoType();
    return v3;
  }
  else
  {
    SV_DemoMP_EndDemoError(this);
    return 0;
  }
}

/*
==============
SvDemoMP::GetCheatsOk
==============
*/
__int64 SvDemoMP::GetCheatsOk(SvDemoMP *this)
{
  __int64 v1; 
  unsigned int Long; 

  if ( !SV_IsDemoPlaying() )
    return 0i64;
  if ( sv_demo.readType != 2 )
  {
    Com_PrintError(15, "SV_DemoMP_GetCheatsOk(): Invalid sv_demo.readType: '%i'", (unsigned int)sv_demo.readType);
    SV_DemoMP_EndDemoError(v1);
    return 0i64;
  }
  Long = MSG_ReadLong(&sv_demo.msg);
  SV_DemoMP_ReadNextDemoType();
  return Long;
}

/*
==============
SvDemoMP::GetFloat
==============
*/
float SvDemoMP::GetFloat(SvDemoMP *this)
{
  double Float; 

  if ( !sv_demo.playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1192, ASSERT_TYPE_ASSERT, "( sv_demo.playing )", (const char *)&queryFormat, "sv_demo.playing") )
    __debugbreak();
  if ( sv_demo.serverThreadStarted && !Sys_IsServerThread() && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 957, ASSERT_TYPE_ASSERT, "( Sys_IsServerThread() )", (const char *)&queryFormat, "Sys_IsServerThread()") )
    __debugbreak();
  if ( sv_demo.readType == 10 )
  {
    Float = MSG_ReadFloat(&sv_demo.msg);
    SV_DemoMP_ReadNextDemoType();
  }
  else
  {
    SV_DemoMP_EndDemoError(this);
    LODWORD(Float) = 0;
  }
  return *(float *)&Float;
}

/*
==============
SvDemoMP::GetInt64
==============
*/
unsigned __int64 SvDemoMP::GetInt64(SvDemoMP *this)
{
  unsigned __int64 Int64; 

  if ( !sv_demo.playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1109, ASSERT_TYPE_ASSERT, "( sv_demo.playing )", (const char *)&queryFormat, "sv_demo.playing") )
    __debugbreak();
  if ( sv_demo.serverThreadStarted && !Sys_IsServerThread() && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 957, ASSERT_TYPE_ASSERT, "( Sys_IsServerThread() )", (const char *)&queryFormat, "Sys_IsServerThread()") )
    __debugbreak();
  if ( sv_demo.readType == 9 )
  {
    Int64 = MSG_ReadInt64(&sv_demo.msg);
    SV_DemoMP_ReadNextDemoType();
    return Int64;
  }
  else
  {
    SV_DemoMP_EndDemoError(this);
    return 0i64;
  }
}

/*
==============
SvDemoMP::GetInt
==============
*/
__int64 SvDemoMP::GetInt(SvDemoMP *this)
{
  unsigned int Long; 

  if ( !sv_demo.playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1072, ASSERT_TYPE_ASSERT, "( sv_demo.playing )", (const char *)&queryFormat, "sv_demo.playing") )
    __debugbreak();
  if ( sv_demo.serverThreadStarted && !Sys_IsServerThread() && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 957, ASSERT_TYPE_ASSERT, "( Sys_IsServerThread() )", (const char *)&queryFormat, "Sys_IsServerThread()") )
    __debugbreak();
  if ( sv_demo.readType == 8 )
  {
    Long = MSG_ReadLong(&sv_demo.msg);
    SV_DemoMP_ReadNextDemoType();
    return Long;
  }
  else
  {
    SV_DemoMP_EndDemoError(this);
    return 0i64;
  }
}

/*
==============
SvDemoMP::GetServerDemoMessageSize
==============
*/
__int64 SvDemoMP::GetServerDemoMessageSize()
{
  return 121831424i64;
}

/*
==============
SvDemoMP::GetShort
==============
*/
__int64 SvDemoMP::GetShort(SvDemoMP *this)
{
  int Short; 
  unsigned __int16 v3; 

  if ( !sv_demo.playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 3775, ASSERT_TYPE_ASSERT, "( sv_demo.playing )", (const char *)&queryFormat, "sv_demo.playing") )
    __debugbreak();
  if ( sv_demo.readType == 7 )
  {
    Short = MSG_ReadShort(&sv_demo.msg);
    v3 = Short;
    if ( (unsigned int)(Short + 0x8000) > 0xFFFF && CoreAssert_Handler("c:\\workspace\\iw8\\shared\\codware\\core\\core_assert.h", 385, ASSERT_TYPE_ASSERT, (const char *)&queryFormat.fmt + 3, "%s (SmallType) %s 0x%jx == (BigType) %s 0x%jx", "short __cdecl truncate_cast_impl<short,int>(int)", "signed", (__int16)Short, "signed", Short) )
      __debugbreak();
    SV_DemoMP_ReadNextDemoType();
    return v3;
  }
  else
  {
    SV_DemoMP_EndDemoError(this);
    return 0i64;
  }
}

/*
==============
SvDemoMP::GetString
==============
*/
char *SvDemoMP::GetString(SvDemoMP *this)
{
  char string[1024]; 

  if ( !sv_demo.playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 993, ASSERT_TYPE_ASSERT, "( sv_demo.playing )", (const char *)&queryFormat, "sv_demo.playing") )
    __debugbreak();
  if ( sv_demo.serverThreadStarted && !Sys_IsServerThread() && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 957, ASSERT_TYPE_ASSERT, "( Sys_IsServerThread() )", (const char *)&queryFormat, "Sys_IsServerThread()") )
    __debugbreak();
  if ( sv_demo.readType || !MSG_ReadString(&sv_demo.msg, string, 0x400u) )
  {
    SV_DemoMP_EndDemoError(this);
    return (char *)&queryFormat.fmt + 3;
  }
  else
  {
    SV_DemoMP_ReadNextDemoType();
    return j_va((const char *)&queryFormat, string);
  }
}

/*
==============
SvDemoMP::InitServerDemoMessageMem
==============
*/
void SvDemoMP::InitServerDemoMessageMem(SvDemoMP *this, unsigned __int8 *mem, unsigned __int64 size)
{
  if ( !mem && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 347, ASSERT_TYPE_ASSERT, "(mem)", (const char *)&queryFormat, "mem") )
    __debugbreak();
  if ( size )
  {
    if ( size == 121831424 )
      goto LABEL_10;
  }
  else if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 348, ASSERT_TYPE_ASSERT, "(size)", (const char *)&queryFormat, "size") )
  {
    __debugbreak();
  }
  if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 349, ASSERT_TYPE_ASSERT, "( GetServerDemoMessageSize() ) == ( size )", "%s == %s\n\t%u, %u", "GetServerDemoMessageSize()", "size", 121831424, size) )
    __debugbreak();
LABEL_10:
  if ( this->m_msgBuf && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 351, ASSERT_TYPE_ASSERT, "(m_msgBuf == nullptr)", (const char *)&queryFormat, "m_msgBuf == nullptr") )
    __debugbreak();
  if ( this->m_msgBufSize && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 352, ASSERT_TYPE_ASSERT, "(m_msgBufSize == 0)", (const char *)&queryFormat, "m_msgBufSize == 0") )
    __debugbreak();
  this->m_msgBufSize = size;
  this->m_msgBuf = mem;
  Com_Printf(0, "SvDemoMP::InitServerDemoMessageMem() %zukb total\n", size >> 10);
}

/*
==============
SvDemoMP::RecordByte
==============
*/
void SvDemoMP::RecordByte(SvDemoMP *this, unsigned __int8 value)
{
  if ( SV_Demo_IsRecording() )
  {
    if ( sv_demo.serverThreadStarted && !Sys_IsServerThread() && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 957, ASSERT_TYPE_ASSERT, "( Sys_IsServerThread() )", (const char *)&queryFormat, "Sys_IsServerThread()") )
      __debugbreak();
    SV_DemoMP_CheckSize();
    if ( s_svdMsgProf[6].start != -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 188, ASSERT_TYPE_ASSERT, "( s_svdMsgProf[type].start == -1 )", (const char *)&queryFormat, "s_svdMsgProf[type].start == -1") )
      __debugbreak();
    s_svdMsgProf[6].start = sv_demo.msg.cursize;
    MSG_WriteByte(&sv_demo.msg, 6i64);
    MSG_WriteByte(&sv_demo.msg, value);
    if ( s_svdMsgProf[6].start == -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 195, ASSERT_TYPE_ASSERT, "( s_svdMsgProf[type].start != -1 )", (const char *)&queryFormat, "s_svdMsgProf[type].start != -1") )
      __debugbreak();
    s_svdMsgProf[6].total += sv_demo.msg.cursize - s_svdMsgProf[6].start;
    s_svdMsgProf[6].start = -1;
  }
}

/*
==============
SvDemoMP::RecordCheatsOk
==============
*/
void SvDemoMP::RecordCheatsOk(SvDemoMP *this, int cheatsOk)
{
  if ( SV_Demo_IsRecording() )
  {
    SV_DemoMP_CheckSize();
    MSG_WriteByte(&sv_demo.msg, 2i64);
    MSG_WriteLong(&sv_demo.msg, cheatsOk);
  }
}

/*
==============
SvDemoMP::RecordFloat
==============
*/
void SvDemoMP::RecordFloat(SvDemoMP *this, float value)
{
  if ( SV_Demo_IsRecording() )
  {
    if ( sv_demo.serverThreadStarted && !Sys_IsServerThread() && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 957, ASSERT_TYPE_ASSERT, "( Sys_IsServerThread() )", (const char *)&queryFormat, "Sys_IsServerThread()") )
      __debugbreak();
    SV_DemoMP_CheckSize();
    if ( s_svdMsgProf[10].start != -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 188, ASSERT_TYPE_ASSERT, "( s_svdMsgProf[type].start == -1 )", (const char *)&queryFormat, "s_svdMsgProf[type].start == -1") )
      __debugbreak();
    s_svdMsgProf[10].start = sv_demo.msg.cursize;
    MSG_WriteByte(&sv_demo.msg, 10i64);
    MSG_WriteFloat(&sv_demo.msg, value);
    if ( s_svdMsgProf[10].start == -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 195, ASSERT_TYPE_ASSERT, "( s_svdMsgProf[type].start != -1 )", (const char *)&queryFormat, "s_svdMsgProf[type].start != -1") )
      __debugbreak();
    s_svdMsgProf[10].total += sv_demo.msg.cursize - s_svdMsgProf[10].start;
    s_svdMsgProf[10].start = -1;
  }
}

/*
==============
SvDemoMP::RecordInt64
==============
*/
void SvDemoMP::RecordInt64(SvDemoMP *this, __int64 value)
{
  if ( SV_Demo_IsRecording() )
  {
    if ( sv_demo.serverThreadStarted && !Sys_IsServerThread() && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 957, ASSERT_TYPE_ASSERT, "( Sys_IsServerThread() )", (const char *)&queryFormat, "Sys_IsServerThread()") )
      __debugbreak();
    SV_DemoMP_CheckSize();
    if ( s_svdMsgProf[9].start != -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 188, ASSERT_TYPE_ASSERT, "( s_svdMsgProf[type].start == -1 )", (const char *)&queryFormat, "s_svdMsgProf[type].start == -1") )
      __debugbreak();
    s_svdMsgProf[9].start = sv_demo.msg.cursize;
    MSG_WriteByte(&sv_demo.msg, 9i64);
    MSG_WriteInt64(&sv_demo.msg, value);
    if ( s_svdMsgProf[9].start == -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 195, ASSERT_TYPE_ASSERT, "( s_svdMsgProf[type].start != -1 )", (const char *)&queryFormat, "s_svdMsgProf[type].start != -1") )
      __debugbreak();
    s_svdMsgProf[9].total += sv_demo.msg.cursize - s_svdMsgProf[9].start;
    s_svdMsgProf[9].start = -1;
  }
}

/*
==============
SvDemoMP::RecordInt
==============
*/
void SvDemoMP::RecordInt(SvDemoMP *this, int value)
{
  if ( SV_Demo_IsRecording() )
  {
    if ( sv_demo.serverThreadStarted && !Sys_IsServerThread() && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 957, ASSERT_TYPE_ASSERT, "( Sys_IsServerThread() )", (const char *)&queryFormat, "Sys_IsServerThread()") )
      __debugbreak();
    SV_DemoMP_CheckSize();
    if ( s_svdMsgProf[8].start != -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 188, ASSERT_TYPE_ASSERT, "( s_svdMsgProf[type].start == -1 )", (const char *)&queryFormat, "s_svdMsgProf[type].start == -1") )
      __debugbreak();
    s_svdMsgProf[8].start = sv_demo.msg.cursize;
    MSG_WriteByte(&sv_demo.msg, 8i64);
    MSG_WriteLong(&sv_demo.msg, value);
    if ( s_svdMsgProf[8].start == -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 195, ASSERT_TYPE_ASSERT, "( s_svdMsgProf[type].start != -1 )", (const char *)&queryFormat, "s_svdMsgProf[type].start != -1") )
      __debugbreak();
    s_svdMsgProf[8].total += sv_demo.msg.cursize - s_svdMsgProf[8].start;
    s_svdMsgProf[8].start = -1;
  }
}

/*
==============
SvDemoMP::RecordShort
==============
*/
void SvDemoMP::RecordShort(SvDemoMP *this, __int16 value)
{
  if ( SV_Demo_IsRecording() )
  {
    SV_DemoMP_CheckSize();
    if ( s_svdMsgProf[7].start != -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 188, ASSERT_TYPE_ASSERT, "( s_svdMsgProf[type].start == -1 )", (const char *)&queryFormat, "s_svdMsgProf[type].start == -1") )
      __debugbreak();
    s_svdMsgProf[7].start = sv_demo.msg.cursize;
    MSG_WriteByte(&sv_demo.msg, 7i64);
    MSG_WriteShort(&sv_demo.msg, value);
    if ( s_svdMsgProf[7].start == -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 195, ASSERT_TYPE_ASSERT, "( s_svdMsgProf[type].start != -1 )", (const char *)&queryFormat, "s_svdMsgProf[type].start != -1") )
      __debugbreak();
    s_svdMsgProf[7].total += sv_demo.msg.cursize - s_svdMsgProf[7].start;
    s_svdMsgProf[7].start = -1;
  }
}

/*
==============
SvDemoMP::RecordString
==============
*/
void SvDemoMP::RecordString(SvDemoMP *this, const char *buffer)
{
  if ( SV_Demo_IsRecording() )
  {
    if ( sv_demo.serverThreadStarted && !Sys_IsServerThread() && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 957, ASSERT_TYPE_ASSERT, "( Sys_IsServerThread() )", (const char *)&queryFormat, "Sys_IsServerThread()") )
      __debugbreak();
    SV_DemoMP_CheckSize();
    if ( s_svdMsgProf[0].start != -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 188, ASSERT_TYPE_ASSERT, "( s_svdMsgProf[type].start == -1 )", (const char *)&queryFormat, "s_svdMsgProf[type].start == -1") )
      __debugbreak();
    s_svdMsgProf[0].start = sv_demo.msg.cursize;
    MSG_WriteByte(&sv_demo.msg, 0i64);
    MSG_WriteString(&sv_demo.msg, buffer);
    if ( s_svdMsgProf[0].start == -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 195, ASSERT_TYPE_ASSERT, "( s_svdMsgProf[type].start != -1 )", (const char *)&queryFormat, "s_svdMsgProf[type].start != -1") )
      __debugbreak();
    s_svdMsgProf[0].total += sv_demo.msg.cursize - s_svdMsgProf[0].start;
    s_svdMsgProf[0].start = -1;
  }
}

/*
==============
SV_DemoMP_AddDemoSave
==============
*/
char SV_DemoMP_AddDemoSave(server_demo_save_t *save, const bool restart, const bool fullState, const char *cacheFilename)
{
  server_demo_history_t *v8; 
  SvDemo *v9; 
  unsigned __int8 *Buffer; 
  unsigned int BufferSize; 
  const char *v12; 
  sysFileHandle_t *v14; 
  unsigned __int64 v15; 
  unsigned __int8 *v16; 
  unsigned __int64 FileSize; 
  __int64 handle; 
  unsigned __int64 v19; 
  signed int i; 
  SvClientMP *CommonClient; 
  unsigned __int64 v22; 
  SvPersistentGlobalsMP *PersistentGlobalsMP; 
  unsigned __int64 v24; 
  unsigned __int64 v25; 
  unsigned __int64 v26; 
  int ptr; 
  unsigned __int8 *pData; 
  MemoryFile memFile; 

  if ( !cacheFilename && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1769, ASSERT_TYPE_ASSERT, "( cacheFilename )", (const char *)&queryFormat, "cacheFilename") )
    __debugbreak();
  if ( !save && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1770, ASSERT_TYPE_ASSERT, "( save )", (const char *)&queryFormat, "save") )
    __debugbreak();
  if ( save->buf && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1771, ASSERT_TYPE_ASSERT, "( save->buf == nullptr )", (const char *)&queryFormat, "save->buf == nullptr") )
    __debugbreak();
  if ( save->file.handle != -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1772, ASSERT_TYPE_ASSERT, "( save->file == INVALID_SYS_FILE_HANDLE )", (const char *)&queryFormat, "save->file == INVALID_SYS_FILE_HANDLE") )
    __debugbreak();
  __rdtsc();
  if ( !BG_GameInterface_GameModeIsMP((GameModeType)(unsigned __int8)SvDemo::ms_allocatedType) && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.h", 173, ASSERT_TYPE_ASSERT, "( BG_GameInterface_GameModeIsMP( ms_allocatedType ) )", (const char *)&queryFormat, "BG_GameInterface_GameModeIsMP( ms_allocatedType )") )
    __debugbreak();
  v8 = s_demoMP_history;
  v9 = SvDemo::ms_gServerDemoSystem;
  if ( !s_demoMP_history )
  {
    if ( s_demoMP_historySaving && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1787, ASSERT_TYPE_ASSERT, "( s_demoMP_historySaving == nullptr )", (const char *)&queryFormat, "s_demoMP_historySaving == nullptr") )
      __debugbreak();
    v8 = (server_demo_history_t *)&v9[786437];
  }
  Buffer = G_SaveMemoryMP_GetBuffer(SAVE_DEMO_HANDLE);
  BufferSize = G_SaveMemoryMP_GetBufferSize(SAVE_DEMO_HANDLE);
  MemFile_InitForWriting(&memFile, BufferSize, Buffer, 0, 1, StreamModeSource_MPInitializeDemoSave);
  G_SaveMP_SaveState(&memFile, 1, restart, fullState);
  MemFile_StartSegment(&memFile, -1, StreamModeSource_MPSaveDemo);
  if ( memFile.memoryOverflow )
  {
    Com_PrintError(16, "SV_DemoMP_AddDemoSave: Memoryfile overflow '%s'\n", cacheFilename);
    return 0;
  }
  else
  {
    v14 = SV_DemoMP_OpenFile((sysFileHandle_t *)cacheFilename, v12);
    if ( v14 == (sysFileHandle_t *)-1i64 )
    {
      Com_PrintError(16, "SV_DemoMP_AddDemoSave: Could not open demo cache filename '%s'\n", cacheFilename);
      return 0;
    }
    else
    {
      v15 = MemFile_CopySegments(&memFile, 0, NULL);
      if ( SV_DemoMP_HistoryAlloc(v8, &pData, v15) )
      {
        v16 = pData;
        MemFile_CopySegments(&memFile, 0, pData);
        save->file.handle = (__int64)v14;
        save->buf = v16;
        save->bufLen = v15;
        FileSize = FS_FileGetFileSize((sysFileHandle_t)v14);
        ProfMem_Begin("Demo cache file", FileSize);
        FS_FileWrite(&v9[865216], 4ui64, save->file);
        handle = save->file.handle;
        ptr = SvClient::ms_clientCount;
        v19 = FS_FileGetFileSize((sysFileHandle_t)handle);
        ProfMem_Begin("svPers clients", v19);
        FS_FileWrite(&ptr, 4ui64, save->file);
        for ( i = 0; i < ptr; ++i )
        {
          if ( (_BYTE)SvClient::ms_allocatedType != HALF_HALF && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_client_mp.h", 957, ASSERT_TYPE_ASSERT, "( ms_allocatedType == ALLOCATION_TYPE )", (const char *)&queryFormat, "ms_allocatedType == ALLOCATION_TYPE") )
            __debugbreak();
          CommonClient = (SvClientMP *)SvClient::GetCommonClient(i);
          SvClientMP::DemoSaveState(CommonClient, save->file);
        }
        v22 = FS_FileGetFileSize(save->file);
        ProfMem_End(v22);
        PersistentGlobalsMP = SvPersistentGlobalsMP::GetPersistentGlobalsMP();
        FS_FileWrite(&PersistentGlobalsMP->agentCount, 4ui64, save->file);
        v24 = FS_FileGetFileSize(save->file);
        ProfMem_Begin("snapshotData", v24);
        SV_SnapshotMP_SaveDemoState(save->file);
        v25 = FS_FileGetFileSize(save->file);
        ProfMem_End(v25);
        v26 = FS_FileGetFileSize(save->file);
        ProfMem_End(v26);
        ProfMem_PrintTree(0);
        FS_FileClose((HANDLE)save->file.handle);
        save->file.handle = -1i64;
        __rdtsc();
        _XMM0 = 0i64;
        __asm { vcvtsi2sd xmm0, xmm0, rax }
        Com_Printf(15, "SV_DemoMP_AddDemoSave: %fms\n", (double)(*(double *)&_XMM0 * msecPerRawTimerTick));
        return 1;
      }
      else
      {
        Com_PrintError(16, "SV_DemoMP_AddDemoSave: Could not allocate demo history buffer for file '%s'\n", cacheFilename);
        FS_FileClose(v14);
        return 0;
      }
    }
  }
}

/*
==============
SV_DemoMP_AllocRead
==============
*/
bool SV_DemoMP_AllocRead(server_demo_history_t *history, unsigned __int8 **buffer, unsigned __int64 len, sysFileHandle_t file)
{
  return SV_DemoMP_HistoryAlloc(history, buffer, len) && SV_DemoMP_ReadInflate(*buffer, len, file);
}

/*
==============
SV_DemoMP_AutoSaveEndDemo
==============
*/
void SV_DemoMP_AutoSaveEndDemo(void)
{
  const dvar_t *v0; 
  unsigned int BuildNumberAsInt; 
  const char *GameType; 
  const char *MapName; 
  __int64 v4; 
  char dest[64]; 

  v0 = DVARBOOL_replay_autosave_mp;
  if ( !DVARBOOL_replay_autosave_mp && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\universal\\dvar.h", 692, ASSERT_TYPE_ASSERT, "(dvar)", "%s\n\tDvar %s accessed after deregistration", "dvar", "replay_autosave_mp") )
    __debugbreak();
  Dvar_CheckFrontendServerThread(v0);
  if ( v0->current.enabled && (Sys_IsMainThread() || Sys_IsServerThread()) )
  {
    Sys_IsMainThread();
    if ( SvDemo::ms_gServerDemoSystem )
    {
      if ( SvStaticGlobals::ms_svStaticGlobals.state == SS_GAME && sv_demo.msg.data && sv_demo.changed )
      {
        BuildNumberAsInt = j_getBuildNumberAsInt();
        GameType = SV_GameMP_GetGameType();
        MapName = SV_Game_GetMapName();
        LODWORD(v4) = BuildNumberAsInt;
        Com_sprintf(dest, 0x40ui64, "%s_%s_%i", MapName, GameType, v4);
        SV_DemoMP_AutoSaveInternal(COUNT|DODGE, dest, "SV_DemoMP_AutoSaveEndDemo", 50, 0);
      }
    }
  }
  SV_Demo_WaitForSaveHistoryDone();
  if ( !SV_IsDemoPlayingNext() )
  {
    sv_demo.changed = 0;
    if ( sv_demo.msg.data )
    {
      sv_demo.msg.data = NULL;
      sv_demo.msg.maxsize = 0;
    }
    s_svdMsgProf[12].start = -1;
    s_svdMsgProf[12].total = 0;
    *(__m256i *)&s_svdMsgProf[0].start = _ymm;
    *(__m256i *)&s_svdMsgProf[4].start = _ymm;
    *(__m256i *)&s_svdMsgProf[8].start = _ymm;
    if ( s_demoMP_history )
    {
      SV_DemoMP_FreeHistoryData(s_demoMP_history);
      s_demoMP_history = NULL;
    }
    if ( sv_demo.save.buf )
    {
      SV_DemoMP_HistoryFree(sv_demo.save.buf, sv_demo.save.bufLen);
      sv_demo.save.buf = NULL;
      sv_demo.save.bufLen = 0i64;
    }
    if ( sv_demo.save.file.handle != -1 )
    {
      FS_FileClose((HANDLE)sv_demo.save.file.handle);
      sv_demo.save.file.handle = -1i64;
    }
  }
  SV_Demo_ResetDemo();
}

/*
==============
SV_DemoMP_AutoSaveInternal
==============
*/
void SV_DemoMP_AutoSaveInternal(const AutoSaveType autosaveType, const char *baseName, const char *description, const int demoCount, const bool force)
{
  int v9; 
  __int64 v10; 
  char testName[64]; 

  if ( autosaveType == DODGE && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2936, ASSERT_TYPE_ASSERT, "( autosaveType != AutoSaveType::SCRIPTERROR )", (const char *)&queryFormat, "autosaveType != AutoSaveType::SCRIPTERROR") )
    __debugbreak();
  if ( !SV_DemoMP_ShouldAutoSave(autosaveType, force) && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2937, ASSERT_TYPE_ASSERT, "( SV_DemoMP_ShouldAutoSave( autosaveType, force ) )", (const char *)&queryFormat, "SV_DemoMP_ShouldAutoSave( autosaveType, force )") )
    __debugbreak();
  SaveDevice_GetFreeFileName(baseName, demoCount, testName);
  if ( Sys_IsMainThread() )
  {
    if ( force && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2943, ASSERT_TYPE_ASSERT, "( !force )", "Can't Auto-SAve main thread demo from forced context, the server wake itself and cause the ownership assert.") )
      __debugbreak();
    SV_WaitServer();
  }
  v9 = g_serverThreadOwnership;
  if ( !g_serverThreadOwnership )
  {
    if ( ((unsigned __int8)&g_serverThreadOwnership & 3) != 0 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\qcommon\\threads_interlock_pc.h", g_serverThreadOwnership + 37, ASSERT_TYPE_ASSERT, "( ( IsAligned( addend, sizeof( volatile_int32 ) ) ) )", "( addend ) = %p", &g_serverThreadOwnership) )
      __debugbreak();
    if ( _InterlockedIncrement(&g_serverThreadOwnership) != 1 )
    {
      LODWORD(v10) = g_serverThreadOwnership;
      if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2951, ASSERT_TYPE_ASSERT, "( ( Sys_InterlockedIncrement( (volatile_int32 *)&g_serverThreadOwnership ) == 1 ) )", "( g_serverThreadOwnership ) = %i", v10) )
        __debugbreak();
    }
  }
  SV_DemoMP_SaveToFile(testName, description, SAVE_TYPE_INTERNAL);
  if ( !v9 )
  {
    if ( ((unsigned __int8)&g_serverThreadOwnership & 3) != 0 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\qcommon\\threads_interlock_pc.h", 44, ASSERT_TYPE_ASSERT, "( ( IsAligned( addend, sizeof( volatile_int32 ) ) ) )", "( addend ) = %p", &g_serverThreadOwnership) )
      __debugbreak();
    if ( _InterlockedExchangeAdd(&g_serverThreadOwnership, 0xFFFFFFFF) != 1 )
    {
      LODWORD(v10) = g_serverThreadOwnership;
      if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2960, ASSERT_TYPE_ASSERT, "( ( Sys_InterlockedDecrement( (volatile_int32 *)&g_serverThreadOwnership ) == 0 ) )", "( g_serverThreadOwnership ) = %i", v10) )
        __debugbreak();
    }
  }
}

/*
==============
SV_DemoMP_Back_f
==============
*/

void __fastcall SV_DemoMP_Back_f(double a1)
{
  SvGameModeApplication *ActiveServerApplication; 
  int FrameDuration; 
  const char *v3; 
  __int128 v5; 
  int v7; 

  if ( sv_demo.msg.data )
  {
    if ( sv_demo.forwardTime )
    {
      Com_Printf(0, (const char *)&stru_1440E06D8.saveType);
    }
    else
    {
      Dvar_SetBool_Internal(DVARBOOL_replay_time, 1);
      ActiveServerApplication = SvGameModeApplication::GetActiveServerApplication();
      FrameDuration = SvGameModeApplication::GetFrameDuration(ActiveServerApplication);
      if ( SV_Cmd_Argc() <= 1 )
        goto LABEL_8;
      v3 = SV_Cmd_Argv(1);
      *((double *)&v5 + 1) = *(&a1 + 1);
      *(double *)&v5 = atof(v3) * (float)(1000.0 / (float)FrameDuration);
      _XMM0 = v5;
      __asm { vcvttsd2si eax, xmm0 }
      FrameDuration *= _EAX;
      if ( FrameDuration > 0 )
      {
LABEL_8:
        v7 = G_Main_GetTime() - FrameDuration;
        SV_DemoMP_LoadHistoryForTime(v7);
        sv_demo.nextLevelSave = s_demoMP_history;
        SV_DemoMP_Restart(0);
        sv_demo.nextLevelTime = v7;
      }
      else
      {
        Com_Printf(0, (const char *)&stru_1440E06D8.pad1[22]);
      }
    }
  }
  else
  {
    Com_Printf(0, &stru_1440E06D8.mp.gametype[105]);
  }
}

/*
==============
SV_DemoMP_CanReadDemo
==============
*/
bool SV_DemoMP_CanReadDemo()
{
  if ( !BG_GameInterface_GameModeIsMP((GameModeType)(unsigned __int8)SvDemo::ms_allocatedType) && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.h", 173, ASSERT_TYPE_ASSERT, "( BG_GameInterface_GameModeIsMP( ms_allocatedType ) )", (const char *)&queryFormat, "BG_GameInterface_GameModeIsMP( ms_allocatedType )") )
    __debugbreak();
  return HIDWORD(SvDemo::ms_gServerDemoSystem[865216].__vftable) != LODWORD(SvDemo::ms_gServerDemoSystem[865217].__vftable);
}

/*
==============
SV_DemoMP_CheckSize
==============
*/
char SV_DemoMP_CheckSize()
{
  SvDemoMP *DemoMP; 
  char result; 

  sv_demo.changed = 1;
  if ( !sv_demo.msg.data )
    return SV_DemoMP_MsgAlloc(0i64);
  DemoMP = SvDemoMP::GetDemoMP();
  if ( sv_demo.msg.data != DemoMP->m_msgBuf && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 385, ASSERT_TYPE_ASSERT, "( sv_demo.msg.data == svDemo->m_msgBuf )", (const char *)&queryFormat, "sv_demo.msg.data == svDemo->m_msgBuf") )
    __debugbreak();
  result = sv_demo.msg.maxsize;
  if ( sv_demo.msg.maxsize != DemoMP->m_msgBufSize )
  {
    result = CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 386, ASSERT_TYPE_ASSERT, "( sv_demo.msg.maxsize == svDemo->m_msgBufSize )", (const char *)&queryFormat, "sv_demo.msg.maxsize == svDemo->m_msgBufSize");
    if ( result )
      __debugbreak();
  }
  return result;
}

/*
==============
SV_DemoMP_CleanName
==============
*/
bool SV_DemoMP_CleanName(const char *demoName, char *cleanName, unsigned __int64 cleanNameSize, SaveType saveType)
{
  char testName[64]; 

  if ( !cleanNameSize && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2764, ASSERT_TYPE_ASSERT, "( cleanNameSize > 0 )", (const char *)&queryFormat, "cleanNameSize > 0") )
    __debugbreak();
  if ( !cleanName && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2765, ASSERT_TYPE_ASSERT, "( cleanName )", (const char *)&queryFormat, "cleanName") )
    __debugbreak();
  if ( !demoName )
  {
    SaveDevice_GetFreeFileName("replay", 50, testName);
    demoName = testName;
  }
  return BuildCleanSavePath(cleanName, cleanNameSize, demoName, saveType);
}

/*
==============
SV_DemoMP_ClearBaseline
==============
*/
void SV_DemoMP_ClearBaseline()
{
  SvDemo *v0; 

  if ( !BG_GameInterface_GameModeIsMP((GameModeType)(unsigned __int8)SvDemo::ms_allocatedType) && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.h", 173, ASSERT_TYPE_ASSERT, "( BG_GameInterface_GameModeIsMP( ms_allocatedType ) )", (const char *)&queryFormat, "BG_GameInterface_GameModeIsMP( ms_allocatedType )") )
    __debugbreak();
  v0 = SvDemo::ms_gServerDemoSystem;
  LODWORD(SvDemo::ms_gServerDemoSystem[909650].__vftable) = -1;
  DebugWipe(&v0[906179], 0x6C78ui64);
}

/*
==============
SV_DemoMP_ClearSavegame
==============
*/
void SV_DemoMP_ClearSavegame()
{
  sv_demo.nextLevelSave = NULL;
  if ( sv_demo.save.buf )
  {
    SV_DemoMP_HistoryFree(sv_demo.save.buf, sv_demo.save.bufLen);
    sv_demo.save.buf = NULL;
    sv_demo.save.bufLen = 0i64;
  }
  if ( sv_demo.save.file.handle != -1 )
  {
    FS_FileClose((HANDLE)sv_demo.save.file.handle);
    sv_demo.save.file.handle = -1i64;
  }
}

/*
==============
SV_DemoMP_EndDemoError
==============
*/
void SV_DemoMP_EndDemoError()
{
  if ( !sv_demo.playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 899, ASSERT_TYPE_ASSERT, "( sv_demo.playing )", (const char *)&queryFormat, "sv_demo.playing") )
    __debugbreak();
  if ( sv_demo.recording && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 900, ASSERT_TYPE_ASSERT, "( !sv_demo.recording )", (const char *)&queryFormat, "!sv_demo.recording") )
    __debugbreak();
  SV_DemoMP_Info_f();
  SV_Demo_ResetDemo();
  Com_Error_impl(ERR_DROP, (const ObfuscateErrorText)&stru_1440DEFE0, 341i64);
}

/*
==============
SV_DemoMP_FinishDemoInit
==============
*/
void SV_DemoMP_FinishDemoInit(const SvServerInitSettings *initSettings)
{
  server_demo_save_t *p_save; 
  sysFileHandle_t v3; 
  SaveGame *SaveHandle; 
  SvDemoMP *DemoMP; 
  signed int m_clientNum; 
  SvClientMP *MpClient; 

  if ( SV_IsDemoPlaying() )
  {
    if ( sv_demo.nextLevelSave )
      p_save = &sv_demo.nextLevelSave->save;
    else
      p_save = &sv_demo.save;
    if ( !p_save->buf && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1738, ASSERT_TYPE_ASSERT, "( save->buf )", (const char *)&queryFormat, "save->buf") )
      __debugbreak();
    if ( p_save->file.handle == -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1739, ASSERT_TYPE_ASSERT, "( save->file )", (const char *)&queryFormat, "save->file") )
      __debugbreak();
    v3.handle = p_save->file.handle;
    SaveHandle = G_SaveMemoryMP_GetSaveHandle(SAVE_DEMO_HANDLE);
    if ( !SV_SnapshotMP_ArchiveEnabled() && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1722, ASSERT_TYPE_ASSERT, "( SV_SnapshotMP_ArchiveEnabled() )", (const char *)&queryFormat, "SV_SnapshotMP_ArchiveEnabled()") )
      __debugbreak();
    G_SaveMP_LoadGame(initSettings, 0, SaveHandle, sv_demo.nextLevelSave != NULL, 1);
    SV_SnapshotMP_LoadDemoState(v3);
    if ( !sv_demo.nextLevelSave )
    {
      if ( p_save->file.handle == s_demoMP_fileTimeHistory.handle && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1749, ASSERT_TYPE_ASSERT, "( save->file != s_demoMP_fileTimeHistory )", (const char *)&queryFormat, "save->file != s_demoMP_fileTimeHistory") )
        __debugbreak();
      FS_FileClose((HANDLE)p_save->file.handle);
    }
    p_save->file.handle = -1i64;
    if ( SV_IsDemoPlaying() )
    {
      DemoMP = SvDemoMP::GetDemoMP();
      m_clientNum = DemoMP->m_clientNum;
      if ( m_clientNum >= 0 && m_clientNum < (int)SvClient::ms_clientCount )
      {
        MpClient = SV_Client_GetMpClient(m_clientNum);
        MpClient->demorecording = 0;
        MpClient->demowrite = NULL;
      }
      DemoMP->m_clientNum = -1;
    }
  }
}

/*
==============
SV_DemoMP_Forward_f
==============
*/

void __fastcall SV_DemoMP_Forward_f(double a1)
{
  SvGameModeApplication *ActiveServerApplication; 
  int FrameDuration; 
  const char *v3; 
  __int128 v5; 
  int v7; 
  int v8; 

  if ( SV_IsDemoPlaying() )
  {
    if ( sv_demo.forwardTime )
    {
      Com_Printf(0, &stru_1440E06D8.mp.gametype[65]);
    }
    else
    {
      Dvar_SetBool_Internal(DVARBOOL_replay_time, 1);
      ActiveServerApplication = SvGameModeApplication::GetActiveServerApplication();
      FrameDuration = SvGameModeApplication::GetFrameDuration(ActiveServerApplication);
      if ( SV_Cmd_Argc() > 1 )
      {
        v3 = SV_Cmd_Argv(1);
        *((double *)&v5 + 1) = *(&a1 + 1);
        *(double *)&v5 = atof(v3) * (float)(1000.0 / (float)FrameDuration);
        _XMM0 = v5;
        __asm { vcvttsd2si edi, xmm0 }
        v7 = FrameDuration * _EDI;
        if ( v7 > 0 )
        {
          v8 = v7 + G_Main_GetTime();
          SV_DemoMP_LoadHistoryForTime(v8);
          sv_demo.forwardTime = v8;
          sv_demo.nextLevelSave = NULL;
          sv_demo.nextLevelTime = 0;
        }
        else
        {
          Com_Printf(0, &stru_1440E06D8.mp.gametype[1]);
        }
      }
      else
      {
        sv_demo.forwardTime = FrameDuration + G_Main_GetTime();
        sv_demo.nextLevelSave = NULL;
        sv_demo.nextLevelTime = 0;
      }
    }
  }
  else
  {
    Com_Printf(0, &stru_1440E06D8.mp.gametype[17]);
  }
}

/*
==============
SV_DemoMP_FreeHistoryData
==============
*/
void SV_DemoMP_FreeHistoryData(server_demo_history_t *history)
{
  unsigned __int8 *freeEntBuf; 
  unsigned __int8 *buf; 

  if ( !history && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1895, ASSERT_TYPE_ASSERT, "( history )", (const char *)&queryFormat, "history") )
    __debugbreak();
  freeEntBuf = history->freeEntBuf;
  if ( freeEntBuf )
  {
    SV_DemoMP_HistoryFree(freeEntBuf, history->freeEntBufLen);
    history->freeEntBuf = NULL;
    history->freeEntBufLen = 0;
  }
  buf = history->save.buf;
  if ( buf )
  {
    SV_DemoMP_HistoryFree(buf, history->save.bufLen);
    history->save.buf = NULL;
    history->save.bufLen = 0i64;
  }
  if ( history->save.file.handle != -1 )
  {
    FS_FileClose((HANDLE)history->save.file.handle);
    history->save.file.handle = -1i64;
  }
}

/*
==============
SV_DemoMP_FullForward_f
==============
*/

void __fastcall SV_DemoMP_FullForward_f(double a1)
{
  SvGameModeApplication *ActiveServerApplication; 
  int FrameDuration; 
  const char *v3; 
  __int128 v5; 
  int v7; 

  if ( SV_IsDemoPlaying() )
  {
    if ( sv_demo.forwardTime )
    {
      Com_Printf(0, &stru_1440E06D8.filename[48]);
    }
    else
    {
      Dvar_SetBool_Internal(DVARBOOL_replay_time, 1);
      ActiveServerApplication = SvGameModeApplication::GetActiveServerApplication();
      FrameDuration = SvGameModeApplication::GetFrameDuration(ActiveServerApplication);
      if ( SV_Cmd_Argc() > 1 )
      {
        v3 = SV_Cmd_Argv(1);
        *((double *)&v5 + 1) = *(&a1 + 1);
        *(double *)&v5 = atof(v3) * (float)(1000.0 / (float)FrameDuration);
        _XMM0 = v5;
        __asm { vcvttsd2si edi, xmm0 }
        v7 = FrameDuration * _EDI;
        if ( v7 > 0 )
        {
          sv_demo.forwardTime = v7 + G_Main_GetTime();
          sv_demo.nextLevelSave = NULL;
          sv_demo.nextLevelTime = 0;
        }
        else
        {
          Com_Printf(0, &stru_1440E06D8.mp.gametype[1]);
        }
      }
      else
      {
        sv_demo.forwardTime = FrameDuration + G_Main_GetTime();
        sv_demo.nextLevelSave = NULL;
        sv_demo.nextLevelTime = 0;
      }
    }
  }
  else
  {
    Com_Printf(0, &stru_1440E06D8.description[248]);
  }
}

/*
==============
SV_DemoMP_GetBuffer
==============
*/
int SV_DemoMP_GetBuffer()
{
  __int64 v0; 
  int result; 

  if ( s_demoMP_history && (!s_demoMP_numFileSkips || s_demoMP_history->time > *((_DWORD *)s_demoMP_fileSkips + 2 * s_demoMP_numFileSkips - 2)) )
  {
    SV_Demo_WaitForSaveHistoryDone();
    if ( s_demoMP_historySaving && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1649, ASSERT_TYPE_ASSERT, "( s_demoMP_historySaving == nullptr )", (const char *)&queryFormat, "s_demoMP_historySaving == nullptr") )
      __debugbreak();
    s_demoMP_historySaving = s_demoMP_history;
    Sys_SetSaveHistoryEvent();
  }
  if ( !BG_GameInterface_GameModeIsMP((GameModeType)(unsigned __int8)SvDemo::ms_allocatedType) && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.h", 173, ASSERT_TYPE_ASSERT, "( BG_GameInterface_GameModeIsMP( ms_allocatedType ) )", (const char *)&queryFormat, "BG_GameInterface_GameModeIsMP( ms_allocatedType )") )
    __debugbreak();
  v0 = 786437i64;
  if ( s_demoMP_historySaving == (server_demo_history_t *volatile)&SvDemo::ms_gServerDemoSystem[786437] )
    v0 = 793055i64;
  s_demoMP_history = (server_demo_history_t *)&SvDemo::ms_gServerDemoSystem[v0];
  SV_DemoMP_FreeHistoryData((server_demo_history_t *)&SvDemo::ms_gServerDemoSystem[v0]);
  memset_0(s_demoMP_history, 0, sizeof(server_demo_history_t));
  result = G_Main_GetTime();
  s_demoMP_history->time = result;
  return result;
}

/*
==============
SV_DemoMP_GetData
==============
*/
__int64 SV_DemoMP_GetData(unsigned __int8 *buf, const int maxBufSize)
{
  int Long; 
  unsigned int v5; 

  if ( !sv_demo.playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1147, ASSERT_TYPE_ASSERT, "( sv_demo.playing )", (const char *)&queryFormat, "sv_demo.playing") )
    __debugbreak();
  if ( sv_demo.serverThreadStarted && !Sys_IsServerThread() && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 957, ASSERT_TYPE_ASSERT, "( Sys_IsServerThread() )", (const char *)&queryFormat, "Sys_IsServerThread()") )
    __debugbreak();
  if ( sv_demo.readType == 12 && (Long = MSG_ReadLong(&sv_demo.msg), v5 = Long, maxBufSize >= Long) )
  {
    MSG_ReadData(&sv_demo.msg, Long, buf, maxBufSize);
    SV_DemoMP_ReadNextDemoType();
    return v5;
  }
  else
  {
    SV_DemoMP_EndDemoError();
    return 0i64;
  }
}

/*
==============
SV_DemoMP_GetHistoryIndex
==============
*/
__int64 SV_DemoMP_GetHistoryIndex(const server_demo_history_t *history)
{
  if ( !BG_GameInterface_GameModeIsMP((GameModeType)(unsigned __int8)SvDemo::ms_allocatedType) && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.h", 173, ASSERT_TYPE_ASSERT, "( BG_GameInterface_GameModeIsMP( ms_allocatedType ) )", (const char *)&queryFormat, "BG_GameInterface_GameModeIsMP( ms_allocatedType )") )
    __debugbreak();
  if ( history == (const server_demo_history_t *)&SvDemo::ms_gServerDemoSystem[793055] )
    return 1i64;
  if ( history != (const server_demo_history_t *)&SvDemo::ms_gServerDemoSystem[786437] && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 267, ASSERT_TYPE_ASSERT, "( history == &svDemo->m_historyBuffers[0] )", (const char *)&queryFormat, "history == &svDemo->m_historyBuffers[0]") )
    __debugbreak();
  return 0i64;
}

/*
==============
SV_DemoMP_GetInt64
==============
*/
unsigned __int64 SV_DemoMP_GetInt64()
{
  unsigned __int64 Int64; 

  if ( !sv_demo.playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1109, ASSERT_TYPE_ASSERT, "( sv_demo.playing )", (const char *)&queryFormat, "sv_demo.playing") )
    __debugbreak();
  if ( sv_demo.serverThreadStarted && !Sys_IsServerThread() && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 957, ASSERT_TYPE_ASSERT, "( Sys_IsServerThread() )", (const char *)&queryFormat, "Sys_IsServerThread()") )
    __debugbreak();
  if ( sv_demo.readType == 9 )
  {
    Int64 = MSG_ReadInt64(&sv_demo.msg);
    SV_DemoMP_ReadNextDemoType();
    return Int64;
  }
  else
  {
    SV_DemoMP_EndDemoError();
    return 0i64;
  }
}

/*
==============
SV_DemoMP_GetStringInBuffer
==============
*/
__int64 SV_DemoMP_GetStringInBuffer(char *buffer, unsigned int size)
{
  if ( !sv_demo.playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 993, ASSERT_TYPE_ASSERT, "( sv_demo.playing )", (const char *)&queryFormat, "sv_demo.playing") )
    __debugbreak();
  if ( sv_demo.serverThreadStarted && !Sys_IsServerThread() && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 957, ASSERT_TYPE_ASSERT, "( Sys_IsServerThread() )", (const char *)&queryFormat, "Sys_IsServerThread()") )
    __debugbreak();
  if ( sv_demo.readType || !MSG_ReadString(&sv_demo.msg, buffer, size) )
  {
    SV_DemoMP_EndDemoError();
    return 0i64;
  }
  else
  {
    SV_DemoMP_ReadNextDemoType();
    return 1i64;
  }
}

/*
==============
SV_DemoMP_HasDemoEnded
==============
*/
bool SV_DemoMP_HasDemoEnded()
{
  return SV_IsDemoPlaying() && sv_demo.readType == -1;
}

/*
==============
SV_DemoMP_HistoryAlloc
==============
*/
__int64 SV_DemoMP_HistoryAlloc(server_demo_history_t *history, unsigned __int8 **pData, unsigned __int64 size)
{
  __int64 HistoryIndex; 
  __int64 v7; 
  SvDemo *v8; 
  unsigned __int64 v9; 
  unsigned __int8 *v10; 
  __int64 result; 

  if ( !size && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 314, ASSERT_TYPE_ASSERT, "( ( size > 0 ) )", "( size ) = %zu", 0i64) )
    __debugbreak();
  if ( !history && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 315, ASSERT_TYPE_ASSERT, "( history )", (const char *)&queryFormat, "history") )
    __debugbreak();
  HistoryIndex = (unsigned int)SV_DemoMP_GetHistoryIndex(history);
  if ( !BG_GameInterface_GameModeIsMP((GameModeType)(unsigned __int8)SvDemo::ms_allocatedType) && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.h", 173, ASSERT_TYPE_ASSERT, "( BG_GameInterface_GameModeIsMP( ms_allocatedType ) )", (const char *)&queryFormat, "BG_GameInterface_GameModeIsMP( ms_allocatedType )") )
    __debugbreak();
  v7 = HistoryIndex;
  v8 = &SvDemo::ms_gServerDemoSystem[HistoryIndex + 786435];
  v9 = (unsigned __int64)v8->__vftable + size;
  if ( v9 > 0x300000 )
  {
    Com_PrintError(1, "SV_HistoryAlloc failed. Needed %zu more memory\n", v9 - 3145728);
    return 0i64;
  }
  else
  {
    v10 = (unsigned __int8 *)&v8->GetCheatsOk + 3145728 * v7 + (unsigned __int64)SvDemo::ms_gServerDemoSystem;
    *pData = v10;
    memset_0(v10, 0, size);
    result = 1i64;
    v8->__vftable = (SvDemo_vtbl *)v9;
  }
  return result;
}

/*
==============
SV_DemoMP_HistoryFree
==============
*/
void SV_DemoMP_HistoryFree(unsigned __int8 *ptr, unsigned __int64 size)
{
  __int64 v4; 
  __int64 v5; 
  SvDemo *v6; 

  if ( !BG_GameInterface_GameModeIsMP((GameModeType)(unsigned __int8)SvDemo::ms_allocatedType) && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.h", 173, ASSERT_TYPE_ASSERT, "( BG_GameInterface_GameModeIsMP( ms_allocatedType ) )", (const char *)&queryFormat, "BG_GameInterface_GameModeIsMP( ms_allocatedType )") )
    __debugbreak();
  v4 = 0i64;
  while ( 1 )
  {
    v5 = 393216i64 * (int)v4;
    if ( ptr >= (unsigned __int8 *)&SvDemo::ms_gServerDemoSystem[v5 + 3] && ptr < (unsigned __int8 *)&SvDemo::ms_gServerDemoSystem[v5 + 393219] )
      break;
    v4 = (unsigned int)(v4 + 1);
    if ( (int)v4 >= 2 )
    {
      if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 283, ASSERT_TYPE_ASSERT, (const char *)&queryFormat.fmt + 3, "SV_GetBufferIndex: ptr 0x%p isn't in either of the history buffers.\n", ptr) )
        __debugbreak();
      v4 = 0i64;
      break;
    }
  }
  if ( !BG_GameInterface_GameModeIsMP((GameModeType)(unsigned __int8)SvDemo::ms_allocatedType) && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.h", 173, ASSERT_TYPE_ASSERT, "( BG_GameInterface_GameModeIsMP( ms_allocatedType ) )", (const char *)&queryFormat, "BG_GameInterface_GameModeIsMP( ms_allocatedType )") )
    __debugbreak();
  v6 = SvDemo::ms_gServerDemoSystem;
  SvDemo::ms_gServerDemoSystem[v4 + 786435].__vftable = (SvDemo_vtbl *)((char *)SvDemo::ms_gServerDemoSystem[v4 + 786435].__vftable - size);
  if ( ptr != (unsigned __int8 *)((char *)&v6[v4 + 786435].GetCheatsOk + 3145728 * v4 + (unsigned __int64)v6) && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 306, ASSERT_TYPE_ASSERT, "( ptr == svDemo->m_buf[bufferIndex] + svDemo->m_bufSize[bufferIndex] )", (const char *)&queryFormat, "ptr == svDemo->m_buf[bufferIndex] + svDemo->m_bufSize[bufferIndex]") )
    __debugbreak();
}

/*
==============
SV_DemoMP_HostNum
==============
*/
__int64 SV_DemoMP_HostNum()
{
  if ( !BG_GameInterface_GameModeIsMP((GameModeType)(unsigned __int8)SvDemo::ms_allocatedType) && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.h", 173, ASSERT_TYPE_ASSERT, "( BG_GameInterface_GameModeIsMP( ms_allocatedType ) )", (const char *)&queryFormat, "BG_GameInterface_GameModeIsMP( ms_allocatedType )") )
    __debugbreak();
  return LODWORD(SvDemo::ms_gServerDemoSystem[865216].__vftable);
}

/*
==============
SV_DemoMP_Info_f
==============
*/
void SV_DemoMP_Info_f(void)
{
  __int64 v0; 
  unsigned int i; 
  SvClient *CommonClient; 
  int v3; 
  unsigned int *v4; 
  int cursize; 
  __int64 v6; 

  Com_Printf(0, "Active clients:\n");
  v0 = 0i64;
  for ( i = 0; (int)i < (int)SvClient::ms_clientCount; ++i )
  {
    if ( SvClient::GetCommonClient(i)->state == CS_ACTIVE )
    {
      if ( (_BYTE)SvClient::ms_allocatedType != HALF_HALF && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_client_mp.h", 957, ASSERT_TYPE_ASSERT, "( ms_allocatedType == ALLOCATION_TYPE )", (const char *)&queryFormat, "ms_allocatedType == ALLOCATION_TYPE") )
        __debugbreak();
      CommonClient = SvClient::GetCommonClient(i);
      Com_Printf(0, "clientNum: %i -> %s (%s)\n", i, &CommonClient[4].lastUsercmd.selectedLoc[1], (const char *)&CommonClient[854].lastUsercmd.sightedClientsMask.data[2]);
    }
  }
  if ( s_demoMP_numFileSkips > 0 )
  {
    if ( s_demoMP_fileTimeHistory.handle == -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 3517, ASSERT_TYPE_ASSERT, "( s_demoMP_fileTimeHistory != INVALID_SYS_FILE_HANDLE )", (const char *)&queryFormat, "s_demoMP_fileTimeHistory != INVALID_SYS_FILE_HANDLE") )
      __debugbreak();
    Com_Printf(0, "\nTime Marks(%d):\n", (unsigned int)s_demoMP_numFileSkips);
    v3 = 0;
    if ( s_demoMP_numFileSkips > 0 )
    {
      v4 = (unsigned int *)s_demoMP_fileSkips;
      do
      {
        Com_Printf(0, "\t%d:%d\n", *v4, v4[1]);
        ++v3;
        v4 += 2;
      }
      while ( v3 < s_demoMP_numFileSkips );
    }
  }
  if ( SV_Demo_IsRecording() )
  {
    cursize = sv_demo.msg.cursize;
    Com_Printf(15, "Demo Msg Profile:\n");
    Com_Printf(15, "\n\ntype\t\t\t\tbytes\tperc\n");
    v6 = 13i64;
    do
    {
      Com_Printf(15, "%s\t\t\t%i\t%.2f\n", serverDemoTypeNames[v0], (unsigned int)s_svdMsgProf[v0].total, (float)((float)((float)s_svdMsgProf[v0].total * 100.0) * (float)(1.0 / (float)cursize)));
      ++v0;
      --v6;
    }
    while ( v6 );
    Com_Printf(15, "total size: \t\t\t%i bytes\n\n", (unsigned int)cursize);
  }
}

/*
==============
SV_DemoMP_Init
==============
*/
void SV_DemoMP_Init(const SvServerInitSettings *initSettings, SaveGame *save, unsigned int *randomSeed, int *levelTime)
{
  if ( !initSettings && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2692, ASSERT_TYPE_ASSERT, "( initSettings )", (const char *)&queryFormat, "initSettings") )
    __debugbreak();
  if ( SV_DemoMP_InitSavegame(initSettings, save) )
  {
    SV_IsDemoPlayingNext();
    if ( SV_IsDemoPlayingNext() )
      SV_DemoMP_InitRead(randomSeed, levelTime);
    else
      SV_DemoMP_InitWrite(*randomSeed, *levelTime);
  }
  else
  {
    if ( SV_IsDemoPlayingNext() && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2711, ASSERT_TYPE_ASSERT, "( !SV_IsDemoPlayingNext() )", (const char *)&queryFormat, "!SV_IsDemoPlayingNext()") )
      __debugbreak();
    if ( SV_IsDemoPlaying() && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2712, ASSERT_TYPE_ASSERT, "( !SV_IsDemoPlaying() )", (const char *)&queryFormat, "!SV_IsDemoPlaying()") )
      __debugbreak();
    if ( SV_Demo_IsRecording() && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2713, ASSERT_TYPE_ASSERT, "( !SV_Demo_IsRecording() )", (const char *)&queryFormat, "!SV_Demo_IsRecording()") )
      __debugbreak();
  }
}

/*
==============
SV_DemoMP_InitClientForReplay
==============
*/
void SV_DemoMP_InitClientForReplay(const int clientNum)
{
  unsigned __int8 *m_ptr; 
  unsigned __int8 *v3; 
  const SvClientMP *CommonClient; 
  int v5; 
  const unsigned __int8 *v6; 
  msg_t buf; 
  __int64 v8; 
  Mem_LargeLocal v9; 
  Mem_LargeLocal data; 
  int compressedSize; 

  v8 = -2i64;
  Mem_LargeLocal::Mem_LargeLocal(&data, 0x243D8ui64, "max_msg_buf bufData");
  m_ptr = (unsigned __int8 *)data.m_ptr;
  Mem_LargeLocal::Mem_LargeLocal(&v9, 0x243D8ui64, "max_msg_buf compressedBuf");
  v3 = (unsigned __int8 *)v9.m_ptr;
  if ( (_BYTE)SvClient::ms_allocatedType != HALF_HALF && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_client_mp.h", 957, ASSERT_TYPE_ASSERT, "( ms_allocatedType == ALLOCATION_TYPE )", (const char *)&queryFormat, "ms_allocatedType == ALLOCATION_TYPE") )
    __debugbreak();
  CommonClient = (const SvClientMP *)SvClient::GetCommonClient(clientNum);
  if ( CommonClient->demorecording && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2119, ASSERT_TYPE_ASSERT, "( !client->demorecording )", (const char *)&queryFormat, "!client->demorecording") )
    __debugbreak();
  CommonClient->demowrite = SV_DemoMP_WriteToClient;
  *(_WORD *)&CommonClient->demorecording = 1;
  CommonClient->demoFirstMessage = CommonClient->netchan.outgoingSequence;
  CommonClient->demoWriteMessage = 1;
  CL_DemoServerPlayback_SvWriteClientStats(SV_DemoMP_WriteToClient, clientNum, CommonClient->stats, 0x10470u);
  MSG_Init(&buf, m_ptr, 148440);
  MSG_WriteLong(&buf, CommonClient->commandSequence);
  SV_ClientMP_WriteDemoGamestate(CommonClient, &buf);
  MSG_WriteData(&buf, CommonClient->stats, 66672);
  if ( buf.cursize < 4 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2143, ASSERT_TYPE_ASSERT, "(buf.cursize >= 4)", (const char *)&queryFormat, "buf.cursize >= CL_DECODE_START") )
    __debugbreak();
  *(_DWORD *)v3 = *(_DWORD *)buf.data;
  v5 = buf.cursize - 4;
  v6 = buf.data + 4;
  *(_DWORD *)v3 |= 0x40000000u;
  if ( !MSG_WriteBitsCompress(0, v6, v3 + 4, v5, 148436, &compressedSize) && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2153, ASSERT_TYPE_ASSERT, "(MSG_WriteBitsCompress( false, fromBuffer, toBuffer, fromSize, toSize, compressedSize ))", (const char *)&queryFormat, "MSG_WriteBitsCompress( false, fromBuffer, toBuffer, fromSize, toSize, compressedSize )") )
    __debugbreak();
  compressedSize += 4;
  if ( !CommonClient->demowrite && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2156, ASSERT_TYPE_ASSERT, "( client->demowrite )", (const char *)&queryFormat, "client->demowrite") )
    __debugbreak();
  if ( !BG_GameInterface_GameModeIsMP((GameModeType)(unsigned __int8)SvDemo::ms_allocatedType) && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.h", 173, ASSERT_TYPE_ASSERT, "( BG_GameInterface_GameModeIsMP( ms_allocatedType ) )", (const char *)&queryFormat, "BG_GameInterface_GameModeIsMP( ms_allocatedType )") )
    __debugbreak();
  CL_DemoServerPlayback_SvWriteGamestate(CommonClient->demowrite, clientNum, (const int)SvDemo::ms_gServerDemoSystem[906178].__vftable, CommonClient->reliableSequence, v3, compressedSize);
  Mem_LargeLocal::~Mem_LargeLocal(&v9);
  Mem_LargeLocal::~Mem_LargeLocal(&data);
}

/*
==============
SV_DemoMP_InitRead
==============
*/
void SV_DemoMP_InitRead(unsigned int *randomSeed, int *levelTime)
{
  SvGameGlobalsMP *SvGameGlobalsMP; 
  const dvar_t *v5; 
  unsigned int Byte; 
  bool v7; 
  int Long; 
  unsigned __int64 Int64; 
  int v10; 
  int v11; 
  int nextLevelTime; 
  char *fmt; 
  XSESSION_INFO buffer; 

  if ( !SvDemo::ms_gServerDemoSystem && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2584, ASSERT_TYPE_ASSERT, "( SvDemo::IsSystemEnabled() )", (const char *)&queryFormat, "SvDemo::IsSystemEnabled()", -2i64) )
    __debugbreak();
  if ( !randomSeed && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2585, ASSERT_TYPE_ASSERT, "( randomSeed )", (const char *)&queryFormat, "randomSeed") )
    __debugbreak();
  if ( !sv_demo.nextLevelplaying && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2587, ASSERT_TYPE_ASSERT, "( sv_demo.nextLevelplaying )", (const char *)&queryFormat, "sv_demo.nextLevelplaying") )
    __debugbreak();
  sv_demo.nextLevelplaying = 0;
  sv_demo.playing = 1;
  MSG_BeginReading(&sv_demo.msg);
  if ( sv_demo.nextLevelSave )
  {
    *randomSeed = sv_demo.nextLevelSave->randomSeed;
    *levelTime = SvPersistentGlobalsMP::GetPersistentGlobalsMP()->time;
    sv_serverId_value = sv_demo.nextLevelSave->serverId;
    sv_demo.nextFramePos = sv_demo.nextLevelSave->nextFramePos;
    fs_checksumFeed = sv_demo.nextLevelSave->checksumFeed;
    sv_demo.msg.readcount = sv_demo.nextLevelSave->msgReadcount;
    sv_demo.msg.bit = 8 * sv_demo.msg.readcount;
    sv_demo.readType = sv_demo.nextLevelSave->readType;
    if ( sv_demo.readType == 11 )
      SV_DemoMP_ReadNextDemoType();
  }
  else
  {
    bdSecurityID::bdSecurityID(&buffer.m_security.m_id);
    bdSecurityKey::bdSecurityKey(&buffer.m_security.m_key);
    SvGameGlobalsMP = SvGameGlobalsMP::GetSvGameGlobalsMP();
    v5 = DVARFLT_replay_speed;
    if ( !DVARFLT_replay_speed && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\universal\\dvar_api.h", 759, ASSERT_TYPE_ASSERT, "( dvar )", "Dvar accessed after deregistration") )
      __debugbreak();
    Dvar_Reset(v5, DVAR_SOURCE_INTERNAL);
    Byte = MSG_ReadByte(&sv_demo.msg);
    if ( Byte != 5 )
    {
      SV_Demo_ResetDemo();
      LODWORD(fmt) = 5;
      Com_Error_impl(ERR_DROP, (const ObfuscateErrorText)&stru_1440DFF80, 342i64, Byte, fmt);
    }
    v7 = MSG_ReadByte(&sv_demo.msg) != 0;
    if ( v7 != Sys_IsServerThread() )
    {
      SV_Demo_ResetDemo();
      Com_Error_impl(ERR_DROP, (const ObfuscateErrorText)&stru_1440DFFE0, 343i64);
    }
    Long = MSG_ReadLong(&sv_demo.msg);
    if ( Long != SvGameGlobalsMP->cachedNetDataChecksum )
    {
      SV_Demo_ResetDemo();
      LODWORD(fmt) = Long;
      Com_Error_impl(ERR_DROP, (const ObfuscateErrorText)&stru_1440E0070, 344i64, SvGameGlobalsMP->cachedNetDataChecksum, fmt);
    }
    Int64 = MSG_ReadInt64(&sv_demo.msg);
    if ( Int64 != SvGameGlobalsMP->m_requiredStatsBitMask )
    {
      SV_Demo_ResetDemo();
      Com_Error_impl(ERR_DROP, (const ObfuscateErrorText)&stru_1440E00F0, 345i64, SvGameGlobalsMP->m_requiredStatsBitMask, Int64);
    }
    *randomSeed = MSG_ReadLong(&sv_demo.msg);
    *levelTime = SvPersistentGlobalsMP::GetPersistentGlobalsMP()->time;
    sv_serverId_value = MSG_ReadLong(&sv_demo.msg);
    v10 = MSG_ReadByte(&sv_demo.msg);
    SV_InitMP_SetServerRestarting(v10 != 0);
    fs_checksumFeed = MSG_ReadLong(&sv_demo.msg);
    *(_DWORD *)(*((_QWORD *)NtCurrentTeb()->Reserved1[11] + tls_index) + 1048i64) = MSG_ReadLong(&sv_demo.msg);
    MSG_ReadData(&sv_demo.msg, 108, &buffer, 108);
    NET_SetDemoSession(&buffer);
    sv_demo.nextFramePos = -1;
    SV_DemoMP_ReadNextDemoType();
    bdSecurityKey::~bdSecurityKey(&buffer.m_security.m_key);
    bdSecurityID::~bdSecurityID(&buffer.m_security.m_id);
  }
  if ( !BG_GameInterface_GameModeIsMP((GameModeType)(unsigned __int8)SvDemo::ms_allocatedType) && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.h", 173, ASSERT_TYPE_ASSERT, "( BG_GameInterface_GameModeIsMP( ms_allocatedType ) )", (const char *)&queryFormat, "BG_GameInterface_GameModeIsMP( ms_allocatedType )") )
    __debugbreak();
  SvDemo::ms_gServerDemoSystem[906178].__vftable = (SvDemo_vtbl *)1;
  SV_DemoMP_ClearBaseline();
  if ( sv_demo.nextLevelTime )
  {
    v11 = sv_demo.nextLevelTime - G_Main_GetTime();
    nextLevelTime = 0;
    if ( v11 > 0 )
      nextLevelTime = sv_demo.nextLevelTime;
    sv_demo.forwardTime = nextLevelTime;
    sv_demo.nextLevelTime = 0;
  }
}

/*
==============
SV_DemoMP_InitSavegame
==============
*/
char SV_DemoMP_InitSavegame(const SvServerInitSettings *initSettings, SaveGame *save)
{
  SvDemo *v5; 
  const PartyData *ServerLobby; 
  int v7; 
  server_demo_save_t *p_save; 
  SaveGame *SaveHandle; 
  MemoryFile *MemoryFile; 
  scrContext_t *v11; 
  const char *v12; 
  sysFileHandle_t *handle; 

  if ( !initSettings && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2001, ASSERT_TYPE_ASSERT, "( initSettings )", (const char *)&queryFormat, "initSettings") )
    __debugbreak();
  if ( SvDemo::ms_gServerDemoSystem )
  {
    if ( SV_IsDemoPlayingNext() )
    {
      if ( !sv_demo.nextLevelplaying && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1924, ASSERT_TYPE_ASSERT, "( sv_demo.nextLevelplaying )", (const char *)&queryFormat, "sv_demo.nextLevelplaying") )
        __debugbreak();
      if ( save )
      {
        s_demoMP_numFileSkips = 0;
        s_demoMP_writtenFileTimeHistory = 0i64;
        if ( s_demoMP_fileTimeHistory.handle != -1 )
          FS_FileSeek(s_demoMP_fileTimeHistory, 0i64, 2);
        sv_demo.autoSaveTime = 0;
      }
      else
      {
        if ( sv_demo.nextLevelSave )
          p_save = &sv_demo.nextLevelSave->save;
        else
          p_save = &sv_demo.save;
        if ( !p_save->buf && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1935, ASSERT_TYPE_ASSERT, "( save->buf )", (const char *)&queryFormat, "save->buf") )
          __debugbreak();
        SaveHandle = G_SaveMemoryMP_GetSaveHandle(SAVE_DEMO_HANDLE);
        G_SaveMemory_InitializeLoadFromBuffer(SaveHandle, p_save->buf, p_save->bufLen, 1);
        SaveHandle->header.demoPlayback = 1;
        MemoryFile = SaveMemory_GetMemoryFile(SaveHandle);
        Dvar_LoadDvars(MemoryFile);
        v11 = ScriptContext_Server();
        Scr_SkipSource(v11, MemoryFile, MEMCARD_INVALID_FILE_HANDLE_1, SaveHandle->header.hasScriptSource);
        BG_GameStateInfo_LoadState(MemoryFile);
        if ( sv_demo.nextLevelSave )
        {
          if ( s_demoMP_fileTimeHistory.handle == -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1952, ASSERT_TYPE_ASSERT, "( s_demoMP_fileTimeHistory != INVALID_SYS_FILE_HANDLE )", (const char *)&queryFormat, "s_demoMP_fileTimeHistory != INVALID_SYS_FILE_HANDLE") )
            __debugbreak();
          handle = (sysFileHandle_t *)s_demoMP_fileTimeHistory.handle;
        }
        else
        {
          handle = SV_DemoMP_OpenFileRead(DEMO_MP_CACHE_FILEPATH, v12);
        }
        p_save->file.handle = (__int64)handle;
        if ( handle == (sysFileHandle_t *)-1i64 )
          G_SaveError(SAVE_ERROR_CORRUPT_SAVE, &byte_1440DFA40);
        SV_DemoMP_LoadDemoInitState(MemoryFile, p_save->file);
        G_MainMP_RegisterGametypeDvars(initSettings->gameType);
      }
      return 1;
    }
    else
    {
      SV_DemoMP_ClearSavegame();
      if ( !BG_GameInterface_GameModeIsMP((GameModeType)(unsigned __int8)SvDemo::ms_allocatedType) && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.h", 173, ASSERT_TYPE_ASSERT, "( BG_GameInterface_GameModeIsMP( ms_allocatedType ) )", (const char *)&queryFormat, "BG_GameInterface_GameModeIsMP( ms_allocatedType )") )
        __debugbreak();
      v5 = SvDemo::ms_gServerDemoSystem;
      ServerLobby = SV_MainMP_GetServerLobby();
      if ( Party_IsHostDedicated(ServerLobby) )
        v7 = -2;
      else
        v7 = Party_HostNum(ServerLobby);
      LODWORD(v5[865216].__vftable) = v7;
      return SV_DemoMP_AddDemoSave(&sv_demo.save, initSettings->isRestart, 0, (const char *)DEMO_MP_CACHE_FILEPATH);
    }
  }
  else
  {
    sv_demo.nextLevelplaying = 0;
    SV_Demo_ResetDemo();
    SV_DemoMP_ClearSavegame();
    return 0;
  }
}

/*
==============
SV_DemoMP_InitSystem
==============
*/
void SV_DemoMP_InitSystem(__int64 a1, const char *a2)
{
  sysFileHandle_t *v2; 

  if ( s_demoMP_fileTimeHistory.handle != -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1461, ASSERT_TYPE_ASSERT, "( s_demoMP_fileTimeHistory == INVALID_SYS_FILE_HANDLE )", (const char *)&queryFormat, "s_demoMP_fileTimeHistory == INVALID_SYS_FILE_HANDLE") )
    __debugbreak();
  v2 = SV_DemoMP_OpenFile(DEMO_MP_TIMEHISTORY_FILEPATH, a2);
  *(__m256i *)&s_svdMsgProf[0].start = _ymm;
  *(__m256i *)&s_svdMsgProf[4].start = _ymm;
  *(__m256i *)&s_svdMsgProf[8].start = _ymm;
  s_demoMP_fileTimeHistory.handle = (__int64)v2;
  s_svdMsgProf[12].start = -1;
  s_svdMsgProf[12].total = 0;
}

/*
==============
SV_DemoMP_InitWrite
==============
*/
void SV_DemoMP_InitWrite(unsigned int randomSeed, int levelTime)
{
  unsigned __int8 *data; 
  SvGameGlobalsMP *SvGameGlobalsMP; 
  bool IsServerThread; 
  const XSESSION_INFO *DemoSession; 

  if ( !SvDemo::ms_gServerDemoSystem && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2546, ASSERT_TYPE_ASSERT, "( SvDemo::IsSystemEnabled() )", (const char *)&queryFormat, "SvDemo::IsSystemEnabled()") )
    __debugbreak();
  if ( sv_demo.nextLevelplaying && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2547, ASSERT_TYPE_ASSERT, "( !sv_demo.nextLevelplaying )", (const char *)&queryFormat, "!sv_demo.nextLevelplaying") )
    __debugbreak();
  data = sv_demo.msg.data;
  sv_demo.changed = 0;
  if ( sv_demo.msg.data )
  {
    data = NULL;
    sv_demo.msg.maxsize = 0;
    sv_demo.msg.data = NULL;
  }
  s_svdMsgProf[12].start = -1;
  s_svdMsgProf[12].total = 0;
  sv_demo.recording = 1;
  sv_demo.startTime = levelTime;
  sv_demo.autoSaveTime = levelTime;
  *(__m256i *)&s_svdMsgProf[0].start = _ymm;
  *(__m256i *)&s_svdMsgProf[4].start = _ymm;
  *(__m256i *)&s_svdMsgProf[8].start = _ymm;
  if ( data && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2554, ASSERT_TYPE_ASSERT, "( !sv_demo.msg.data )", (const char *)&queryFormat, "!sv_demo.msg.data") )
    __debugbreak();
  MSG_Init(&sv_demo.msg, NULL, 0);
  SV_DemoMP_CheckSize();
  SvGameGlobalsMP = SvGameGlobalsMP::GetSvGameGlobalsMP();
  MSG_WriteByte(&sv_demo.msg, 5i64);
  IsServerThread = Sys_IsServerThread();
  MSG_WriteByte(&sv_demo.msg, IsServerThread);
  MSG_WriteLong(&sv_demo.msg, SvGameGlobalsMP->cachedNetDataChecksum);
  MSG_WriteInt64(&sv_demo.msg, SvGameGlobalsMP->m_requiredStatsBitMask);
  MSG_WriteLong(&sv_demo.msg, randomSeed);
  MSG_WriteLong(&sv_demo.msg, sv_serverId_value);
  MSG_WriteByte(&sv_demo.msg, LOBYTE(SvGameGlobalsMP->restarting));
  MSG_WriteLong(&sv_demo.msg, fs_checksumFeed);
  MSG_WriteLong(&sv_demo.msg, *(_DWORD *)(*((_QWORD *)NtCurrentTeb()->Reserved1[11] + tls_index) + 1048i64));
  DemoSession = NET_GetDemoSession();
  MSG_WriteData(&sv_demo.msg, DemoSession, 108);
  s_demoMP_numFileSkips = 0;
  s_demoMP_writtenFileTimeHistory = 0i64;
  if ( s_demoMP_fileTimeHistory.handle != -1 )
    FS_FileSeek(s_demoMP_fileTimeHistory, 0i64, 2);
}

/*
==============
SV_DemoMP_LoadDemo
==============
*/
void SV_DemoMP_LoadDemo(const SaveHeader *header, MemoryFile *memFile, MemCardFileHandle fileHandle)
{
  MemoryFile *v4; 
  const SaveHeader *v5; 
  void *m_ptr; 
  unsigned int v7; 
  const char *v8; 
  sysFileHandle_t *handle; 
  int v10; 
  int v11; 
  unsigned __int64 v12; 
  __int64 v13; 
  int v14; 
  bool v15; 
  SvDemo *v16; 
  int buffer; 
  __int64 v18; 
  Mem_LargeLocal ptr[3]; 
  int v22; 

  v18 = -2i64;
  v4 = memFile;
  v5 = header;
  Mem_LargeLocal::Mem_LargeLocal(ptr, 0x20000ui64, "saveBuf_t saveBuf");
  m_ptr = ptr[0].m_ptr;
  sv_demo.nextLevelSave = NULL;
  sv_demo.nextLevelTime = 0;
  SV_Demo_ResetDemo();
  sv_demo.changed = 0;
  if ( sv_demo.msg.data )
  {
    sv_demo.msg.data = NULL;
    sv_demo.msg.maxsize = 0;
  }
  *(__m256i *)&s_svdMsgProf[0].start = _ymm;
  *(__m256i *)&s_svdMsgProf[4].start = _ymm;
  *(__m256i *)&s_svdMsgProf[8].start = _ymm;
  s_svdMsgProf[12].start = -1;
  s_svdMsgProf[12].total = 0;
  if ( sv_demo.save.buf )
  {
    SV_DemoMP_HistoryFree(sv_demo.save.buf, sv_demo.save.bufLen);
    sv_demo.save.buf = NULL;
    sv_demo.save.bufLen = 0i64;
  }
  if ( sv_demo.save.file.handle != -1 )
  {
    FS_FileClose((HANDLE)sv_demo.save.file.handle);
    sv_demo.save.file.handle = -1i64;
  }
  v7 = MemCard_FilePosition(fileHandle);
  Com_Printf(15, "Load:%i\n", v7);
  ReadFromDevice(&sv_demo, 4ui64, fileHandle);
  ReadFromDevice(&sv_demo.endTime, 4ui64, fileHandle);
  ReadFromDevice(&buffer, 4ui64, fileHandle);
  if ( sv_demo.msg.data && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2856, ASSERT_TYPE_ASSERT, "( !sv_demo.msg.data )", (const char *)&queryFormat, "!sv_demo.msg.data") )
    __debugbreak();
  if ( !SV_DemoMP_MsgAlloc(buffer) )
    Mem_Error_CannotAlloc_Dev(COUNT|DODGE|0x8, "SV_DemoMP_LoadDemo", "c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2859, "Out of memory for msg");
  MSG_Init(&sv_demo.msg, sv_demo.msg.data, sv_demo.msg.maxsize);
  sv_demo.msg.cursize = buffer;
  ReadFromDevice(sv_demo.msg.data, buffer, fileHandle);
  ReadFromDevice(&v22, 4ui64, fileHandle);
  handle = SV_DemoMP_OpenFile(DEMO_MP_CACHE_FILEPATH, v8);
  sv_demo.save.file.handle = (__int64)handle;
  if ( handle == (sysFileHandle_t *)-1i64 )
  {
    G_SaveError(SAVE_ERROR_CORRUPT_SAVE, &byte_1440E0480);
    handle = (sysFileHandle_t *)sv_demo.save.file.handle;
  }
  v10 = v22;
  if ( v22 )
  {
    do
    {
      v11 = 0x20000;
      if ( v10 < 0x20000 )
        v11 = v10;
      v12 = ReadFromDevice(m_ptr, v11, fileHandle);
      v13 = FS_FileWrite(m_ptr, v12, sv_demo.save.file);
      v14 = v13;
      if ( (unsigned __int64)(v13 + 0x80000000i64) > 0xFFFFFFFF && CoreAssert_Handler("c:\\workspace\\iw8\\shared\\codware\\core\\core_assert.h", 385, ASSERT_TYPE_ASSERT, (const char *)&queryFormat.fmt + 3, "%s (SmallType) %s 0x%jx == (BigType) %s 0x%jx", "int __cdecl truncate_cast_impl<int,__int64>(__int64)", "signed", (int)v13, "signed", v13) )
        __debugbreak();
      v15 = v22 == v14;
      v10 = v22 - v14;
      v22 -= v14;
    }
    while ( !v15 );
    handle = (sysFileHandle_t *)sv_demo.save.file.handle;
    v5 = header;
    v4 = memFile;
  }
  FS_FileClose(handle);
  sv_demo.save.file.handle = -1i64;
  if ( !v5->bodySize && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2885, ASSERT_TYPE_ASSERT, "( header->bodySize )", (const char *)&queryFormat, "header->bodySize") )
    __debugbreak();
  sv_demo.save.bufLen = v5->bodySize;
  if ( !BG_GameInterface_GameModeIsMP((GameModeType)(unsigned __int8)SvDemo::ms_allocatedType) && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.h", 173, ASSERT_TYPE_ASSERT, "( BG_GameInterface_GameModeIsMP( ms_allocatedType ) )", (const char *)&queryFormat, "BG_GameInterface_GameModeIsMP( ms_allocatedType )") )
    __debugbreak();
  v16 = SvDemo::ms_gServerDemoSystem;
  if ( sv_demo.save.buf && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2890, ASSERT_TYPE_ASSERT, "( !sv_demo.save.buf )", (const char *)&queryFormat, "!sv_demo.save.buf") )
    __debugbreak();
  if ( !(unsigned int)SV_DemoMP_HistoryAlloc((server_demo_history_t *)&v16[786437], &sv_demo.save.buf, sv_demo.save.bufLen) )
    Mem_Error_CannotAlloc_Dev(COUNT|DODGE|0x8, "SV_DemoMP_LoadDemo", "c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2893, "Out of memory for history buffer");
  MemFile_CopySegments(v4, 0, sv_demo.save.buf);
  Mem_LargeLocal::~Mem_LargeLocal(ptr);
}

/*
==============
SV_DemoMP_LoadDemoInitState
==============
*/
void SV_DemoMP_LoadDemoInitState(MemoryFile *memFile, sysFileHandle_t fileDemo)
{
  int v3; 
  signed int v4; 
  SvClientMP *CommonClient; 
  int agentCount; 
  GameStateInfo *v7; 
  __int64 v8; 
  __int64 v9; 
  int ptr; 
  int v11; 

  G_SaveMP_LoadInitState(memFile);
  if ( !BG_GameInterface_GameModeIsMP((GameModeType)(unsigned __int8)SvDemo::ms_allocatedType) && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.h", 173, ASSERT_TYPE_ASSERT, "( BG_GameInterface_GameModeIsMP( ms_allocatedType ) )", (const char *)&queryFormat, "BG_GameInterface_GameModeIsMP( ms_allocatedType )") )
    __debugbreak();
  FS_FileRead(&SvDemo::ms_gServerDemoSystem[865216], 4ui64, fileDemo);
  FS_FileRead(&ptr, 4ui64, fileDemo);
  v3 = ptr;
  if ( ptr != SvClient::ms_clientCount )
  {
    LODWORD(v8) = ptr;
    if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1694, ASSERT_TYPE_ASSERT, "( clientCount ) == ( SvClient::GetClientCount() )", "clientCount == SvClient::GetClientCount()\n\t%i, %i", v8, SvClient::ms_clientCount) )
      __debugbreak();
    v3 = ptr;
  }
  v4 = 0;
  if ( v3 > 0 )
  {
    do
    {
      if ( (_BYTE)SvClient::ms_allocatedType != HALF_HALF && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_client_mp.h", 957, ASSERT_TYPE_ASSERT, "( ms_allocatedType == ALLOCATION_TYPE )", (const char *)&queryFormat, "ms_allocatedType == ALLOCATION_TYPE") )
        __debugbreak();
      CommonClient = (SvClientMP *)SvClient::GetCommonClient(v4);
      SvClientMP::ClearClientMemoryMP(CommonClient);
      SvClientMP::DemoReadState(CommonClient, fileDemo);
      Netchan_SetUpBuffers(&CommonClient->netchan, (unsigned __int8 *)CommonClient->netBuf.netchanBuffer, 4096);
      ++v4;
    }
    while ( v4 < ptr );
  }
  FS_FileRead(&v11, 4ui64, fileDemo);
  agentCount = SvPersistentGlobalsMP::GetPersistentGlobalsMP()->agentCount;
  if ( agentCount != v11 )
  {
    LODWORD(v9) = v11;
    LODWORD(v8) = agentCount;
    if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1711, ASSERT_TYPE_ASSERT, "( svPers->agentCount ) == ( agentCount )", "svPers->agentCount == agentCount\n\t%i, %i", v8, v9) )
      __debugbreak();
  }
  v7 = GameStateInfo_Get();
  if ( !v7 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1714, ASSERT_TYPE_ASSERT, "( gInfo )", (const char *)&queryFormat, "gInfo") )
    __debugbreak();
  if ( v7->agentMaxCount != v11 )
  {
    LODWORD(v9) = v11;
    LODWORD(v8) = v7->agentMaxCount;
    if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1715, ASSERT_TYPE_ASSERT, "( gInfo->agentMaxCount ) == ( agentCount )", "gInfo->agentMaxCount == agentCount\n\t%i, %i", v8, v9) )
      __debugbreak();
  }
}

/*
==============
SV_DemoMP_LoadHistory
==============
*/
bool SV_DemoMP_LoadHistory(sysFileHandle_t fileHistory, const int fileOffset)
{
  __int64 v2; 
  server_demo_history_t *v5; 
  unsigned __int64 bufLen; 
  char ptr; 

  v2 = fileOffset;
  if ( fileHistory.handle == -1 )
    return 0;
  while ( s_demoMP_historySaving )
    Sys_Sleep(1);
  if ( FS_FileSeek(fileHistory, v2, 2) )
  {
    Com_PrintError(1, &stru_1440E06D8.buildNumber[112]);
    return 0;
  }
  SV_DemoMP_FreeHistoryData(s_demoMP_history);
  v5 = s_demoMP_history;
  if ( !s_demoMP_history && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 3093, ASSERT_TYPE_ASSERT, "( history )", (const char *)&queryFormat, "history") )
    __debugbreak();
  if ( !SV_DemoMP_ReadInflate(v5, 0xCED0ui64, fileHistory) )
  {
    memset_0(v5, 0, sizeof(server_demo_history_t));
    return 0;
  }
  bufLen = v5->save.bufLen;
  if ( bufLen && (unsigned int)SV_DemoMP_HistoryAlloc(v5, &v5->save.buf, v5->save.bufLen) && SV_DemoMP_ReadInflate(v5->save.buf, bufLen, fileHistory) && v5->freeEntBufLen > 0 && SV_DemoMP_AllocRead(v5, &v5->freeEntBuf, v5->freeEntBufLen, fileHistory) )
    return FS_FileRead(&ptr, 4ui64, fileHistory) != 0;
  memset_0(v5, 0, sizeof(server_demo_history_t));
  return 0;
}

/*
==============
SV_DemoMP_LoadHistoryForTime
==============
*/
void SV_DemoMP_LoadHistoryForTime(const int time)
{
  int v2; 
  FileSkip *v3; 
  int v4; 

  SV_DemoMP_GetBuffer();
  SV_Demo_WaitForSaveHistoryDone();
  v2 = 0;
  if ( s_demoMP_numFileSkips > 0 )
  {
    v3 = s_demoMP_fileSkips;
    do
    {
      if ( v3->time > time )
        break;
      ++v2;
      v3 = (FileSkip *)((char *)v3 + 8);
    }
    while ( v2 < s_demoMP_numFileSkips );
  }
  if ( !v2 )
    goto LABEL_13;
  if ( v2 - 1 >= s_demoMP_numFileSkips && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 3158, ASSERT_TYPE_ASSERT, &stru_1440E06D8.description[8], (const char *)&queryFormat, &stru_1440E06D8.screenShotName[24]) )
    __debugbreak();
  v4 = v2 == 1 ? 0 : *((_DWORD *)s_demoMP_fileSkips + 2 * v2 - 3);
  if ( !SV_DemoMP_LoadHistory(s_demoMP_fileTimeHistory, v4) )
  {
LABEL_13:
    if ( s_demoMP_history )
    {
      SV_DemoMP_FreeHistoryData(s_demoMP_history);
      s_demoMP_history = NULL;
    }
  }
}

/*
==============
SV_DemoMP_MsgAlloc
==============
*/
char SV_DemoMP_MsgAlloc(unsigned __int64 maxsize)
{
  if ( sv_demo.msg.data && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 362, ASSERT_TYPE_ASSERT, "( !sv_demo.msg.data )", (const char *)&queryFormat, "!sv_demo.msg.data") )
    __debugbreak();
  if ( !BG_GameInterface_GameModeIsMP((GameModeType)(unsigned __int8)SvDemo::ms_allocatedType) && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.h", 173, ASSERT_TYPE_ASSERT, "( BG_GameInterface_GameModeIsMP( ms_allocatedType ) )", (const char *)&queryFormat, "BG_GameInterface_GameModeIsMP( ms_allocatedType )") )
    __debugbreak();
  if ( (SvDemo_vtbl *)maxsize > SvDemo::ms_gServerDemoSystem[2].__vftable )
    return 0;
  sv_demo.msg.data = (unsigned __int8 *)SvDemo::ms_gServerDemoSystem[1].__vftable;
  sv_demo.msg.maxsize = truncate_cast<int,unsigned __int64>((unsigned __int64)SvDemo::ms_gServerDemoSystem[2].__vftable);
  memset_0(sv_demo.msg.data, 0, sv_demo.msg.maxsize);
  return 1;
}

/*
==============
SV_DemoMP_OpenFile
==============
*/
sysFileHandle_t *SV_DemoMP_OpenFile(sysFileHandle_t *result, const char *fileName)
{
  const char *DevHddPath; 
  const char *v4; 
  char ospath[256]; 

  DevHddPath = Sys_GetDevHddPath();
  FS_BuildOSPath(DevHddPath, (const char *)&queryFormat.fmt + 3, (const char *)result, (char (*)[256])ospath);
  if ( !FS_CreatePath(ospath) )
    return FS_FileOpenWriteReadBinary((sysFileHandle_t *)ospath, v4);
  Com_PrintError(1, "SV_DemoMP_OpenFile: Failed to create path '%s'\n", ospath);
  return (sysFileHandle_t *)-1i64;
}

/*
==============
SV_DemoMP_OpenFileRead
==============
*/
sysFileHandle_t *SV_DemoMP_OpenFileRead(sysFileHandle_t *result, const char *fileName)
{
  const char *DevHddPath; 
  const char *v4; 
  char ospath[256]; 

  DevHddPath = Sys_GetDevHddPath();
  FS_BuildOSPath(DevHddPath, (const char *)&queryFormat.fmt + 3, (const char *)result, (char (*)[256])ospath);
  if ( !FS_CreatePath(ospath) )
    return FS_FileOpenReadWriteBinary((sysFileHandle_t *)ospath, v4);
  Com_PrintError(1, "SV_DemoMP_OpenFileRead: Failed to create path '%s'\n", ospath);
  return (sysFileHandle_t *)-1i64;
}

/*
==============
SV_DemoMP_PreLoadDemo
==============
*/
void SV_DemoMP_PreLoadDemo(const SvServerInitSettings *initSettings, SaveGame **saveGame)
{
  SaveGame *SaveHandle; 
  const SaveHeader *p_header; 
  MemoryFile *MemoryFile; 
  unsigned int BufferSize; 
  unsigned int v8; 
  MemCardFileHandle *LoadFromDevice; 
  scrContext_t *v10; 
  const char *v11; 
  sysFileHandle_t *handle; 
  SaveHeader *header; 

  if ( !saveGame )
  {
    header = (SaveHeader *)"saveGame";
    if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2988, ASSERT_TYPE_ASSERT, "( saveGame )", (const char *)&queryFormat) )
      __debugbreak();
  }
  if ( !SV_IsDemoPlayingNext() )
  {
    header = (SaveHeader *)&stru_1440E06D8;
    if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2989, ASSERT_TYPE_ASSERT, (const char *)&stru_1440E06D8.time, (const char *)&queryFormat) )
      __debugbreak();
  }
  sv_demo.nextLevelplaying = 0;
  MemCard_PushUseDevDrive(1);
  SaveHandle = G_SaveMemoryMP_GetSaveHandle(SAVE_DEMO_HANDLE);
  *saveGame = SaveHandle;
  p_header = &SaveHandle->header;
  MemoryFile = SaveMemory_GetMemoryFile(SaveHandle);
  MemoryFile->buffer = G_SaveMemoryMP_GetBuffer(SAVE_DEMO_HANDLE);
  BufferSize = G_SaveMemoryMP_GetBufferSize(SAVE_DEMO_HANDLE);
  MemoryFile->bufferSize = BufferSize;
  v8 = truncate_cast<int,unsigned __int64>(BufferSize);
  LoadFromDevice = G_SaveMemoryMP_ReadLoadFromDevice(&s_demoMP_pendingLoadName, NULL, (int)MemoryFile->buffer, (unsigned __int8 *)v8, (int)p_header, header);
  if ( !LoadFromDevice && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 3007, ASSERT_TYPE_ASSERT, (const char *)&stru_1440E06D8.time.tm_isdst, (const char *)&queryFormat, "fileHandle") )
    __debugbreak();
  MemFile_InitForReading(MemoryFile, p_header->bodySize, MemoryFile->buffer, 1, StreamModeSource_MPSaveDemo);
  G_SaveMemory_InitializeLoad(*saveGame);
  Dvar_LoadDvars(MemoryFile);
  v10 = ScriptContext_Server();
  Scr_LoadSource(v10, MemoryFile, (MemCardFileHandle)LoadFromDevice, p_header->hasScriptSource);
  BG_GameStateInfo_LoadState(MemoryFile);
  MemFile_MoveToSegment(MemoryFile, -1, StreamModeSource_MPSaveDemo);
  if ( MemoryFile->memoryOverflow )
    G_SaveError(SAVE_ERROR_CORRUPT_SAVE, &byte_143FC82E0);
  SV_DemoMP_LoadDemo(p_header, MemoryFile, (MemCardFileHandle)LoadFromDevice);
  if ( !sv_demo.save.buf && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 3030, ASSERT_TYPE_ASSERT, "( save->buf )", (const char *)&queryFormat, "save->buf") )
    __debugbreak();
  handle = SV_DemoMP_OpenFileRead(DEMO_MP_CACHE_FILEPATH, v11);
  sv_demo.save.file.handle = (__int64)handle;
  if ( handle == (sysFileHandle_t *)-1i64 )
  {
    G_SaveError(SAVE_ERROR_CORRUPT_SAVE, &stru_1440E06D8.mapName[16]);
    handle = (sysFileHandle_t *)sv_demo.save.file.handle;
  }
  SV_DemoMP_LoadDemoInitState(MemoryFile, (sysFileHandle_t)handle);
  G_MainMP_RegisterGametypeDvars(initSettings->gameType);
  if ( MemoryFile->memoryOverflow )
    G_SaveError(SAVE_ERROR_CORRUPT_SAVE, &byte_143FC82E0);
  CloseDevice((MemCardFileHandle)LoadFromDevice);
  MemCard_PopUseDevDrive();
  sv_demo.nextLevelplaying = 1;
}

/*
==============
SV_DemoMP_Read
==============
*/

bool __fastcall SV_DemoMP_Read(void *buffer, unsigned __int64 len, sysFileHandle_t fileDemo)
{
  return SV_DemoMP_ReadInflate(buffer, len, fileDemo);
}

/*
==============
SV_DemoMP_ReadDemoForClient
==============
*/
__int64 SV_DemoMP_ReadDemoForClient(void *buffer, int len, int localClientNum)
{
  SvDemo *v5; 
  unsigned int v6; 
  unsigned int v7; 
  int v8; 
  __int64 v10; 
  __int64 v11; 
  __int64 v12; 
  unsigned int v13; 

  if ( !BG_GameInterface_GameModeIsMP((GameModeType)(unsigned __int8)SvDemo::ms_allocatedType) && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.h", 173, ASSERT_TYPE_ASSERT, "( BG_GameInterface_GameModeIsMP( ms_allocatedType ) )", (const char *)&queryFormat, "BG_GameInterface_GameModeIsMP( ms_allocatedType )") )
    __debugbreak();
  v5 = SvDemo::ms_gServerDemoSystem;
  v6 = 0;
  v13 = len;
  if ( len <= 0 )
    return (unsigned int)len;
  do
  {
    v7 = HIDWORD(v5[865216].__vftable) & 0x3FFFF;
    v8 = len;
    if ( (int)(0x40000 - v7) < len )
      v8 = 0x40000 - v7;
    while ( LODWORD(v5[865217].__vftable) - HIDWORD(v5[865216].__vftable) < (unsigned int)v8 )
    {
      if ( v6 > 0x3E8 )
      {
        LODWORD(v12) = v8;
        LODWORD(v11) = v5[865217].__vftable;
        LODWORD(v10) = HIDWORD(v5[865216].__vftable);
        if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2063, ASSERT_TYPE_ASSERT, "(waitIterations <= 1000)", "%s\n\tDemoReadClient was stuck in a loop for more than a second, possible deadock. read %i write %i readLen %i", "waitIterations <= 1000", v10, v11, v12) )
          __debugbreak();
      }
      ++v6;
      Sys_Sleep(1);
    }
    memcpy_0(buffer, (char *)&v5[865217].__vftable + v7 + 4, v8);
    len -= v8;
    buffer = (char *)buffer + v8;
    HIDWORD(v5[865216].__vftable) += v8;
  }
  while ( len > 0 );
  return v13;
}

/*
==============
SV_DemoMP_ReadInflate
==============
*/
bool SV_DemoMP_ReadInflate(void *buffer, unsigned __int64 len, sysFileHandle_t fileDemo)
{
  unsigned int v5; 
  int v6; 
  int v7; 
  int v8; 
  __int64 v9; 
  unsigned int v10; 
  __int64 v12; 
  __int64 v13; 
  z_stream_s stream; 
  char ptr[4096]; 

  v5 = len;
  Sys_EnterCriticalSection(CRITSECT_SERVER_DEMO_COMPRESS);
  if ( !BG_GameInterface_GameModeIsMP((GameModeType)(unsigned __int8)SvDemo::ms_allocatedType) && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.h", 173, ASSERT_TYPE_ASSERT, "( BG_GameInterface_GameModeIsMP( ms_allocatedType ) )", (const char *)&queryFormat, "BG_GameInterface_GameModeIsMP( ms_allocatedType )") )
    __debugbreak();
  memset_0(&stream, 0, sizeof(stream));
  j_Zip_InitThreadMemory(&stream, &SvDemo::ms_gServerDemoSystem[816064], 393216);
  v6 = j_inflateInit_(&stream, "1.2.8", 88);
  v7 = v6;
  if ( v6 )
  {
    LODWORD(v12) = v6;
    if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 479, ASSERT_TYPE_ASSERT, "( err ) == ( 0 )", "err == Z_OK\n\t%i, %i", v12, 0i64) )
      __debugbreak();
  }
  stream.avail_out = v5;
  stream.next_out = (unsigned __int8 *)buffer;
  v8 = 0;
  v9 = FS_FileTell(fileDemo);
  do
  {
    v10 = FS_FileRead(ptr, 0x1000ui64, fileDemo);
    stream.avail_in = v10;
    if ( !v10 )
      break;
    stream.next_in = (unsigned __int8 *)ptr;
    v7 = j_inflate_0(&stream, 4);
    if ( v7 == -2 )
    {
      LODWORD(v13) = -2;
      LODWORD(v12) = -2;
      if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 495, ASSERT_TYPE_ASSERT, "( err ) != ( (-2) )", "err != Z_STREAM_ERROR\n\t%i, %i", v12, v13) )
        __debugbreak();
    }
    v8 += v10 - stream.avail_in;
    if ( stream.avail_in )
    {
      if ( v7 == 1 )
        break;
      LODWORD(v13) = v7;
      if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 506, ASSERT_TYPE_ASSERT, "( ( !stream.avail_in || err == 1 ) )", "%s\n\t( err ) = %i", "( !stream.avail_in || err == 1 )", v13) )
        __debugbreak();
    }
  }
  while ( v7 != 1 );
  if ( stream.avail_out )
  {
    LODWORD(v12) = stream.avail_out;
    if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 509, ASSERT_TYPE_ASSERT, "( stream.avail_out ) == ( 0 )", "stream.avail_out == 0\n\t%i, %i", v12, 0i64) )
      __debugbreak();
  }
  if ( v8 > 0 )
    FS_FileSeek(fileDemo, v9 + v8, 2);
  j_inflateEnd_0(&stream);
  j_Zip_ShutdownThreadMemory(&stream);
  Sys_LeaveCriticalSection(CRITSECT_SERVER_DEMO_COMPRESS);
  return v7 == 1;
}

/*
==============
SV_DemoMP_ReadNextDemoType
==============
*/
void SV_DemoMP_ReadNextDemoType()
{
  if ( !sv_demo.playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 916, ASSERT_TYPE_ASSERT, "( sv_demo.playing )", (const char *)&queryFormat, "sv_demo.playing") )
    __debugbreak();
  if ( sv_demo.recording && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 917, ASSERT_TYPE_ASSERT, "( !sv_demo.recording )", (const char *)&queryFormat, "!sv_demo.recording") )
    __debugbreak();
  sv_demo.readType = MSG_ReadByte(&sv_demo.msg);
  switch ( sv_demo.readType )
  {
    case 0xFFFFFFFF:
      Com_Printf(15, "SV Demo MP: End of replay. Received svd_endDemo\n");
      goto $LN15_80;
    case 0:
    case 6:
    case 7:
    case 8:
    case 9:
    case 0xA:
    case 0xC:
$LN15_80:
      sv_demo.nextFramePos = -1;
      break;
    case 1:
    case 3:
    case 4:
    case 5:
      sv_demo.nextFramePos = MSG_ReadLong(&sv_demo.msg);
      break;
    default:
      SV_DemoMP_EndDemoError();
      break;
  }
}

/*
==============
SV_DemoMP_ReadPacket
==============
*/
void SV_DemoMP_ReadPacket(void)
{
  unsigned __int8 *m_ptr; 
  SvPersistentGlobalsMP *PersistentGlobalsMP; 
  int time; 
  SvPersistentGlobalsMP *v3; 
  XSESSION_INFO *DemoSession; 
  const bdSecurityKey *SecurityKey; 
  const bdSecurityID *SecurityId; 
  unsigned int Long; 
  const dvar_t *VarByChecksum; 
  netadr_t v9; 
  __int64 v10; 
  Mem_LargeLocal v11; 
  msg_t buf; 
  netadr_t netId; 
  NetPingInfo v14; 
  XSESSION_INFO hostInfo; 
  XNADDR buffer; 
  char string[1024]; 

  v10 = -2i64;
  if ( SV_IsDemoPlaying() )
  {
    Mem_LargeLocal::Mem_LargeLocal(&v11, 0x243D8ui64, "msg_buf_t msgBuf");
    m_ptr = (unsigned __int8 *)v11.m_ptr;
    PersistentGlobalsMP = SvPersistentGlobalsMP::GetPersistentGlobalsMP();
    time = PersistentGlobalsMP->time;
    if ( time <= 0 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2358, ASSERT_TYPE_ASSERT, "( ( levelTime > 0 ) )", "( levelTime ) = %i", PersistentGlobalsMP->time) )
      __debugbreak();
    if ( time == sv_demo.nextFramePos )
    {
      SV_SnapWorkersMP_WaitSnapshotWorkers();
      while ( 1 )
      {
        if ( !sv_demo.playing && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2369, ASSERT_TYPE_ASSERT, "( sv_demo.playing )", (const char *)&queryFormat, "sv_demo.playing") )
          __debugbreak();
        if ( sv_demo.readType == 1 )
          break;
        switch ( sv_demo.readType )
        {
          case 3:
            MSG_Init(&buf, m_ptr, 148440);
            if ( MSG_ReadByte(&sv_demo.msg) )
            {
              memset(&netId, 0, sizeof(netId));
              MSG_ReadData(&sv_demo.msg, 84, &buffer, 84);
              DemoSession = (XSESSION_INFO *)NET_GetDemoSession();
              SecurityKey = XSESSION_INFO::GetSecurityKey(DemoSession);
              SecurityId = XSESSION_INFO::GetSecurityId(DemoSession);
              XSESSION_INFO::XSESSION_INFO(&hostInfo, SecurityId, SecurityKey, &buffer);
              if ( !NET_OpenConnection(&hostInfo, (const netsrc_t)netId.localNetID, &netId) )
              {
                Com_PrintWarning(15, "SV_DemoMP_ReadPacketEvent: Failed to open connection to packet event address\n");
                memset(&netId, 0, sizeof(netId));
              }
              bdSecurityKey::~bdSecurityKey(&hostInfo.m_security.m_key);
              bdSecurityID::~bdSecurityID(&hostInfo.m_security.m_id);
            }
            else
            {
              MSG_ReadData(&sv_demo.msg, 20, &netId, 20);
            }
            MSG_ReadData(&sv_demo.msg, 24, &v14, 24);
            buf.cursize = MSG_ReadLong(&sv_demo.msg);
            MSG_ReadData(&sv_demo.msg, buf.cursize, buf.data, buf.maxsize);
            SV_DemoMP_ReadNextDemoType();
            v9 = netId;
            SV_MainMP_PacketEventInternal(&v9, &buf, &v14);
            break;
          case 4:
            v3 = SvPersistentGlobalsMP::GetPersistentGlobalsMP();
            v3->loopbackProcessStopTime = MSG_ReadLong(&sv_demo.msg);
            SV_DemoMP_ReadNextDemoType();
            SV_ClientMP_ProcessClientThinks();
            break;
          case 5:
            SV_DemoMP_ReadNextDemoType();
            SV_UserMoveWorkersMP_FinishClientThinkCmds();
            SV_MainMP_ProcessUserMoveOutput(0);
            break;
          default:
            goto LABEL_24;
        }
LABEL_27:
        if ( time != sv_demo.nextFramePos )
          goto LABEL_28;
      }
      Long = MSG_ReadLong(&sv_demo.msg);
      VarByChecksum = Dvar_FindVarByChecksum(Long);
      if ( VarByChecksum && MSG_ReadString(&sv_demo.msg, string, 0x400u) )
      {
        SV_DemoMP_ReadNextDemoType();
        Dvar_SetFromString(VarByChecksum, string);
        goto LABEL_27;
      }
LABEL_24:
      SV_DemoMP_EndDemoError();
      goto LABEL_27;
    }
LABEL_28:
    Mem_LargeLocal::~Mem_LargeLocal(&v11);
  }
}

/*
==============
SV_DemoMP_RecordData
==============
*/
void SV_DemoMP_RecordData(const unsigned __int8 *buf, const int size)
{
  if ( SV_Demo_IsRecording() )
  {
    if ( sv_demo.serverThreadStarted && !Sys_IsServerThread() && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 957, ASSERT_TYPE_ASSERT, "( Sys_IsServerThread() )", (const char *)&queryFormat, "Sys_IsServerThread()") )
      __debugbreak();
    SV_DemoMP_CheckSize();
    if ( s_svdMsgProf[12].start != -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 188, ASSERT_TYPE_ASSERT, "( s_svdMsgProf[type].start == -1 )", (const char *)&queryFormat, "s_svdMsgProf[type].start == -1") )
      __debugbreak();
    s_svdMsgProf[12].start = sv_demo.msg.cursize;
    MSG_WriteByte(&sv_demo.msg, 12i64);
    MSG_WriteLong(&sv_demo.msg, size);
    MSG_WriteData(&sv_demo.msg, buf, size);
    if ( s_svdMsgProf[12].start == -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 195, ASSERT_TYPE_ASSERT, "( s_svdMsgProf[type].start != -1 )", (const char *)&queryFormat, "s_svdMsgProf[type].start != -1") )
      __debugbreak();
    s_svdMsgProf[12].total += sv_demo.msg.cursize - s_svdMsgProf[12].start;
    s_svdMsgProf[12].start = -1;
  }
}

/*
==============
SV_DemoMP_RecordInt64
==============
*/
void SV_DemoMP_RecordInt64(__int64 value)
{
  if ( SV_Demo_IsRecording() )
  {
    if ( sv_demo.serverThreadStarted && !Sys_IsServerThread() && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 957, ASSERT_TYPE_ASSERT, "( Sys_IsServerThread() )", (const char *)&queryFormat, "Sys_IsServerThread()") )
      __debugbreak();
    SV_DemoMP_CheckSize();
    if ( s_svdMsgProf[9].start != -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 188, ASSERT_TYPE_ASSERT, "( s_svdMsgProf[type].start == -1 )", (const char *)&queryFormat, "s_svdMsgProf[type].start == -1") )
      __debugbreak();
    s_svdMsgProf[9].start = sv_demo.msg.cursize;
    MSG_WriteByte(&sv_demo.msg, 9i64);
    MSG_WriteInt64(&sv_demo.msg, value);
    if ( s_svdMsgProf[9].start == -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 195, ASSERT_TYPE_ASSERT, "( s_svdMsgProf[type].start != -1 )", (const char *)&queryFormat, "s_svdMsgProf[type].start != -1") )
      __debugbreak();
    s_svdMsgProf[9].total += sv_demo.msg.cursize - s_svdMsgProf[9].start;
    s_svdMsgProf[9].start = -1;
  }
}

/*
==============
SV_DemoMP_RecordPacketEvent
==============
*/
void SV_DemoMP_RecordPacketEvent(netadr_t *from, msg_t *msg, NetPingInfo *info)
{
  SvPersistentGlobalsMP *PersistentGlobalsMP; 
  int addrHandleIndex; 
  int v8; 
  const void *p_outAddr; 
  NetEndpoint *Endpoint; 
  NetAddress *Address; 
  __int64 v12; 
  XNADDR outAddr; 

  if ( SV_Demo_IsRecording() )
  {
    SV_DemoMP_CheckSize();
    if ( s_svdMsgProf[3].start != -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 188, ASSERT_TYPE_ASSERT, "( s_svdMsgProf[type].start == -1 )", (const char *)&queryFormat, "s_svdMsgProf[type].start == -1") )
      __debugbreak();
    s_svdMsgProf[3].start = sv_demo.msg.cursize;
    MSG_WriteByte(&sv_demo.msg, 3i64);
    PersistentGlobalsMP = SvPersistentGlobalsMP::GetPersistentGlobalsMP();
    MSG_WriteLong(&sv_demo.msg, PersistentGlobalsMP->time);
    addrHandleIndex = from->addrHandleIndex;
    if ( addrHandleIndex == -1 )
    {
      if ( from->type != NA_BROADCAST )
      {
        LODWORD(v12) = from->type;
        if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2419, ASSERT_TYPE_ASSERT, "( from.type ) == ( NA_BROADCAST )", "from.type == NA_BROADCAST\n\t%i, %i", v12, 2) )
          __debugbreak();
      }
      MSG_WriteByte(&sv_demo.msg, 0i64);
      v8 = 20;
      p_outAddr = from;
    }
    else
    {
      Endpoint = NET_GetEndpoint(addrHandleIndex);
      if ( !Endpoint && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2428, ASSERT_TYPE_ASSERT, "( endpoint )", (const char *)&queryFormat, "endpoint") )
        __debugbreak();
      Address = (NetAddress *)NetEndpoint::GetAddress(Endpoint);
      NetAddress::GetXnaddr(Address, &outAddr);
      MSG_WriteByte(&sv_demo.msg, 1i64);
      v8 = 84;
      p_outAddr = &outAddr;
    }
    MSG_WriteData(&sv_demo.msg, p_outAddr, v8);
    MSG_WriteData(&sv_demo.msg, info, 24);
    MSG_WriteLong(&sv_demo.msg, msg->cursize);
    MSG_WriteData(&sv_demo.msg, msg->data, msg->cursize);
    if ( s_svdMsgProf[3].start == -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 195, ASSERT_TYPE_ASSERT, "( s_svdMsgProf[type].start != -1 )", (const char *)&queryFormat, "s_svdMsgProf[type].start != -1") )
      __debugbreak();
    s_svdMsgProf[3].total += sv_demo.msg.cursize - s_svdMsgProf[3].start;
    s_svdMsgProf[3].start = -1;
  }
}

/*
==============
SV_DemoMP_RecordProcessClientThinks
==============
*/
void SV_DemoMP_RecordProcessClientThinks(void)
{
  SvPersistentGlobalsMP *PersistentGlobalsMP; 
  SvPersistentGlobalsMP *v1; 

  if ( SV_Demo_IsRecording() )
  {
    SV_DemoMP_CheckSize();
    if ( s_svdMsgProf[4].start != -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 188, ASSERT_TYPE_ASSERT, "( s_svdMsgProf[type].start == -1 )", (const char *)&queryFormat, "s_svdMsgProf[type].start == -1") )
      __debugbreak();
    s_svdMsgProf[4].start = sv_demo.msg.cursize;
    MSG_WriteByte(&sv_demo.msg, 4i64);
    PersistentGlobalsMP = SvPersistentGlobalsMP::GetPersistentGlobalsMP();
    MSG_WriteLong(&sv_demo.msg, PersistentGlobalsMP->time);
    v1 = SvPersistentGlobalsMP::GetPersistentGlobalsMP();
    MSG_WriteLong(&sv_demo.msg, v1->loopbackProcessStopTime);
    if ( s_svdMsgProf[4].start == -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 195, ASSERT_TYPE_ASSERT, "( s_svdMsgProf[type].start != -1 )", (const char *)&queryFormat, "s_svdMsgProf[type].start != -1") )
      __debugbreak();
    s_svdMsgProf[4].total += sv_demo.msg.cursize - s_svdMsgProf[4].start;
    s_svdMsgProf[4].start = -1;
  }
}

/*
==============
SV_DemoMP_RecordProcessUsermoveOutput
==============
*/
void SV_DemoMP_RecordProcessUsermoveOutput(void)
{
  SvPersistentGlobalsMP *PersistentGlobalsMP; 

  if ( SV_Demo_IsRecording() )
  {
    SV_DemoMP_CheckSize();
    if ( s_svdMsgProf[5].start != -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 188, ASSERT_TYPE_ASSERT, "( s_svdMsgProf[type].start == -1 )", (const char *)&queryFormat, "s_svdMsgProf[type].start == -1") )
      __debugbreak();
    s_svdMsgProf[5].start = sv_demo.msg.cursize;
    MSG_WriteByte(&sv_demo.msg, 5i64);
    PersistentGlobalsMP = SvPersistentGlobalsMP::GetPersistentGlobalsMP();
    MSG_WriteLong(&sv_demo.msg, PersistentGlobalsMP->time);
    if ( s_svdMsgProf[5].start == -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 195, ASSERT_TYPE_ASSERT, "( s_svdMsgProf[type].start != -1 )", (const char *)&queryFormat, "s_svdMsgProf[type].start != -1") )
      __debugbreak();
    s_svdMsgProf[5].total += sv_demo.msg.cursize - s_svdMsgProf[5].start;
    s_svdMsgProf[5].start = -1;
  }
}

/*
==============
SV_DemoMP_Restart
==============
*/
void SV_DemoMP_Restart(bool loadScripts)
{
  if ( !sv_demo.msg.data && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 3250, ASSERT_TYPE_ASSERT, "( sv_demo.msg.data )", (const char *)&queryFormat, "sv_demo.msg.data") )
    __debugbreak();
  Com_SyncThreads();
  SV_Demo_ResetDemo();
  SV_InitMP_ShutdownForDemo();
  sv_demo.nextLevelplaying = 1;
  SV_CmdsMP_RequestMapRestart(loadScripts, 0);
}

/*
==============
SV_DemoMP_Restart_f
==============
*/
void SV_DemoMP_Restart_f(void)
{
  if ( sv_demo.msg.data )
  {
    Dvar_SetBool_Internal(DVARBOOL_replay_time, 1);
    sv_demo.nextLevelSave = NULL;
    sv_demo.nextLevelTime = 0;
    SV_DemoMP_Restart(1);
  }
  else
  {
    Com_PrintError(0, &stru_1440E06D8.description[208]);
  }
}

/*
==============
SV_DemoMP_SaveDemoForClient
==============
*/
void SV_DemoMP_SaveDemoForClient(const int clientNum, const char *name)
{
  const char *v2; 
  bool v4; 
  const char *DevHddPath; 
  signed int v6; 
  signed int v7; 
  SvClient *CommonClient; 
  const char *v9; 
  int v10; 
  SvClient *v11; 
  __int64 v12; 
  char cleanName[64]; 
  char dest[64]; 
  char ospath[256]; 

  v2 = name;
  v4 = SV_DemoMP_CleanName(name, cleanName, 0x40ui64, SAVE_TYPE_CONSOLE);
  DevHddPath = Sys_GetDevHddPath();
  FS_BuildOSPath(DevHddPath, (const char *)&queryFormat.fmt + 3, cleanName, (char (*)[256])ospath);
  v6 = 0;
  v7 = 0;
  if ( (int)SvClient::ms_clientCount > 0 )
  {
    do
    {
      if ( (_BYTE)SvClient::ms_allocatedType != HALF_HALF && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_client_mp.h", 957, ASSERT_TYPE_ASSERT, "( ms_allocatedType == ALLOCATION_TYPE )", (const char *)&queryFormat, "ms_allocatedType == ALLOCATION_TYPE") )
        __debugbreak();
      CommonClient = SvClient::GetCommonClient(v7);
      if ( SvClient::GetCommonClient(v7)->state >= CS_CONNECTED )
      {
        if ( v4 )
        {
          v9 = j_va(&stru_1440E06D8.description[64], (unsigned int)clientNum, ospath);
          NetConnection::SendUnreliable((NetConnection *)&CommonClient[642].lastUsercmd.sightedClientsMask.data[6], v9);
        }
        else
        {
          Com_sprintf(dest, 0x40ui64, "%c \"%s\" 2", 99i64, &stru_1440E06D8.description[88]);
          SV_Game_BroadcastServerCommand(SV_CMD_CAN_IGNORE, dest);
        }
      }
      ++v7;
    }
    while ( v7 < (int)SvClient::ms_clientCount );
    v2 = name;
    v6 = 0;
  }
  if ( v4 )
  {
    v10 = g_serverThreadOwnership;
    if ( !g_serverThreadOwnership )
    {
      if ( ((unsigned __int8)&g_serverThreadOwnership & 3) != 0 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\qcommon\\threads_interlock_pc.h", g_serverThreadOwnership + 37, ASSERT_TYPE_ASSERT, "( ( IsAligned( addend, sizeof( volatile_int32 ) ) ) )", "( addend ) = %p", &g_serverThreadOwnership) )
        __debugbreak();
      if ( _InterlockedIncrement(&g_serverThreadOwnership) != 1 )
      {
        LODWORD(v12) = g_serverThreadOwnership;
        if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 3208, ASSERT_TYPE_ASSERT, "( ( Sys_InterlockedIncrement( (volatile_int32 *)&g_serverThreadOwnership ) == 1 ) )", "( g_serverThreadOwnership ) = %i", v12) )
          __debugbreak();
      }
    }
    SV_DemoMP_SaveToFile(v2, NULL, SAVE_TYPE_CONSOLE);
    if ( !v10 )
    {
      if ( ((unsigned __int8)&g_serverThreadOwnership & 3) != 0 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\qcommon\\threads_interlock_pc.h", 44, ASSERT_TYPE_ASSERT, "( ( IsAligned( addend, sizeof( volatile_int32 ) ) ) )", "( addend ) = %p", &g_serverThreadOwnership) )
        __debugbreak();
      if ( _InterlockedExchangeAdd(&g_serverThreadOwnership, 0xFFFFFFFF) != 1 )
      {
        LODWORD(v12) = g_serverThreadOwnership;
        if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 3215, ASSERT_TYPE_ASSERT, "( ( Sys_InterlockedDecrement( (volatile_int32 *)&g_serverThreadOwnership ) == 0 ) )", "( g_serverThreadOwnership ) = %i", v12) )
          __debugbreak();
      }
    }
    if ( (int)SvClient::ms_clientCount > 0 )
    {
      do
      {
        if ( (_BYTE)SvClient::ms_allocatedType != HALF_HALF && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_client_mp.h", 957, ASSERT_TYPE_ASSERT, "( ms_allocatedType == ALLOCATION_TYPE )", (const char *)&queryFormat, "ms_allocatedType == ALLOCATION_TYPE") )
          __debugbreak();
        v11 = SvClient::GetCommonClient(v6);
        if ( SvClient::GetCommonClient(v6)->state >= CS_CONNECTED )
          NetConnection::SendUnreliable((NetConnection *)&v11[642].lastUsercmd.sightedClientsMask.data[6], &stru_1440E06D8.description[120]);
        ++v6;
      }
      while ( v6 < (int)SvClient::ms_clientCount );
    }
  }
}

/*
==============
SV_DemoMP_SaveHistoryTime
==============
*/
void SV_DemoMP_SaveHistoryTime(server_demo_history_t *history)
{
  int v2; 
  unsigned __int64 v3; 
  __int64 handle; 
  int HistoryIndex; 
  const char *v6; 
  sysFileHandle_t *v7; 
  sysFileHandle_t *v8; 
  sysFileHandle_t *v9; 
  SvDemoMP *DemoMP; 
  int v11; 
  unsigned __int8 *m_workBuffer; 
  int v13; 
  int v14; 
  bool v15; 
  int time; 
  int v17; 
  int v18; 
  int ptr; 

  if ( !history && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1605, ASSERT_TYPE_ASSERT, "( history )", (const char *)&queryFormat, "history") )
    __debugbreak();
  if ( s_demoMP_fileTimeHistory.handle == -1 )
  {
    Com_PrintError(1, "Failed to open demo time history cache file.\n");
    return;
  }
  if ( history->freeEntBufLen < 0 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1587, ASSERT_TYPE_ASSERT, "( history->freeEntBufLen >= 0 )", (const char *)&queryFormat, "history->freeEntBufLen >= 0") )
    __debugbreak();
  v2 = s_demoMP_numFileSkips;
  if ( s_demoMP_numFileSkips == 3600 || (v3 = history->freeEntBufLen + history->save.bufLen + 52944, s_demoMP_writtenFileTimeHistory >= (__int64)(0x7FFFFFFFFFFFFFFFi64 - v3)) )
  {
    Com_PrintWarning(15, "Failed to save demo time history cache file.  Disabling autosave.\n");
    Dvar_SetInt_Internal(DVARINT_replay_autosave, 0);
    return;
  }
  if ( s_demoMP_numFileSkips )
  {
    if ( *((_DWORD *)s_demoMP_fileSkips + 2 * s_demoMP_numFileSkips - 2) >= history->time )
    {
      if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 1622, ASSERT_TYPE_ASSERT, "( s_demoMP_numFileSkips == 0 || s_demoMP_fileSkips[s_demoMP_numFileSkips - 1].time < history->time )", (const char *)&queryFormat, "s_demoMP_numFileSkips == 0 || s_demoMP_fileSkips[s_demoMP_numFileSkips - 1].time < history->time") )
        __debugbreak();
      v2 = s_demoMP_numFileSkips;
    }
    if ( v2 > 0 )
      FS_FileSeek(s_demoMP_fileTimeHistory, *(&s_demoMP_fileSkips[0].time + 2 * v2 - 1), 2);
  }
  handle = s_demoMP_fileTimeHistory.handle;
  FS_FileSeek(s_demoMP_fileTimeHistory, 0i64, 0);
  if ( !SV_DemoMP_WriteDeflate(history, 0xCED0ui64, (sysFileHandle_t)handle) || !SV_DemoMP_WriteDeflate(history->save.buf, history->save.bufLen, (sysFileHandle_t)handle) || !SV_DemoMP_WriteDeflate(history->freeEntBuf, history->freeEntBufLen, (sysFileHandle_t)handle) )
    goto LABEL_25;
  HistoryIndex = SV_DemoMP_GetHistoryIndex(history);
  v7 = (sysFileHandle_t *)DEMO_MP_TIMEHISTORY_CACHE_FILEPATH_2;
  if ( !HistoryIndex )
    v7 = DEMO_MP_TIMEHISTORY_CACHE_FILEPATH_1;
  v8 = SV_DemoMP_OpenFileRead(v7, v6);
  v9 = v8;
  if ( v8 == (sysFileHandle_t *)-1i64 )
  {
    Com_PrintError(1, "SV_DemoMP_WriteHistory: Failed to open history cache file '%s'.\n", (const char *)v7);
LABEL_25:
    Com_PrintError(1, "Failed to save demo history.\n");
    return;
  }
  ptr = FS_FileGetFileSize((sysFileHandle_t)v8);
  if ( !FS_FileWrite(&ptr, 4ui64, (sysFileHandle_t)handle) )
  {
    Com_PrintError(1, "SV_DemoMP_WriteHistory: Could not write %zu bytes to file '%s'.\n", 4ui64, (const char *)v7);
    FS_FileClose(v9);
    goto LABEL_25;
  }
  DemoMP = SvDemoMP::GetDemoMP();
  v11 = ptr;
  if ( ptr )
  {
    m_workBuffer = DemoMP->m_workBuffer;
    do
    {
      if ( v11 > 0x20000 )
        v11 = 0x20000;
      v13 = FS_FileRead(m_workBuffer, v11, (sysFileHandle_t)v9);
      v14 = FS_FileWrite(m_workBuffer, v13, (sysFileHandle_t)handle);
      v15 = ptr == v14;
      v11 = ptr - v14;
      ptr -= v14;
    }
    while ( !v15 );
  }
  FS_FileClose(v9);
  time = history->time;
  s_demoMP_writtenFileTimeHistory += v3;
  *(&s_demoMP_fileSkips[0].time + 2 * s_demoMP_numFileSkips) = time;
  v17 = FS_FileTell(s_demoMP_fileTimeHistory);
  v18 = s_demoMP_numFileSkips;
  *(&s_demoMP_fileSkips[0].time + 2 * s_demoMP_numFileSkips + 1) = v17;
  s_demoMP_numFileSkips = v18 + 1;
}

/*
==============
SV_DemoMP_SaveToFile
==============
*/
void SV_DemoMP_SaveToFile(const char *demoName, const char *description, SaveType saveType)
{
  unsigned __int64 v3; 
  unsigned __int8 *Buffer; 
  unsigned int BufferSize; 
  const char *v8; 
  SaveHeader v9; 

  v3 = (unsigned __int64)&v9 & 0xFFFFFFFFFFFFFF80ui64;
  if ( sv_demo.msg.data )
  {
    if ( sv_demo.save.bufLen )
    {
      if ( SV_DemoMP_CleanName(demoName, (char *)(v3 + 1152), 0x40ui64, saveType) )
      {
        sv_demo.changed = 0;
        memset_0((void *)((unsigned __int64)&v9 & 0xFFFFFFFFFFFFFF80ui64), 0, 0x480ui64);
        Buffer = G_SaveMemoryMP_GetBuffer(SAVE_DEMO_HANDLE);
        BufferSize = G_SaveMemoryMP_GetBufferSize(SAVE_DEMO_HANDLE);
        MemFile_InitForWriting((MemoryFile *)(v3 + 896), BufferSize, Buffer, 0, 1, StreamModeSource_MPInitializeDemoSave);
        MemFile_StartSegment((MemoryFile *)(v3 + 896), -1, StreamModeSource_MPSaveDemo);
        if ( !*(_BYTE *)(((unsigned __int64)&v9 & 0xFFFFFFFFFFFFFF80ui64) + 0x425) )
        {
          if ( !sv_demo.save.bufLen && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2809, ASSERT_TYPE_ASSERT, "( sv_demo.save.bufLen )", (const char *)&queryFormat, "sv_demo.save.bufLen") )
            __debugbreak();
          if ( !sv_demo.save.buf && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2810, ASSERT_TYPE_ASSERT, "( sv_demo.save.buf )", (const char *)&queryFormat, "sv_demo.save.buf") )
            __debugbreak();
          MemFile_CommonInit((MemoryFile *)(v3 + 896), sv_demo.save.bufLen, sv_demo.save.buf, 0, 1);
          G_SaveMemoryMP_CreateHeaderInternal((const char *)(v3 + 1152), description, NULL, 0, 1, saveType, 0, (SaveHeader *)((unsigned __int64)&v9 & 0xFFFFFFFFFFFFFF80ui64), (MemoryFile *)(v3 + 896));
          sv_demo.save.file.handle = (__int64)SV_DemoMP_OpenFileRead(DEMO_MP_CACHE_FILEPATH, v8);
          if ( sv_demo.save.file.handle == -1 )
          {
            Com_PrintError(15, "SV_DemoMP_SaveToFile: Could not open demo cache file\n");
          }
          else
          {
            MemCard_PushUseDevDrive(1);
            SaveMemory_WriteSaveToDeviceInternal((SaveGame *)((unsigned __int64)&v9 & 0xFFFFFFFFFFFFFF80ui64));
            MemCard_PopUseDevDrive();
            FS_FileClose((HANDLE)sv_demo.save.file.handle);
            sv_demo.save.file.handle = -1i64;
          }
        }
      }
    }
    else
    {
      Com_Printf(15, "SV_DemoMP_SaveToFile: Replay start failed to save.\n");
    }
  }
  else
  {
    Com_Printf(15, "SV_DemoMP_SaveToFile: No replay.\n");
  }
}

/*
==============
SV_DemoMP_Save_f
==============
*/
void SV_DemoMP_Save_f(void)
{
  const char *v0; 

  if ( sv_demo.msg.data )
  {
    if ( SV_Cmd_Argc() <= 2 )
    {
      if ( SV_Cmd_Argc() == 2 )
        v0 = SV_Cmd_Argv(1);
      else
        v0 = NULL;
      if ( !BG_GameInterface_GameModeIsMP((GameModeType)(unsigned __int8)SvDemo::ms_allocatedType) && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.h", 173, ASSERT_TYPE_ASSERT, "( BG_GameInterface_GameModeIsMP( ms_allocatedType ) )", (const char *)&queryFormat, "BG_GameInterface_GameModeIsMP( ms_allocatedType )") )
        __debugbreak();
      SV_DemoMP_SaveDemoForClient((const int)SvDemo::ms_gServerDemoSystem[865216].__vftable, v0);
    }
    else
    {
      Com_Printf(0, &stru_1440E06D8.description[184]);
    }
  }
  else
  {
    Com_PrintError(0, &stru_1440E06D8.description[136]);
  }
}

/*
==============
SV_DemoMP_SetMsecTime
==============
*/
void SV_DemoMP_SetMsecTime(int time)
{
  int v1; 
  int v2; 
  scrContext_t *v3; 
  char dest[64]; 

  Com_sprintf(dest, 0x40ui64, "replay_setmsectime %d", (unsigned int)time);
  Sys_EnterCriticalSection(CRITSECT_CBUF);
  v1 = strlen_noncrt(dest);
  v2 = v1;
  if ( s_cmd_textArray[0].cmdsize + v1 < s_cmd_textArray[0].maxsize )
  {
    memcpy_noncrt(&s_cmd_textArray[0].data[s_cmd_textArray[0].cmdsize], dest, v1 + 1);
    s_cmd_textArray[0].cmdsize += v2;
    v3 = ScriptContext_Server();
    Scr_MonitorCommand(v3, dest);
  }
  else
  {
    Com_Printf(16, "Cbuf_AddText: overflow (adding '%s')\n", dest);
  }
  Sys_LeaveCriticalSection(CRITSECT_CBUF);
}

/*
==============
SV_DemoMP_SetMsecTime_f
==============
*/

void __fastcall SV_DemoMP_SetMsecTime_f(double _XMM0_8)
{
  SvGameModeApplication *ActiveServerApplication; 
  const char *v3; 

  if ( !sv_demo.msg.data )
  {
    Com_Printf(0, "SV_DemoMP_SetMsecTime_f: No replay.\n");
    return;
  }
  if ( sv_demo.forwardTime )
  {
    Com_Printf(0, "SV_DemoMP_SetMsecTime: ignored.\n");
    return;
  }
  if ( SV_Cmd_Argc() > 1 )
  {
    v3 = SV_Cmd_Argv(1);
    _XMM0_8 = atof(v3);
    __asm { vcvttsd2si ebx, xmm0 }
    if ( _EBX <= 0 )
    {
      Com_Printf(0, "SV_DemoMP_SetMsecTime_f: Can't use negative numbers or 0.\n");
      return;
    }
  }
  else
  {
    _EBX = 0;
  }
  if ( SvGameModeApplication::HasActiveServerApplication() )
  {
    ActiveServerApplication = SvGameModeApplication::GetActiveServerApplication();
    _EBX -= _EBX % SvGameModeApplication::GetFrameDuration(ActiveServerApplication);
  }
  Dvar_SetBool_Internal(DVARBOOL_replay_time, 1);
  SV_DemoMP_LoadHistoryForTime(_EBX);
  sv_demo.nextLevelSave = s_demoMP_history;
  SV_DemoMP_Restart(0);
  sv_demo.nextLevelTime = _EBX;
}

/*
==============
SV_DemoMP_SetNextLevelTime
==============
*/
void SV_DemoMP_SetNextLevelTime(int time)
{
  sv_demo.nextLevelTime = time;
}

/*
==============
SV_DemoMP_SetPendingLoadName
==============
*/
void SV_DemoMP_SetPendingLoadName(const char *filename)
{
  Dvar_SetBool_Internal(DVARBOOL_replay_time, 1);
  Core_strcpy((char *)&s_demoMP_pendingLoadName, 0x40ui64, filename);
}

/*
==============
SV_DemoMP_ShouldAutoSave
==============
*/
bool SV_DemoMP_ShouldAutoSave(const AutoSaveType autosaveType, const bool force)
{
  const dvar_t *v2; 
  const dvar_t *v5; 

  v2 = DVARBOOL_replay_autosave_mp;
  if ( !DVARBOOL_replay_autosave_mp && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\universal\\dvar.h", 692, ASSERT_TYPE_ASSERT, "(dvar)", "%s\n\tDvar %s accessed after deregistration", "dvar", "replay_autosave_mp") )
    __debugbreak();
  Dvar_CheckFrontendServerThread(v2);
  if ( !v2->current.enabled )
    return 0;
  if ( autosaveType != (COUNT|DODGE) )
  {
    v5 = DVARBOOL_replay_autosaveOnError;
    if ( !DVARBOOL_replay_autosaveOnError && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\universal\\dvar.h", 692, ASSERT_TYPE_ASSERT, "(dvar)", "%s\n\tDvar %s accessed after deregistration", "dvar", "replay_autosaveOnError") )
      __debugbreak();
    Dvar_CheckFrontendServerThread(v5);
    if ( !v5->current.enabled )
      return 0;
  }
  return (Sys_IsMainThread() || Sys_IsServerThread()) && (!Sys_IsMainThread() || !force) && SvDemo::ms_gServerDemoSystem && SvStaticGlobals::ms_svStaticGlobals.state == SS_GAME && sv_demo.msg.data && (force || sv_demo.changed);
}

/*
==============
SV_DemoMP_ShutdownSystem
==============
*/
void SV_DemoMP_ShutdownSystem(void)
{
  if ( s_demoMP_fileTimeHistory.handle != -1 )
  {
    SV_Demo_WaitForSaveHistoryDone();
    FS_FileClose((HANDLE)s_demoMP_fileTimeHistory.handle);
    s_demoMP_fileTimeHistory.handle = -1i64;
  }
}

/*
==============
SV_DemoMP_StartServerFinalize
==============
*/
void SV_DemoMP_StartServerFinalize(void)
{
  SvDemoMP *DemoMP; 

  if ( !Sys_IsMainThread() && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2720, ASSERT_TYPE_ASSERT, "(Sys_IsMainThread())", (const char *)&queryFormat, "Sys_IsMainThread()") )
    __debugbreak();
  if ( SV_IsDemoPlaying() )
  {
    DemoMP = SvDemoMP::GetDemoMP();
    CL_DemoServerPlayback_SvInitClientPlayback((int (__fastcall *)(void *, int, int))SV_DemoMP_ReadDemoForClient, DemoMP->m_clientPlaybackBuf, 0x10000u);
  }
}

/*
==============
SV_DemoMP_StopClientReplay
==============
*/
void SV_DemoMP_StopClientReplay(void)
{
  SvDemoMP *DemoMP; 
  signed int m_clientNum; 
  SvClientMP *MpClient; 

  if ( SV_IsDemoPlaying() )
  {
    DemoMP = SvDemoMP::GetDemoMP();
    m_clientNum = DemoMP->m_clientNum;
    if ( m_clientNum >= 0 && m_clientNum < (int)SvClient::ms_clientCount )
    {
      MpClient = SV_Client_GetMpClient(m_clientNum);
      MpClient->demorecording = 0;
      MpClient->demowrite = NULL;
    }
    DemoMP->m_clientNum = -1;
  }
}

/*
==============
SV_DemoMP_UpdateDemo
==============
*/
void SV_DemoMP_UpdateDemo(void)
{
  int v0; 

  if ( SV_Demo_IsRecording() && !sv_demo.msg.overflowed )
    sv_demo.endTime = G_Main_GetTime();
  if ( g_serverThreadOwnership != 1 )
  {
    v0 = g_serverThreadOwnership;
    if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 3660, ASSERT_TYPE_ASSERT, "( ( g_serverThreadOwnership == 1 ) )", "( g_serverThreadOwnership ) = %i", v0) )
      __debugbreak();
  }
}

/*
==============
SV_DemoMP_UpdateReplayClient
==============
*/
void SV_DemoMP_UpdateReplayClient(void)
{
  SvDemoMP *DemoMP; 
  const dvar_t *v1; 
  SvDemoMP *v2; 
  signed int integer; 
  signed int m_clientNum; 
  SvClientMP *MpClient; 
  SvClientMP *v6; 

  if ( SV_IsDemoPlaying() )
  {
    DemoMP = SvDemoMP::GetDemoMP();
    v1 = DVARINT_replay_client;
    v2 = DemoMP;
    if ( !DVARINT_replay_client && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\universal\\dvar.h", 699, ASSERT_TYPE_ASSERT, "(dvar)", "%s\n\tDvar %s accessed after deregistration", "dvar", "replay_client") )
      __debugbreak();
    Dvar_CheckFrontendServerThread(v1);
    integer = v1->current.integer;
    if ( v2->m_clientNum != integer )
    {
      SV_SnapWorkersMP_WaitSnapshotWorkers();
      m_clientNum = v2->m_clientNum;
      if ( m_clientNum >= 0 && m_clientNum < (int)SvClient::ms_clientCount )
      {
        MpClient = SV_Client_GetMpClient(m_clientNum);
        MpClient->demorecording = 0;
        MpClient->demowrite = NULL;
      }
      SV_DemoMP_ClearBaseline();
    }
    v2->m_clientNum = integer;
    if ( integer < (int)SvClient::ms_clientCount )
    {
      v6 = SV_Client_GetMpClient(integer);
      if ( v6->state >= CS_ACTIVE )
      {
        if ( !v6->demorecording )
        {
          SV_SnapWorkersMP_WaitSnapshotWorkers();
          SV_DemoMP_InitClientForReplay(v2->m_clientNum);
        }
      }
      else
      {
        Dvar_SetInt_Internal(DVARINT_replay_client, v2->m_hostNum);
      }
    }
  }
}

/*
==============
SV_DemoMP_UsingDemoHistory
==============
*/
bool SV_DemoMP_UsingDemoHistory()
{
  return sv_demo.nextLevelSave != NULL;
}

/*
==============
SV_DemoMP_Write
==============
*/

bool __fastcall SV_DemoMP_Write(const void *buffer, unsigned __int64 len, sysFileHandle_t fileDemo)
{
  return SV_DemoMP_WriteDeflate(buffer, len, fileDemo);
}

/*
==============
SV_DemoMP_WriteDeflate
==============
*/
__int64 SV_DemoMP_WriteDeflate(const void *buffer, unsigned __int64 len, sysFileHandle_t fileDemo)
{
  unsigned int v5; 
  int v6; 
  unsigned __int8 v7; 
  int v8; 
  unsigned __int64 v9; 
  __int64 v11; 
  __int64 v12; 
  z_stream_s stream; 
  char ptr[4096]; 

  v5 = len;
  Sys_EnterCriticalSection(CRITSECT_SERVER_DEMO_COMPRESS);
  if ( !BG_GameInterface_GameModeIsMP((GameModeType)(unsigned __int8)SvDemo::ms_allocatedType) && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.h", 173, ASSERT_TYPE_ASSERT, "( BG_GameInterface_GameModeIsMP( ms_allocatedType ) )", (const char *)&queryFormat, "BG_GameInterface_GameModeIsMP( ms_allocatedType )") )
    __debugbreak();
  memset_0(&stream, 0, sizeof(stream));
  j_Zip_InitThreadMemory(&stream, &SvDemo::ms_gServerDemoSystem[816064], 393216);
  v6 = j_deflateInit_(&stream, 1, "1.2.8", 88);
  if ( v6 )
  {
    LODWORD(v11) = v6;
    if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 422, ASSERT_TYPE_ASSERT, "( err ) == ( 0 )", "err == Z_OK\n\t%i, %i", v11, 0i64) )
      __debugbreak();
  }
  stream.next_in = (unsigned __int8 *)buffer;
  stream.avail_in = v5;
  v7 = 1;
  while ( 1 )
  {
    stream.avail_out = 4096;
    stream.next_out = (unsigned __int8 *)ptr;
    v8 = j_deflate(&stream, 4);
    if ( v8 == -2 )
    {
      LODWORD(v12) = -2;
      LODWORD(v11) = -2;
      if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 437, ASSERT_TYPE_ASSERT, "( err ) != ( (-2) )", "err != Z_STREAM_ERROR\n\t%i, %i", v11, v12) )
        __debugbreak();
    }
    v9 = 4096 - stream.avail_out;
    if ( v9 != FS_FileWrite(ptr, v9, fileDemo) )
      break;
    if ( stream.avail_out )
      goto LABEL_15;
  }
  v7 = 0;
LABEL_15:
  if ( v8 != 1 )
  {
    LODWORD(v12) = 1;
    LODWORD(v11) = v8;
    if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 448, ASSERT_TYPE_ASSERT, "( err ) == ( 1 )", "err == Z_STREAM_END\n\t%i, %i", v11, v12) )
      __debugbreak();
  }
  if ( stream.avail_in )
  {
    LODWORD(v11) = stream.avail_in;
    if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 449, ASSERT_TYPE_ASSERT, "( stream.avail_in ) == ( 0 )", "stream.avail_in == 0\n\t%i, %i", v11, 0i64) )
      __debugbreak();
  }
  j_deflateEnd(&stream);
  j_Zip_ShutdownThreadMemory(&stream);
  Sys_LeaveCriticalSection(CRITSECT_SERVER_DEMO_COMPRESS);
  return v7;
}

/*
==============
SV_DemoMP_WriteToClient
==============
*/
void SV_DemoMP_WriteToClient(const void *buffer, int len, int clientNum)
{
  SvDemo *v5; 
  unsigned int i; 
  unsigned int v7; 
  int v8; 
  __int64 v9; 
  __int64 v10; 
  __int64 v11; 

  if ( !BG_GameInterface_GameModeIsMP((GameModeType)(unsigned __int8)SvDemo::ms_allocatedType) && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.h", 173, ASSERT_TYPE_ASSERT, "( BG_GameInterface_GameModeIsMP( ms_allocatedType ) )", (const char *)&queryFormat, "BG_GameInterface_GameModeIsMP( ms_allocatedType )") )
    __debugbreak();
  v5 = SvDemo::ms_gServerDemoSystem;
  for ( i = 0; len > 0; LODWORD(v5[865217].__vftable) += v8 )
  {
    v7 = (__int64)v5[865217].__vftable & 0x3FFFF;
    v8 = len;
    if ( (int)(0x40000 - v7) < len )
      v8 = 0x40000 - v7;
    while ( LODWORD(v5[865217].__vftable) - HIDWORD(v5[865216].__vftable) > (unsigned int)(0x40000 - v8) )
    {
      if ( i > 0x3E8 )
      {
        LODWORD(v11) = v8;
        LODWORD(v10) = HIDWORD(v5[865216].__vftable);
        LODWORD(v9) = v5[865217].__vftable;
        if ( CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2095, ASSERT_TYPE_ASSERT, "(waitIterations <= 1000)", "%s\n\tDemoWriteClient was stuck in a loop for more than a second, possible deadock. write %i read %i writeLen %i", "waitIterations <= 1000", v9, v10, v11) )
          __debugbreak();
      }
      ++i;
      Sys_Sleep(1);
    }
    memcpy_0((char *)&v5[865217].__vftable + v7 + 4, buffer, v8);
    len -= v8;
    buffer = (char *)buffer + v8;
  }
}

/*
==============
SvDemoMP::SaveHistory
==============
*/
void SvDemoMP::SaveHistory(SvDemoMP *this)
{
  if ( !s_demoMP_historySaving && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 3880, ASSERT_TYPE_ASSERT, "( s_demoMP_historySaving != nullptr )", (const char *)&queryFormat, "s_demoMP_historySaving != nullptr") )
    __debugbreak();
  SV_DemoMP_SaveHistoryTime(s_demoMP_historySaving);
  SV_DemoMP_FreeHistoryData(s_demoMP_historySaving);
  s_demoMP_historySaving = NULL;
  Sys_SetSaveHistoryDoneEvent();
}

/*
==============
SvDemoMP::SaveImmediate
==============
*/
void SvDemoMP::SaveImmediate(SvDemoMP *this, SaveImmediate *save)
{
  __int64 handle; 
  unsigned int v4; 
  __int64 FileSize; 
  int buffer; 

  if ( !sv_demo.msg.data && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2734, ASSERT_TYPE_ASSERT, "( sv_demo.msg.data )", (const char *)&queryFormat, "sv_demo.msg.data") )
    __debugbreak();
  if ( !save && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2735, ASSERT_TYPE_ASSERT, "( save )", (const char *)&queryFormat, "save") )
    __debugbreak();
  if ( !save->buf && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2737, ASSERT_TYPE_ASSERT, "( save->buf != nullptr )", (const char *)&queryFormat, "save->buf != nullptr") )
    __debugbreak();
  handle = save->f.handle;
  save->bufOffset = 0;
  v4 = MemCard_FilePosition((MemCardFileHandle)handle);
  Com_Printf(15, "Save:%i\n", v4);
  SaveMemory_SaveWriteImmediate(&sv_demo, 4, save);
  SaveMemory_SaveWriteImmediate(&sv_demo.endTime, 4, save);
  SaveMemory_SaveWriteImmediate(&sv_demo.msg.cursize, 4, save);
  SaveMemory_SaveWriteImmediate(sv_demo.msg.data, sv_demo.msg.cursize, save);
  if ( sv_demo.save.file.handle == -1 && CoreAssert_Handler("c:\\workspace\\iw8\\code_source\\src\\server_mp\\sv_demo_mp.cpp", 2750, ASSERT_TYPE_ASSERT, "( sv_demo.save.file != INVALID_SYS_FILE_HANDLE )", (const char *)&queryFormat, "sv_demo.save.file != INVALID_SYS_FILE_HANDLE") )
    __debugbreak();
  FileSize = FS_FileGetFileSize(sv_demo.save.file);
  buffer = truncate_cast<int,__int64>(FileSize);
  SaveMemory_SaveWriteImmediate(&buffer, 4, save);
  SaveMemory_SaveWriteFileImmediate(sv_demo.save.file, buffer, save);
  SaveMemory_SaveWriteImmediateBufFlush(save);
}

